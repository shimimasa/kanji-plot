漢字読みバトル 企画書 (最終版 Ver.2.2)
1. 企画概要・コンセプト
RPG要素と科学的復習システムで、学びが”続く”漢字冒険譚

本ゲームは、漢字の読み問題を解いて日本全国や世界のモンスターと戦う、RPG要素とコレクション要素を融合させた学習ゲームです。プレイヤーは敵を倒して経験値を獲得し、レベルアップで自身を強化。集めた漢字やモンスターで「図鑑」を完成させながら、まだ見ぬ強敵や新しい漢字との出会いを求めて冒険を進めます。

最大の特徴は、単なる暗記で終わらせないための豊富なやりこみ要素と、学習科学に基づいた復習システムです。RPGとしての成長体験、図鑑を埋めるコレクションの楽しみ、そして多彩な「実績」がプレイヤーの継続的な学習意欲を強力にサポートします。さらに、間違えた問題を最適なタイミングで出題する「SM-2アルゴリズム」を採用した復習機能により、効率的かつ確実に知識の定着を図ります。

2. ターゲットユーザー
主なターゲット: 小学校全学年の児童および中学生。特に、漢字の読み書きに苦手意識を持つ学習者や、ゲームを通じて楽しく学習したいと考える層。
サブターゲット:
ADHD傾向など、注意が散漫になりやすい特性を持つ子どもでも直感的に操作できるUI/UXを目指します。
将来的には学習塾のサブ教材としての利用も想定しています。
3. ゲームの主な特徴
選べる学習コース: ゲーム開始時から、小学生で習う漢字を扱う「日本編」と、中学生で習う漢字を扱う「世界編」の2つのコースを自由に選択してプレイできます。
2つのゲームモード: 自分のペースで進める「じっくりモード」と、時間制限とスコアアタックが楽しめる「チャレンジモード」を搭載しています。
戦略的なバトルシステム:
各モンスターには「音読み」「訓読み」いずれかの弱点属性が設定されており、弱点を突くことでダメージが1.5倍になります。
ボスモンスターはシールドを持ち、弱点属性での攻撃でなければダメージを与えられません。
RPGとしての成長要素:
敵を倒して経験値を獲得し、レベルアップするとステータスが上昇します。
レベルアップで得られるスキルポイントを使い、「HP」や「攻撃力」を任意に強化できます。
科学的根拠に基づく復習システム:
バトルで間違えた漢字は自動で復習リストに追加されます。
忘却曲線理論に基づく「SM-2アルゴリズム」により、最適なタイミングで問題が再出題され、効率的な知識の定着を促します。
豊富なやりこみ要素:
漢字図鑑・モンスター図鑑: 学習した漢字や倒したモンスターが図鑑に登録され、コレクションする楽しみがあります。
実績システム: 「モンスターを10体倒した」「関東地方をクリアした」など、様々な条件を達成することで実績を解除できます。
クラウド同期とアクセシビリティ:
Firebaseを利用し、セーブデータは自動でクラウドに保存・同期されます。
アクセシビリティ設定として、色弱モードや文字サイズ変更機能を搭載し、より多くのユーザーが快適にプレイできる環境を提供します。
4. ゲームフロー
タイトル画面からプレイヤー名入力（初回のみ）を経て、学習コース選択画面へ進みます。ここで「日本地図（小学生）」か「世界地図（中学生）」かを選び、それぞれの地方・大陸選択を経て、冒険を開始します。

5. 今後の展望
5.1. 既存の改善計画
ボス戦ギミックの深化: フェーズ制バトルや特殊攻撃など、より戦略的なボス戦を導入。
問題形式の多様化: 「書き取り（選択式）」や「部首当て」など、新しい問題形式を追加。
PWA対応の強化: プッシュ通知による復習リマインダー機能などを実装。
ソーシャル機能: フレンド機能やランキング機能の導入。
5.2. 中学生ステージ拡張計画：世界への挑戦
舞台: 冒険の舞台は日本を飛び出し、世界地図へと広がります。
モンスター: 各国・各地域の特産品や文化をモチーフにした、ユニークな「世界の名産モンスター」が登場します。
学習内容: 中学生で習う常用漢字 約1,110字 を、漢検の級（4級、3級、準2級、2級）に応じた難易度で段階的に学習します。
漢字読みバトル 仕様書 (最終版 Ver.2.2)
1. はじめに
本仕様書は、「漢字読みバトル」の機能、データ構造、技術要件を定義するものです。ご提供いただいた全ソースコードとデータファイルに基づき、最新の仕様を記述します。

2. 全体構成
2.1. アーキテクチャ
状態管理: 有限状態マシン（FSM）により、アプリケーション全体の画面遷移を一元管理しています。
モジュール連携: Pub/Subパターンのイベントバス（eventBus.js）を介して、各機能モジュールが疎結合に連携します。
2.2. 画面遷移図
タイトル画面の後に「学習コース選択画面」を設け、ここを起点に「小学生編」と「中学生編」のフローに分岐します。

コード スニペット

graph TD
    subgraph " "
        A(Title Screen) --> B[学習コース選択画面<br>(courseSelectScreen)];
    end

    subgraph 小学生編
        B -- 「日本編」を選択 --> C[地方選択画面<br>(regionSelectScreen)];
        C --> E[小学生ステージ選択<br>(stageSelectScreen)];
        E --> G{日本ステージバトル};
    end
    
    subgraph 中学生編
        B -- 「世界編」を選択 --> D[大陸選択画面<br>(continentSelectScreen)];
        D --> F[中学生ステージ選択<br>(worldStageSelectScreen)];
        F --> H{世界ステージバトル};
    end
3. 機能仕様
3.1. 画面別仕様
タイトル画面 (titleScreen.js):
ゲームモード（「じっくり」または「チャレンジ」）を選択します。
既存プレイヤーには「つづきから」、新規プレイヤーには「〜ではじめる」と表示を切り替えます。
設定画面へ遷移するボタンがあります。
地方選択画面 (regionSelectScreen.js):
Canvas上に日本地図と地方マーカーを描画します。
各地方の達成率と、次に挑戦すべき地方の「NEXT」インジケーターを表示します。
マーカーをホバーするとツールチップが表示され、地方の境界線がハイライトされます。
マーカーをクリックすると、ズームイン演出の後、ステージ選択画面へ遷移します。
ステージ選択画面 (stageSelectScreen.js):
画面上部のタブで学年を切り替え、タブにはクリア率が表示されます。
背景画像は学年タブ切り替え時にクロスフェードします。
「総復習モード」では、未クリアステージや復習キューを元に推奨ステージへの挑戦ボタンが表示されます。
バトル画面 (battleScreen.js):
画面中央に問題の漢字、上部に敵、下部にプレイヤー情報とアクションボタン、メッセージログが表示されます。
敵の弱点属性がアイコンで表示され、コンボ数、HP・経験値のアニメーション、画面フラッシュ、レベルアップなど多彩な演出が実装されています。
メッセージログはタイプライター風に表示され、マウスホイールでスクロール可能です。
図鑑画面 (kanjiDexScreen.js, monsterDexScreen.js):
CanvasではなくDOM（HTML要素）でUIが構築されます。
漢字図鑑: 収集率、ソート機能（学年、画数、習熟度）、フィルター（収集済のみ）を備えています。詳細モーダルでは学習記録（正答率グラフなど）も確認できます。
モンスター図鑑: 収集率、地方フィルター、ソート機能（図鑑番号、五十音順）を備えています。画像はIntersectionObserverで遅延読み込みされます。
設定画面 (settingsScreen.js):
UIはDOMで構築されます。
BGM/SEの音量調整スライダー、アクセシビリティ設定（色弱モード、フォントサイズ変更のトグルスイッチ）、ツールチップ付きのデータリセットボタンが配置されています。
3.2. コア機能仕様
バトルロジック:
ダメージ計算: 基本ダメージはプレイヤーのattack値を基に算出されます。敵の弱点属性（weakness）と解答の読みの種類（音読み/訓読み）が一致した場合、ダメージは1.5倍になります。
ボス戦: ボスモンスター（isBoss: true）はシールド（shieldHp）を持ち、シールドがある間は弱点攻撃でしかダメージを与えられません。
コンボ: 5連続正解でダメージ1.5倍のボーナスが発生します。
経験値とレベルアップ:
敵を倒すと経験値（exp）を獲得します。
経験値がnextLevelExpに達するとレベルアップし、HP全回復、最大HP+10、攻撃力+2、スキルポイント+1のボーナスがあります。
次レベルに必要な経験値は Math.floor(nextLevelExp * 1.2) + 20 の計算式で増加します。
復習システム:
バトルで間違えた問題はreviewQueue.jsに登録されます。
SM-2アルゴリズムに基づき、解答の質（quality）に応じて次回復習日（nextReviewAt）が計算されます。
実績システム:
achievementManager.jsがゲーム内の各種カウンター（倒した敵の数など）を監視し、achievements.jsonに定義された条件を満たすと実績が解除されます。
4. データ仕様
4.1. データファイル (JSON)
kanji_gX_proto.json: 学年別の漢字データ。
id, stageId, kanji, grade, strokes, onyomi, kunyomi, weakness, meaning, correctCount, incorrectCount
enemies_proto.json: 敵キャラクターのデータ。
id, name, prefecture, level, maxHp, atk, image, isBoss, shieldHp, exp, weakness
stages_proto.json: ステージ構成データ。
grade, region, pref, pos, stageId, name, enemyIdList, kanjiPoolIdList, recommendedLevel
achievements.json: 実績の定義データ。
id, title, description, condition: {type, value}
4.2. データ永続化
ローカルストレージ:
kanjiGameSave: プレイヤーの基本ステータスと解除済み実績。
krb_kanji_dex: 収集済み漢字IDのSet。
krb_monster_dex: 捕獲済みモンスターIDのSet。
krb_seen_monsters: 確認済みモンスターIDのSet。
krb_review_queue: 復習キューのデータ。
bgmVolume, seVolume, cbMode, bigFont: 各種設定。
Firebase Firestore:
匿名認証でユーザーを識別し、以下の構造でデータを保存・同期します。
users/{uid}/profile/playerStats: プレイヤーのレベルや経験値などの基本データ。
users/{uid}/progress/{stageId}: ステージごとのクリア状況。
users/{uid}/progress/state: 図鑑や復習キューなど、localStorageの主要データを同期するためのドキュメント。
5. 【拡張仕様】中学生ステージ（世界編）
5.1. ゲームフロー
タイトル画面後に新設する「学習コース選択画面」から、小学生向け「日本編」または中学生向け「世界編」を自由に選択します。

日本編フロー: 学習コース選択 → 地方選択 → 小学生ステージ選択 → バトル
世界編フロー: 学習コース選択 → 大陸選択 → 中学生ステージ選択 → バトル
5.2. 新規画面仕様
courseSelectScreen.js (学習コース選択画面) [新規作成]

役割: 小学生/中学生コースの分岐点となるハブ画面。
UI: 画面に「日本地図と『小学生編』ラベル」および「世界地図と『中学生編』ラベル」を持つ大きなボタンを2つ配置。
動作: ボタンクリックで、それぞれの地方選択画面（regionSelectScreen）または大陸選択画面（continentSelectScreen）に遷移します。
continentSelectScreen.js (大陸選択画面) [新規作成]

役割: 中学生編の、挑戦する大陸（漢検の級に対応）を選択する画面。
UI: 世界地図上に、アジア、ヨーロッパ等の大陸マーカーを配置。マーカーには対応する漢検の級や達成率を表示。
動作: マーカークリックで、その大陸の国々が選択できるworldStageSelectScreenに遷移します。
worldStageSelectScreen.js (中学生ステージ選択画面) [新規作成]

役割: 選択された大陸の中から、挑戦する国・地域（ステージ）を選択する画面。
UI: 画面上部に「4級」「3級」などの漢検級別タブを配置。左側にステージリスト、右側に大陸地図とステージマーカーを表示。
動作: タブとリストからステージを選択し、バトルを開始します。
5.3. データ構造の拡張
漢字データ (kanji_jh_kX_proto.json):
漢検の級ごとにJSONファイルを新規作成し、kanken_levelフィールドを追加します。
ステージデータ (stages_proto.json):
grade: "J"とkanken_levelフィールドを追加し、中学生ステージを定義します。regionには大陸名、prefには国・地域名を格納します。
モンスターデータ (enemies_proto.json):
世界観に合わせたモンスターデータを追加します。

5.4. ステージ構成計画
1ステージあたり約30字の漢字を割り当てることで、学習ペースの均一化を図ります。

漢検級	対象漢字数	推奨ステージ数	舞台となる大陸（例）
4級	313字 ``	10～11 ステージ	アジア、オセアニア
3級	285字 ``	9～10 ステージ	ヨーロッパ、中東
準2級	320字 ``	10～11 ステージ	北米、中南米
2級	196字 ``	6～7 ステージ	アフリカ、世界連合

Google スプレッドシートにエクスポート
各ステージには、既存の小学生編と同様に10体程度のユニークな「世界の名産モンスター」を配置します ``。
2級ステージは、アフリカ大陸の6ステージと、最終ボスステージとして「世界連合」を1ステージ設ける構成とします。

6. 技術要件
使用技術スタック: JavaScript (ES Modules), Canvas API, HTML, CSS, Firebase SDK, Vite。
パフォーマンス: モンスター図鑑のサムネイル画像は、IntersectionObserverを用いて遅延読み込みを実装し、初期表示速度を向上させています。
アクセシビリティ: 設定画面にて色弱モード、文字サイズ変更機能を提供します。キーボード操作のみでの進行も想定されています。