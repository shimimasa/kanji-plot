### 【Gemini生成】漢字読みバトル 仕様書 (コード解析反映版)


## 1. はじめに（目的／背景／ターゲット）

### 1.1 目的
- 小学生が漢字の読み（音読み・訓読み）をゲーム感覚で楽しく学習し、定着させることを目的とする。
- バトル要素を取り入れることで、学習意欲を継続的に維持し、復習機能を通じて知識の定着を促す。

### 1.2 背景
- 現代の小学生はデジタルコンテンツに慣れており、従来のドリル式だけでは学習モチベーションを維持しづらい。
- 地方ごとの名産品をモチーフにしたモンスターを登場させることで、地域学習との掛け合わせや興味喚起を図る。
- スペースドリピティションの仕組みを将来的に導入し、学習効率を向上させることを念頭に置いた設計。

### 1.3 ターゲット
- 小学校低学年〜中学年で、漢字読みの習得に苦手意識を持つ児童。
- ADHD傾向がある子どもでも直感的に操作できる UI を重視。
- 学習塾のサブ教材として、指導者（先生）がクラス単位で利用できる想定。

### 1.4 プラットフォーム・動作環境
- **Webブラウザ対応**（PC／タブレット）  
  - Canvas API を用いた自前描画。  
  - HTML5 の `<input>` 要素をオーバーレイで利用。  
- **PWA化対応予定**（オフラインキャッシュ、ホーム画面アイコン追加）  
- **必要環境**  
  - Google Chrome, Firefox, Safari など主要ブラウザ最新バージョン  
  - インターネット接続：Firebase 同期時のみ必須。オフラインモード時はキャッシュから読み込み。  
- **オフラインデータ同期とエラーハンドリング**  
  - オフライン時に進行したデータ（ステージクリア状況、獲得経験値、図鑑更新、プレイヤーステータス等）は `localStorage` と Firestore Persistence にキャッシュされる。  
  - オンライン復帰後、`DataSync.syncAll()` がローカル変更とサーバー上のデータをマージ:  
    - **マージ方針**: 最終更新タイムスタンプを比較し、より新しいデータを優先して採用。  
    - **衝突時**: タイムスタンプ優先で自動解決し、重大な不整合が疑われる場合はユーザーに確認ダイアログを表示。  
  - **通信エラー時**:  
    - 読み書き失敗時に画面上部にエラーメッセージを表示し、「再試行」ボタンを提供。  
    - 同期失敗が継続する場合はバナーで警告し、オフラインモードでの継続利用を許可。  
### 2. 全体構成図（画面マップ、State遷移図）

#### 2.1 画面マップ

【コードから更新】`regionSelectScreen.js`の追加を反映します。

```
[タイトル画面]
    ├─ (プレイヤー名未設定時) → [プレイヤー名入力画面]
    └─ (設定済み) → [メインメニュー画面] or [地方選択画面]
                                      │
                                      └─> [ステージ選択画面]
```

#### 2.2 State 遷移図

【コードから更新】`fsmsetup.js`の定義に基づき、State遷移図を現在の実装に合わせます。

```
[Loading]
    │ (アセット・データ読み込み完了)
    ▼
[Title]
    │ (モード選択)
    ▼
[RegionSelect] or [Settings]
    │
    └─> [StageSelect]
        │
        ├─> [Battle]
        ├─> [KanjiDex]
        ├─> [MonsterDex]
        └─> [ReviewStage]
```

_補足: `menuScreen.js`は存在しますが、現在の`titleScreen.js`のフローからは直接呼び出されておらず、`statusScreen`や`achievementsScreen`へのハブとして機能する想定です。_

### 3. 詳細機能仕様

#### 3.2 ステージ選択・進行ロジック

【コードから更新】`regionSelectScreen.js`の実装に伴い、ステージ選択のフローが「地方選択」→「都道府県選択」の2段階になっています。

1. **地方選択**: `regionSelectScreen`で学年ごとの地方を選択する。
2. **都道府県選択**: `stageSelectScreen`で、選択した地方に属するステージ（都道府県）をリストまたはマップから選択する。

#### 3.3 属性・レベルアップ計算式

##### 3.3.2 経験値・レベルアップ計算式

【コードから更新】`gameState.js`の実装に基づき、現在のロジックを反映します。

- **経験値加算**: 敵を倒すと`addPlayerExp(exp)`が呼ばれ、`gameState.playerStats.exp`に経験値が加算される。
- **レベルアップ判定**: `checkLevelUp()`関数により、`playerStats.exp >= playerStats.nextLevelExp`の場合にレベルアップする。
- **レベルアップ時の処理**:
    - `playerLevel += 1;`
    - `playerExp -= nextLevelExp;`
    - `nextLevelExp += 15;` （**実装メモ**: 当初の仕様書では指数関数的増加だったが、現在は線形増加で実装されている）
    - `maxHp += 5;`
    - `hp = maxHp;` （HP全回復）
    - **【新規】`skillPoints += 1;`** （スキルポイントを1獲得）
- **永続化**: レベルアップ後、`saveGameData()`が呼ばれ、最新のプレイヤー情報が`localStorage`に保存される。

#### 3.5 漢字図鑑・モンスター図鑑の動作説明

##### 3.5.1 漢字図鑑 (`kanjiDexScreen.js`)

【コードから更新】詳細モーダル表示機能が追加されています。

- **基本機能**: 収集済みの漢字を一覧表示する。ページネーション機能により、多数の漢字を閲覧可能。
- **【新規】詳細表示**: 収集済みの漢字をタップするとモーダルウィンドウが開き、以下の詳細情報を表示する。
    - 音読み、訓読み、意味、例文
    - **学習習熟度データ**（正解回数、不正解回数、正答率）

##### 3.5.2 モンスターデックス (`monsterDexScreen.js`)

【コードから更新】DOMベースのグリッドレイアウトとページネーションが実装されています。

- **レイアウト**: Canvasを非表示にし、HTMLの`<div>`要素をグリッド状に配置してモンスターカードを表示する。
- **ページネーション**: 1ページあたり15体を表示し、ボタンでページを切り替えることができる。
- **遅延読み込み**: `IntersectionObserver`を使用し、画面に表示されたカードの画像のみを読み込むことで、パフォーマンスを向上させている。

#### **【新規】3.7 実績システム**

プレイヤーの特定の行動や達成状況に応じて「実績」を付与するシステム。

- **実績の定義**: `data/achievements.json`にて、実績のID、名称、説明、達成条件が定義されている。
- **統計データの記録**: 実績達成の判定に必要な各種統計データ（モンスター討伐数、総正解数、プレイ時間など）は`gameState.playerStats`オブジェクト内で記録・管理される。
- **達成判定**: `achievementManager.js`の`checkAchievements()`関数が、プレイヤーの行動が記録された後に呼び出され、条件判定を行う。
- **実績の永続化**: 解除された実績のIDは`gameState.unlockedAchievements`に格納され、`localStorage`に保存される。
- **通知**: 実績が解除されると、`eventBus`を通じて`achievementUnlocked`イベントが発行される。

#### **【新規】3.8 スキルポイントシステム**

レベルアップ時に獲得したスキルポイントを使い、プレイヤーが任意にステータスを強化できる機能。

- **ポイント獲得**: レベルアップ時にスキルポイントを1獲得する。
- **ポイントの利用**: `statusScreen.js`にて、未使用のスキルポイントを消費して「最大HP」や「攻撃力」などのステータスを上昇させることができる。
- **永続化**: 使用状況を含む`playerStats`は`localStorage`に保存される。

### 4. データ構造

#### 4.1 各JSON/YAMLのスキーマ定義

##### 4.1.2 敵キャラクター定義 (`enemies_proto.json`)

【コードから更新】ボス戦ギミック用のプロパティが追加されています。

|プロパティ|型|説明|
|:--|:--|:--|
|...|...|...|
|`isBoss`|`boolean`|ボスキャラクターであるかを示すフラグ|
|`shieldHp`|`number`|（ボス用）特殊シールドの耐久値|

Google スプレッドシートにエクスポート

##### **【新規】4.1.5 実績定義 (`achievements.json`)**

|プロパティ|型|説明|
|:--|:--|:--|
|`id`|`string`|実績の一意な識別子|
|`title`|`string`|実績の名称|
|`description`|`string`|実績の説明文|
|`condition`|`object`|達成条件|
|`condition.type`|`string`|条件の種類（例: "enemiesDefeated"）|
|`condition.value`|`number` or `string`|条件達成に必要な値|

Google スプレッドシートにエクスポート

#### 4.2 Firebase/DB設計（コレクション・ドキュメント構造）

【コードから更新】`gameState.js`の実装に基づき、`localStorage`への保存が主となっている現状を反映します。

- **プライマリ保存先**: `localStorage`
    - キー: `kanjiGameSave`
    - 内容: `playerName`, `playerStats`（全統計情報を含む）, `unlockedAchievements`を含むオブジェクトがJSON形式で保存される。
- **Firebaseとの連携**: `DataSync.js`（未提供）モジュールを通じて、`localStorage`の内容がFirestoreと同期される設計になっている。

### 6. 技術要件・環境設定

#### 6.2 ビルド／デプロイ手順

【コードから更新】`firebase.json`の`public`ディレクトリ設定を反映します。

- **デプロイ先ディレクトリ**: Firebase Hostingの公開ディレクトリは`"public"`に設定されている。
- **ビルドスクリプトの不整合**: `package.json`のビルドスクリプトは`"dist"`フォルダを対象としており、Firebaseの公開設定と一致していない。これを`"public"`に統一するか、`firebase.json`の設定を`"dist"`に変更する必要がある。

#### 6.3 PWA化手順（Workbox, manifest.json など）

【コードから更新】

- `manifest.json`はプロジェクトルートに配置されている。
- `index.html`に`manifest.json`とサービスワーカー登録スクリプトへのリンクが記述されている。
- アイコンのパスは`/src/assets/images/icons/`となっており、ビルドプロセスでパスが正しく解決される必要がある。

### 7. 開発フェーズとリリース計画

#### 7.1 現在までに完了しているフェーズ

【コードから更新】

- **必須コア機能**: 実装完了
- **UI/UX基本レイアウト**: 完成
- **【新規】実績システム**: フレームワーク実装完了
- **【新規】スキルポイントシステム**: データ構造とポイント獲得・使用ロジック実装完了
- **【新規】復習キュー**: コア機能実装完了
- **PWA化**: 初期設定完了

#### 7.2 次に実装予定の機能一覧（優先度順）

【コードから更新】

1. **データクレンジング**: `enemies_proto.json`の重複データ削除や、`kanji_gX_proto.json`の`stageId`未設定データの修正など、データの一貫性を確保する。
2. **実績システムの完成**: `achievementManager.js`の未実装条件ロジックを全て実装する。実績解除時のポップアップ通知UIを作成する。
3. **属性システムの実装**: `battleScreen.js`のダメージ計算に弱点倍率を組み込む。
4. **Firebase Hosting設定の見直し**: 公開ディレクトリ