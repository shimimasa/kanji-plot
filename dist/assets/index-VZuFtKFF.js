var Qe=Object.defineProperty;var xe=t=>{throw TypeError(t)};var ts=(t,e,s)=>e in t?Qe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var we=(t,e,s)=>ts(t,typeof e!="symbol"?e+"":e,s),te=(t,e,s)=>e.has(t)||xe("Cannot "+s);var M=(t,e,s)=>(te(t,e,"read from private field"),s?s.call(t):e.get(t)),gt=(t,e,s)=>e.has(t)?xe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),J=(t,e,s,i)=>(te(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s),ee=(t,e,s)=>(te(t,e,"access private method"),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();const d={turn:"player",inputEnabled:!0,message:"",comboCount:0,timeRemaining:60,recentKanjiIds:[],currentKanjiIndex:0,mistakesThisStage:0,comboTimer:0,COMBO_TIMER_MAX:300},r={currentStageId:null,gameMode:"challenge",playerName:"",playerStats:{hp:100,maxHp:100,level:1,exp:0,attack:10,healCount:3,nextLevelExp:100,skillPoints:0,enemiesDefeated:0,stagesCleared:0,totalCorrect:0,totalIncorrect:0,comboCount:0,weaknessHits:0,healsSuccessful:0,skillPointsUsed:0,bossesDefeated:0,playtimeSeconds:0},enemies:[],currentEnemyIndex:0,currentEnemy:null,kanjiPool:[],currentKanji:{text:"",readings:[],meaning:""},showHint:!1,correctKanjiList:[],wrongKanjiList:[],unlockedAchievements:new Set};function es(){r.playerStats.enemiesDefeated++,Rt(),console.log(`📊 倒した敵の数: ${r.playerStats.enemiesDefeated}`)}function ss(){r.playerStats.stagesCleared++,Rt(),console.log(`📊 クリアしたステージ数: ${r.playerStats.stagesCleared}`)}function is(t){r.unlockedAchievements.has(t)||(r.unlockedAchievements.add(t),Rt(),console.log(`🏆 実績解除: ${t}`))}function Be(t){return r.unlockedAchievements.has(t)}function ns(t){r.playerStats.exp+=t;const e=as();return Rt(),e}function as(){const t=r.playerStats;if(t.exp>=t.nextLevelExp){const e=t.level;return t.exp-=t.nextLevelExp,t.level++,t.skillPoints+=1,t.maxHp+=10,t.hp=t.maxHp,t.attack+=2,t.nextLevelExp=Math.floor(t.nextLevelExp*1.2)+20,t.healCount=3,{leveledUp:!0,oldLevel:e,newLevel:t.level}}return{leveledUp:!1}}function Rt(){try{const t={playerName:r.playerName,playerStats:r.playerStats,unlockedAchievements:Array.from(r.unlockedAchievements),saveDate:new Date().toISOString()};localStorage.setItem("kanjiGameSave",JSON.stringify(t)),console.log("💾 ゲームデータを保存しました")}catch(t){console.error("❌ ゲームデータの保存に失敗しました:",t)}}function ls(){try{const t=localStorage.getItem("kanjiGameSave");if(!t)return console.log("💾 セーブデータが見つかりません。新規ゲームを開始します。"),!1;const e=JSON.parse(t);return e.playerName&&(r.playerName=e.playerName),e.playerStats&&Object.assign(r.playerStats,e.playerStats),e.unlockedAchievements&&Array.isArray(e.unlockedAchievements)&&(r.unlockedAchievements=new Set(e.unlockedAchievements)),console.log("💾 ゲームデータを読み込みました"),console.log(`📊 レベル: ${r.playerStats.level}, 倒した敵: ${r.playerStats.enemiesDefeated}, クリアしたステージ: ${r.playerStats.stagesCleared}`),console.log(`🏆 解除済み実績数: ${r.unlockedAchievements.size}`),!0}catch(t){return console.error("❌ ゲームデータの読み込みに失敗しました:",t),!1}}function os(){localStorage.removeItem("kanjiGameSave"),console.log("💾 セーブデータを削除しました")}function Pe(t){r.playerName=t.trim(),Rt()}function Wt(t){r.currentStageId=t,r.currentEnemyIndex=0,r.currentEnemy=null,r.enemies=[],r.kanjiPool=[]}ls();const Xt=new Map;function Z(t,e){Xt.has(t)||Xt.set(t,new Set),Xt.get(t).add(e)}function u(t,e){const s=Xt.get(t);if(s)for(const i of s)try{i(e)}catch(n){console.error(`イベント "${t}" のハンドラでエラー発生:`,n)}}function rs(t){console.log("プレイヤーが移動しました:",t)}Z("player:move",rs);u("player:move",{x:10,y:20});Z("changeScreen",t=>{Array.isArray(t)?window.switchScreen(t[0],t[1]):t&&typeof t=="object"&&"name"in t?window.switchScreen(t.name,t.props):window.switchScreen(t)});function cs(t){window.fsm&&typeof window.fsm.update=="function"&&window.fsm.update(t)}function hs(t=null){window.fsm&&typeof window.fsm.render=="function"&&window.fsm.render(t)}const S={},ds={logo:"/assets/images/logo.png",buttonNormal:"/assets/images/button_normal.png",buttonClick:"/assets/images/button_click.png",buttonSelect:"/assets/images/button_select.png",buttonInactive:"/assets/images/button_not_act.png",iconAttack:"/assets/images/icon_attack.png",iconHeal:"/assets/images/icon_heal.png",iconExp:"/assets/images/icon_exp.png",iconHint:"/assets/images/icon_hint.png",iconSetting:"/assets/images/icon_setting.png",markerPref:"/assets/images/stage.select/marker_pref.png",markerLocked:"/assets/images/stage.select/marker_locked.png",markerCleared:"/assets/images/stage.select/marker_cleared.png",panelStone:"/assets/images/ui/panel_stone.png",buttonStoneNormal:"/assets/images/ui/button_stone_normal.png",buttonStoneHover:"/assets/images/ui/button_stone_hover.png",buttonStonePressed:"/assets/images/ui/button_stone_pressed.png",iconOnyomi:"/assets/images/ui/icon_onyomi.png",iconKunyomi:"/assets/images/ui/icon_kunyomi.png",iconLogAttack:"/assets/images/ui/icon_log_attack.png",iconLogHeal:"/assets/images/ui/icon_log_heal.png",iconBookClosed:"/assets/images/ui/icon_book_closed.png",panelPlayer:"/assets/images/ui/panel_player.png",panelEnemy:"/assets/images/ui/panel_enemy.png",stageSelect0:"/assets/images/stage.select/stage.select.png",stageSelect:"/assets/images/stage.select/stage.select.png",stageSelect1:"/assets/images/stage.select/stage.select.1.png",stageSelect2:"/assets/images/stage.select/stage.select.2.png",stageSelect3:"/assets/images/stage.select/stage.select.3.png",stageSelect4:"/assets/images/stage.select/stage.select.4.png",stageSelect5:"/assets/images/stage.select/stage.select.5.png",stageSelect6:"/assets/images/stage.select/stage.select.6.png",japanMap:"/assets/images/japan_map.png",woodenSign:"/assets/images/wooden_sign.png",regionMarker:"/assets/images/region_marker.png",titleBackground:"/assets/images/title_background.png",region1Boundary:"/assets/images/regions/hokkaido_boundary.png",region2Boundary:"/assets/images/regions/tohoku_boundary.png",region3Boundary:"/assets/images/regions/kanto_boundary.png",region4Boundary:"/assets/images/regions/chubu_boundary.png",region5Boundary:"/assets/images/regions/kinki_boundary.png",region6Boundary:"/assets/images/regions/chugoku_boundary.png"};async function gs(){const t=Object.entries(ds).map(([e,s])=>(["panelStone","panelPlayer","panelEnemy","iconOnyomi","iconKunyomi"].includes(e)?Ot(s):ms(s)).then(a=>{S[e]=a}).catch(()=>console.warn(`⚠️ ${s} の読み込み失敗`)));await Promise.all(t)}async function fs(t){const e=`bg_${t}`;if(S[e])return S[e];const s=Date.now(),i=`/assets/images/backgrounds/${t}.png?v=${s}`;try{const n=await Ot(i);return S[e]=n,console.log(`✅ 背景画像ロード成功: ${i}`),n}catch(n){console.warn(`❌ 背景画像のロード失敗: ${i}`,n);const o=`/assets/images/stage.select.${{hokkaido_area1:1,tohoku_area1:2,tohoku_area2:2,tohoku_area3:2,tohoku_area4:2,tohoku_area5:2,tohoku_area6:2,kanto_area1:3,kanto_area2:3,kanto_area3:3,kanto_area4:3,kanto_area5:3,kanto_area6:3,kanto_area7:3,chubu_area1:4,chubu_area2:4,chubu_area3:4,chubu_area4:4,chubu_area5:4,chubu_area6:4,chubu_area7:4,chubu_area8:4,chubu_area9:4,kinki_area1:5,kinki_area2:5,kinki_area3:5,kinki_area4:5,kinki_area5:5,kinki_area6:5,kinki_area7:5,chugoku_area1:6,chugoku_area2:6,chugoku_area3:6,chugoku_area4:6,chugoku_area5:6}[t]||1}.png`;try{const c=await Ot(o);return S[e]=c,c}catch{return null}}}async function us(t){if(S[t.id])return S[t.id];const e=t.name||t.id||"モンスター";console.log(`${t.id} (${e}) の画像をロード中...`);const s={1:"grade1-hokkaido",2:"grade2-touhoku",3:"grade3-kantou",4:"grade4-chuubu",5:"grade5-kinki",6:"grade6-chuugoku"},i=s[t.grade]||s[1],n=t.id;console.log(`敵ID: ${n}, フォルダ: ${i}`);const a=[`/assets/images/monsters/full/${i}/${n}.webp`,`/assets/images/enemy/${n.split("-")[1].replace("E","")}_${e}.png`,`/assets/images/monsters/full/grade1-hokkaido/HKD-${n.split("-")[1]}.webp`,`/assets/images/enemy/${n.split("-")[1].replace("E","")}_${e.split("の")[0]}.png`];for(const g of a)try{console.log(`画像を試行: ${g}`);const m=await Ot(g);return console.log(`✅ 画像ロード成功: ${g}`),S[n]=m,m}catch{console.log(`画像ロード失敗: ${g}`)}console.log(`代替画像を生成: ${n}`);const l=document.createElement("canvas");l.width=240,l.height=180;const o=l.getContext("2d",{alpha:!0});o.clearRect(0,0,l.width,l.height),o.fillStyle="#6b8e23",o.fillRect(40,30,160,120),o.strokeStyle="white",o.lineWidth=3,o.strokeRect(40,30,160,120),o.fillStyle="white",o.font="bold 24px sans-serif",o.textAlign="center",o.fillText(e,l.width/2,l.height/2);const c=new Image,h=new Promise(g=>{c.onload=()=>{g(c)}});c.src=l.toDataURL("image/png");const f=await h;return S[n]=f,f}function ms(t){return new Promise((e,s)=>{const i=new Image;i.crossOrigin="Anonymous",i.onload=()=>e(i),i.onerror=n=>s(new Error(`画像の読み込みに失敗: ${t}`)),i.src=t})}function Ot(t){return new Promise((e,s)=>{const i=new Image;i.crossOrigin="Anonymous",i.onload=()=>{const n=document.createElement("canvas");n.width=i.width,n.height=i.height;const a=n.getContext("2d",{willReadFrequently:!0});a.drawImage(i,0,0);const l=a.getImageData(0,0,n.width,n.height),o=l.data,c=240,h=15;for(let g=0;g<o.length;g+=4){const m=o[g],y=o[g+1],p=o[g+2];m>c&&y>c&&p>c&&Math.abs(m-y)<h&&Math.abs(y-p)<h&&Math.abs(p-m)<h&&(o[g+3]=0)}a.putImageData(l,0,0);const f=new Image;f.onload=()=>e(f),f.src=n.toDataURL("image/png")},i.onerror=n=>s(new Error(`画像の読み込みに失敗: ${t}`)),i.src=t})}function ps(t,e,s,i,n,a=""){if(t.save(),S&&S.panelStone)t.drawImage(S.panelStone,0,0,16,16,e,s,16,16),t.drawImage(S.panelStone,S.panelStone.width-16,0,16,16,e+i-16,s,16,16),t.drawImage(S.panelStone,0,S.panelStone.height-16,16,16,e,s+n-16,16,16),t.drawImage(S.panelStone,S.panelStone.width-16,S.panelStone.height-16,16,16,e+i-16,s+n-16,16,16),t.drawImage(S.panelStone,16,0,S.panelStone.width-16*2,16,e+16,s,i-16*2,16),t.drawImage(S.panelStone,16,S.panelStone.height-16,S.panelStone.width-16*2,16,e+16,s+n-16,i-16*2,16),t.drawImage(S.panelStone,0,16,16,S.panelStone.height-16*2,e,s+16,16,n-16*2),t.drawImage(S.panelStone,S.panelStone.width-16,16,16,S.panelStone.height-16*2,e+i-16,s+16,16,n-16*2),t.drawImage(S.panelStone,16,16,S.panelStone.width-16*2,S.panelStone.height-16*2,e+16,s+16,i-16*2,n-16*2);else{t.fillStyle="rgba(50, 50, 60, 0.8)",t.fillRect(e,s,i,n),t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=1;for(let l=1;l<3;l++)t.beginPath(),t.moveTo(e,s+n*l/3),t.lineTo(e+i,s+n*l/3),t.stroke();t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=2,t.strokeRect(e,s,i,n)}a&&(t.fillStyle="white",t.font='18px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="top",t.fillText(a,e+i/2,s+10)),t.restore()}let X=[],ht=[],et=[],Yt={};async function ys(){try{console.log("外部JSONファイルの読み込みを開始します...");const e=[1,2,3,4,5,6].map(c=>fetch(`/data/kanji_g${c}_proto.json`).then(h=>{if(!h.ok)throw new Error(`漢字データ g${c} の読み込みに失敗: ${h.statusText}`);return h.json()}));et=(await Promise.all(e)).flat().map(c=>({...c,incorrectCount:c.incorrectCount??0})),console.log("漢字データ読み込み完了");const n=await fetch("/data/enemies_proto.json");if(!n.ok)throw new Error(`敵データの読み込みに失敗: ${n.statusText}`);ht=await n.json(),console.log("敵データ読み込み完了");const l=await fetch("/data/stages_proto.json");if(!l.ok)throw new Error(`ステージデータの読み込みに失敗: ${l.statusText}`);X=await l.json(),console.log("ステージデータ読み込み完了");const o={};for(const c of et){const h=c.stageId;o[h]||(o[h]=[]),o[h].push(c)}return Ss(o),{kanjiData:et,enemyData:ht,stageData:X}}catch(t){return console.error("ゲームデータの読み込み中にエラーが発生しました:",t),null}}function me(t){const e=X.find(i=>i.stageId===t);if(!e||!e.enemyIdList)return[];let s=ht.filter(i=>e.enemyIdList.includes(i.id));if(s.length===0){console.warn(`⚠️ ステージ ${t} の敵が見つかりません。IDマッピングを試みます。`);const n={tohoku_area1:"AOM",tohoku_area2:"IWT",tohoku_area3:"AKT",tohoku_area4:"MYG",tohoku_area5:"YMG",tohoku_area6:"HKS",kanto_area1:"TOC",kanto_area2:"GNM",kanto_area3:"IBK",kanto_area4:"SIT",kanto_area5:"TB",kanto_area6:"TKY",kanto_area7:"KNG",chubu_area1:"NGT",chubu_area2:"TYM",chubu_area3:"ISK",chubu_area4:"HKI",chubu_area5:"NGN",chubu_area6:"GF",kinki_area1:"ME",kinki_area2:"SG",kinki_area3:"OSK",kinki_area4:"KYT",kinki_area5:"HYG",kinki_area6:"NR",kinki_area7:"WKY",chuugoku_area1:"TTR",chuugoku_area2:"OKY",chuugoku_area3:"SMN",chuugoku_area4:"HRS",chuugoku_area5:"YMGC"}[t];n&&(s=ht.filter(a=>a.id.startsWith(n)),console.log(`${n} で始まる敵を ${s.length} 件見つけました。`))}return s.length===0&&(console.warn("代替として北海道の敵を使用します。"),s=ht.filter(i=>i.id.startsWith("HKD-E")).slice(0,10)),s}function Ss(t){Yt=t}function _e(t){const e=t.replace("chubu_area","chuubu_area").replace("kanto_area","kantou_area");if(!Yt||!Yt[e]){console.warn(`stageKanjiMap[${t}] が見つかりません。正規化されたID: ${e}`);const s=X.find(i=>i.stageId===t);if(s&&s.grade){const i=et.filter(n=>n.grade===s.grade);return console.log(`代替として学年${s.grade}の漢字 ${i.length}件を使用します。`),i.slice(0,50)}return[]}return Yt[e]}function it(t){const e=et.find(s=>s.id===t);return e||(console.warn(`kanjiData に ID=${t} のデータが見つかりません`),null)}function bt(t){const e=ht.find(s=>s.id===t);return e||(console.warn(`enemyData に ID=${t} のデータが見つかりません`),null)}function vs(){return ht.map(t=>t.id)}const Ct={apiKey:"AIzaSyCB45IBM6ktHqDgz6YxKG4D2Dp0V8sayts",authDomain:"kanjibattlerpg-proto.firebaseapp.com",projectId:"kanjibattlerpg-proto",storageBucket:"kanjibattlerpg-proto.firebasestorage.app",messagingSenderId:"92199045966",appId:"1:92199045966:web:767334da845831378fac1f"};let Bt=null,rt=null,N=null;function ks(){try{if(typeof firebase>"u")return console.error("Firebase SDK が読み込まれていません"),!1;if(!firebase.apps.length){if(!(Ct!=null&&Ct.apiKey)||Ct.apiKey==="XXXXXXXXXXXXXXX")return alert(`⚠ Firebase の API キーが未設定です。
src/firebaseConfig.js を正しく記入してください。`),!1;firebase.initializeApp(Ct),console.log("Firebase.initializeApp() 実行済み")}return Bt=firebase.auth(),rt=firebase.firestore(),rt.enablePersistence({synchronizeTabs:!0}).catch(t=>console.warn("Firestore persistence error:",t)),console.log("Firebase Auth / Firestore を取得しました"),!0}catch(t){return console.error("Error initializing Firebase services:",t),alert("Firebase 初期化に失敗しました。ネット接続と API キーを確認してください。"),!1}}async function xs(){return Bt?N?(console.log("User already available (cached in controller):",N.uid),N):Bt.currentUser?(N=Bt.currentUser,console.log("User already signed in (from auth.currentUser):",N.uid),await be(),N):new Promise((t,e)=>{console.log("Attempting anonymous sign-in..."),Bt.signInAnonymously().then(async s=>{N=s.user,console.log("New anonymous user signed in:",N.uid),await be(),t(N)}).catch(s=>{console.error("Error signing in anonymously:",s),N=null,e(s)})}):(console.error("Auth service not initialized."),null)}function Vt(){return N}async function pe(t,e="ななしのごんべえ"){if(!rt||!t||!e||e.trim()==="")return console.error("initializeNewPlayerData: Firestore service, UID, or playerName is missing or invalid."),alert("プレイヤーデータの初期化に失敗しました (情報不足)。"),null;console.log(`Initializing new player data in Firestore for UID: ${t} with name: ${e}`);const s=rt.collection("users").doc(t).collection("profile").doc("playerStats"),i={name:e.trim(),createdAt:firebase.firestore.FieldValue.serverTimestamp(),level:1,currentExp:0,maxHp:100,attack:10,nextLevelExp:100};try{return await s.set(i),console.log("New player data initialized and set in Firestore:",i),r&&r.playerStats?(r.playerName=i.name,r.playerStats.level=i.level,r.playerStats.exp=i.currentExp,r.playerStats.maxHp=i.maxHp,r.playerStats.attack=i.attack,r.playerStats.nextLevelExp=i.nextLevelExp,r.playerStats.healCount=3,console.log("Local gameState updated after new player data initialization.")):console.warn("initializeNewPlayerData: gameState or gameState.playerStats not available to update locally."),i}catch(n){return console.error("Error initializing new player data in Firestore:",n),alert("プレイヤーデータの初期化中にエラーが発生しました。"),null}}async function be(){if(!rt||!N||!N.uid){console.warn("Cannot load player data: Firestore or User not signed in."),Object.assign(r.playerStats,{level:1,exp:0,maxHp:100,attack:10,nextLevelExp:100,healCount:3}),r.playerName="ゲスト";return}const t=rt.collection("users").doc(N.uid).collection("profile").doc("playerStats");try{console.log(`Loading player data for UID: ${N.uid}`);const e=await t.get();if(e.exists){const s=e.data();console.log("Player data loaded from Firestore:",s),r.playerStats.level=s.level||1,r.playerStats.exp=s.currentExp||0,r.playerStats.maxHp=s.maxHp||100,r.playerStats.attack=s.attack||10,r.playerStats.nextLevelExp=s.nextLevelExp||calculateNextLevelExp(r.playerStats.level),r.playerName=s.name||"ななし",console.log("gameState updated from Firestore:",r.playerStats,r.playerName)}else{console.log("No player data found for this user. Initializing new data.");const s=await pe(N.uid,r.playerName||"ななしのごんべえ");s&&(r.playerStats.level=s.level,r.playerStats.exp=s.currentExp,r.playerStats.maxHp=s.maxHp,r.playerStats.attack=s.attack,r.playerStats.nextLevelExp=s.nextLevelExp,r.playerName=s.name)}}catch(e){console.error("Error loading player data from Firestore:",e),r.playerStats.maxHp||(Object.assign(r.playerStats,{level:1,exp:0,maxHp:100,attack:10,nextLevelExp:100,healCount:3}),r.playerName="ゲスト(エラー)")}}async function ws(){if(!rt||!N||!N.uid)return console.warn("Cannot load stage clear status: User not signed in."),r.stageProgress={},null;const t=rt.collection("users").doc(N.uid).collection("progress");try{const e=await t.get(),s={};return e.forEach(i=>{s[i.id]=i.data()}),console.log("All stage clear status loaded from Firestore:",s),r.stageProgress=s,s}catch(e){return console.error("Error loading all stage clear status:",e),r.stageProgress={},null}}var D,V,K,tt,kt,Ae,Re;const _t=class _t{constructor(){gt(this,kt);gt(this,D,null);gt(this,V,1);gt(this,K,.7);gt(this,tt,.7);this.loadVolumeSettings()}setMasterVolume(e){J(this,V,Math.max(0,Math.min(1,e))),M(this,D)&&(M(this,D).volume=M(this,V)*M(this,K))}getMasterVolume(){return M(this,V)}playBGM(e,s=!0){var a,l;const i=_t.FILES.bgm[e];if(!i)return console.warn(`BGM "${e}" は定義されていません`);if(((l=(a=M(this,D))==null?void 0:a.dataset)==null?void 0:l.key)===e)return;M(this,D)&&(M(this,D).pause(),M(this,D).currentTime=0,J(this,D,null));const n=new Audio(i);n.dataset.key=e,n.loop=s,n.volume=M(this,V)*M(this,K),n.play().catch(console.error),J(this,D,n)}async fadeToBGM(e,s=1){var i,n;((n=(i=M(this,D))==null?void 0:i.dataset)==null?void 0:n.key)!==e&&(await this.stopBGM(s),this.playBGM(e),await ee(this,kt,Re).call(this,M(this,D),s))}async stopBGM(e=0){M(this,D)&&(await ee(this,kt,Ae).call(this,M(this,D),e),M(this,D).pause(),M(this,D).currentTime=0,J(this,D,null))}playSE(e){const s=_t.FILES.se[e];if(!s)return console.warn(`SE "${e}" は定義されていません`);const i=new Audio(s);i.volume=M(this,V)*M(this,tt),i.play().catch(console.error)}setMasterVolume(e){J(this,V,Math.max(0,Math.min(1,e))),M(this,D)&&(M(this,D).volume=M(this,V)*M(this,K))}setBGMVolume(e){J(this,K,Math.max(0,Math.min(1,e))),M(this,D)&&(M(this,D).volume=M(this,V)*M(this,K)),localStorage.setItem("bgmVolume",M(this,K).toString()),console.log("BGM音量設定:",M(this,K))}getBGMVolume(){return M(this,K)}setSEVolume(e){J(this,tt,Math.max(0,Math.min(1,e))),localStorage.setItem("seVolume",M(this,tt).toString()),console.log("SE音量設定:",M(this,tt))}getSEVolume(){return M(this,tt)}loadVolumeSettings(){const e=localStorage.getItem("bgmVolume"),s=localStorage.getItem("seVolume");e!==null&&J(this,K,parseFloat(e)),s!==null&&J(this,tt,parseFloat(s)),console.log("音量設定読み込み - BGM:",M(this,K),"SE:",M(this,tt))}};D=new WeakMap,V=new WeakMap,K=new WeakMap,tt=new WeakMap,kt=new WeakSet,Ae=function(e,s){return new Promise(i=>{if(s<=0)return i();let n=s,a=e.volume;const l=()=>{if(n-=.016,e.volume=Math.max(0,n/s*a),n<=0)return i();requestAnimationFrame(l)};l()})},Re=function(e,s){return new Promise(i=>{if(s<=0)return i();let n=0;e.volume=0;const a=M(this,V)*M(this,K),l=()=>{if(n+=.016,e.volume=Math.min(a,n/s*a),n>=s)return i();requestAnimationFrame(l)};l()})},we(_t,"FILES",{bgm:{title:"/assets/audio/bgm_title.mp3",battle:"/assets/audio/bgm_battle.mp3",victory:"/assets/audio/bgm_victory.mp3"},se:{appear:"/assets/audio/se_appear.mp3",attack:"/assets/audio/se_attack.mp3",damage:"/assets/audio/se_damage.mp3",heal:"/assets/audio/se_heal.mp3",correct:"/assets/audio/se_correct.mp3",wrong:"/assets/audio/se_wrong.mp3",decide:"/assets/audio/se_decide.mp3",defeat:"/assets/audio/se_defeat.mp3"}});let ge=_t;const bs="progress";function Cs(){var t;return(t=firebase.apps)!=null&&t.length?firebase.firestore():(console.warn("DataSync: Firebase App is not initialized yet"),null)}const Ce={kanjiDex:"krb_kanji_dex",monsterDex:"krb_monster_dex",reviewQueue:"krb_review_queue"},Zt={_ref(){const t=Vt();if(!t)return null;const e=Cs();return e?e.collection("users").doc(t.uid).collection(bs).doc("state"):null},async initialize(){const t=this._ref();t&&t.onSnapshot(e=>{const s=e.data()||{};Object.entries(Ce).forEach(([i,n])=>{s[i]!==void 0&&localStorage.setItem(n,JSON.stringify(s[i]))})})},async syncAll(){const t=this._ref();if(!t)return;const e={};Object.entries(Ce).forEach(([s,i])=>{const n=localStorage.getItem(i);e[s]=n?JSON.parse(n):null});try{await t.set(e,{merge:!0})}catch(s){console.warn("DataSync.syncAll error:",s)}}},ot=(()=>{const t="krb_review_queue";let e=[];const s=()=>{try{const a=localStorage.getItem(t);e=a?JSON.parse(a):[]}catch(a){console.error("ReviewQueue の読み込みに失敗しました:",a),e=[]}},i=()=>{try{localStorage.setItem(t,JSON.stringify(e))}catch(a){console.error("ReviewQueue の保存に失敗しました:",a)}Zt.syncAll()};s();const n=(a,l)=>{const o=Math.max(0,Math.min(5,l)),c=a+(.1-(5-o)*(.08+(5-o)*.02));return Math.max(1.3,c)};return{add(a){e.some(l=>l.id===a)||(e.push({id:a,repetition:0,interval:0,eFactor:2.5,nextReviewAt:Date.now()}),i())},updateReview(a,l){const o=e.find(c=>c.id===a);o&&(l<3?(o.repetition=0,o.interval=1):(o.repetition++,o.repetition===1?o.interval=1:o.repetition===2?o.interval=6:o.interval=Math.round(o.interval*o.eFactor),o.eFactor=n(o.eFactor,l)),o.nextReviewAt=Date.now()+o.interval*24*60*60*1e3,i())},getDueReviews(){const a=Date.now();return e.filter(l=>l!=null&&typeof l.nextReviewAt=="number"&&l.nextReviewAt<=a)},popBatch(a=5){const l=this.getDueReviews().slice(0,a);return l.forEach(o=>{const c=e.findIndex(h=>h.id===o.id);c>=0&&e.splice(c,1)}),i(),l.map(o=>o.id)},size(){return this.getDueReviews().length}}})();class Es{constructor(e,s){this.states=s,this.currentState=null,this.change(e)}change(e,s){console.log(`FSM: 状態遷移 ${this.currentState?Object.keys(this.states).find(a=>this.states[a]===this.currentState):"null"} → ${e}`,s);const i=this.states[e];if(!i)throw new Error(`FSM: 状態 "${e}" が見つかりません`);const n=document.getElementById("uiOverlay");n&&Array.from(n.children).forEach(l=>{l.id!=="kanjiInput"&&n.removeChild(l)}),this.currentState&&typeof this.currentState.exit=="function"&&this.currentState.exit(),this.currentState=i,typeof this.currentState.enter=="function"&&this.currentState.enter(s)}update(e){this.currentState&&typeof this.currentState.update=="function"&&this.currentState.update(e)}}function G(t,e,s,i,n,a,l="#2980b9"){t.fillStyle=l,t.fillRect(e,s,i,n),t.fillStyle="white",t.font='18px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(a,e+i/2,s+n/2)}function C(t,e,s){if(!s)return!1;const i=s.width??s.w,n=s.height??s.h;return t>=s.x&&t<=s.x+i&&e>=s.y&&e<=s.y+n}function Ts(t,e,s){const i=t.createLinearGradient(0,0,0,s);i.addColorStop(0,"#2c3e50"),i.addColorStop(.5,"#34495e"),i.addColorStop(1,"#2c3e50"),t.fillStyle=i,t.fillRect(0,0,e,s),t.fillStyle="rgba(52, 152, 219, 0.1)";for(let n=0;n<e;n+=50)for(let a=0;a<s;a+=50)t.fillRect(n,a,2,2)}const Ms="krb_kanji_dex";function fe(){try{const t=localStorage.getItem(Ms),e=t?JSON.parse(t):[],s=Array.isArray(e)?e.filter(n=>n!=null):[],i=new Set(s);return console.log("【図鑑】データをロードしました。収集数:",i.size),i.size>0&&console.log("【図鑑】収集済み漢字ID:",[...i]),i}catch(t){return console.error("kanjiDex: 図鑑のロードに失敗しました",t),new Set}}const Fe="krb_monster_dex",Le="krb_seen_monsters";function qt(){try{const t=localStorage.getItem(Fe),e=t?JSON.parse(t):[];if(!Array.isArray(e))return new Set;const s=e.filter(i=>typeof i=="string");return new Set(s)}catch(t){return console.error("monsterDex: 図鑑のロードに失敗しました",t),new Set}}function ye(){try{const t=localStorage.getItem(Le),e=t?JSON.parse(t):[];if(!Array.isArray(e))return new Set;const s=e.filter(i=>typeof i=="string");return new Set(s)}catch(t){return console.error("monsterDex: 確認済みモンスターのロードに失敗しました",t),new Set}}function Is(t){try{localStorage.setItem(Fe,JSON.stringify([...t])),Zt.syncAll()}catch(e){console.error("monsterDex: 図鑑の保存に失敗しました",e)}}function Bs(t){try{localStorage.setItem(Le,JSON.stringify([...t])),Zt.syncAll()}catch(e){console.error("monsterDex: 確認済みモンスターの保存に失敗しました",e)}}function Ps(t){const e=qt();e.has(t)||(e.add(t),Is(e))}function _s(t){const e=ye();e.has(t)||(e.add(t),Bs(e))}function As(t){const e=qt(),s=ye();return e.has(t)&&!s.has(t)}let Et=null;async function Rs(){if(Et)return Et;try{const t=await fetch("/data/achievements.json");if(!t.ok)throw new Error(`実績データの読み込みに失敗: ${t.statusText}`);return Et=await t.json(),console.log(`📋 実績データを読み込みました: ${Et.length}件`),Et}catch(t){return console.error("❌ 実績データの読み込みエラー:",t),[]}}function Fs(t,e){const{condition:s}=t,{type:i,value:n}=s;switch(i){case"enemiesDefeated":return e.enemiesDefeated>=n;case"levelReached":return e.level>=n;case"stagesCleared":return e.stagesCleared>=n;case"kanjiCollected":return fe().size>=n;case"monstersCollected":return qt().size>=n;case"totalCorrect":return e.totalCorrect>=n;case"skillPointsUsed":return e.skillPointsUsed>=n;case"perfectStage":return r.justClearedPerfectly?(r.justClearedPerfectly=!1,!0):!1;case"bossesDefeated":return e.bossesDefeated>=n;case"playtimeMinutes":return e.playtimeSeconds/60>=n;case"weaknessHits":return e.weaknessHits>=n;case"healsSuccessful":return e.healsSuccessful>=n;case"regionCleared":{const a=X.filter(l=>l.region===n);return a.length===0?!1:a.every(l=>{var o,c;return(c=(o=r.stageProgress)==null?void 0:o[l.stageId])==null?void 0:c.cleared})}case"gradeCompleted":{const a=et.filter(o=>o.grade===n);if(a.length===0)return!1;const l=fe();return a.every(o=>l.has(o.id))}default:return!1}}async function Ft(){try{const t=await Rs();if(t.length===0){console.warn("⚠️ 実績データが読み込まれていません");return}const{playerStats:e,unlockedAchievements:s}=r,i=[];for(const n of t){const{id:a,title:l,description:o}=n;Be(a)||Fs(n,e)&&(is(a),i.push(n),console.log(`🏆 実績解除: ${l} - ${o}`),u("achievementUnlocked",{id:a,title:l,description:o,achievement:n}))}i.length>0&&(console.log(`✨ ${i.length}個の新しい実績を解除しました!`),i.length>1&&u("multipleAchievementsUnlocked",i))}catch(t){console.error("❌ 実績チェック中にエラーが発生しました:",t)}}d.timeRemaining=60;const Ls=5,st={back:{x:20,y:20,w:100,h:30,label:"タイトルへ"},stage:{x:140,y:20,w:120,h:30,label:"ステージ選択"},attack:{x:230,y:380,w:110,h:50,label:"こうげき"},heal:{x:350,y:380,w:110,h:50,label:"かいふく"},hint:{x:470,y:380,w:110,h:50,label:"ヒント"}},Hs=10,He=15,De=30,Ee=2,F={canvas:null,ctx:null,inputEl:null,victoryCallback:null,stageBgImage:null,_keydownHandler:null,_clickHandler:null,_wheelHandler:null,_mousemoveHandler:null,logOffset:0,timerId:null,mouseX:0,mouseY:0,isAnimatingExp:!1,expAnimQueue:[],levelUpMessage:"",stageClearPending:!1,flashEffect:{active:!1,timer:0,duration:15,color:"rgba(255, 0, 0, 0.5)"},readingHighlight:{active:!1,timer:0,duration:60,type:null},comboAnimation:{active:!1,timer:0,duration:30,scale:1,comboCount:0},playerExpDisplay:0,playerExpTarget:0,playerExpAnimating:!1,expAnimSpeed:1,lastIncorrectAnswer:null,kanjiBoxEffect:{active:!1,timer:0,duration:0,color:"rgba(46, 204, 113, 0.8)",originalSize:{width:180,height:180},currentSize:{width:180,height:180},maxScale:1.1,pulsePhase:0},levelUpEffect:{active:!1,timer:0,duration:120,overlayOpacity:.5,pulsateSpeed:.05},typewriterEffect:{active:!1,targetMessage:"",displayedChars:0,messageIndex:-1,charInterval:2,charTimer:0,soundInterval:3},expParticles:{active:!1,particles:[],maxParticles:15,sourceX:0,sourceY:0,targetX:0,targetY:0,expAmount:0},shakeEffect:{active:!1,timer:0,duration:0,intensity:0},isPrevKanjiPanelOpen:!1,lastAnsweredKanji:null,pressedButtons:new Set,startKanjiBoxEffect(t="rgba(46, 204, 113, 0.8)",e=15){this.kanjiBoxEffect.active=!0,this.kanjiBoxEffect.timer=e,this.kanjiBoxEffect.duration=e,this.kanjiBoxEffect.color=t,this.kanjiBoxEffect.pulsePhase=0,console.log("漢字ボックスエフェクト開始:",t,e)},startShakeEffect(t=15,e=5){this.shakeEffect.active=!0,this.shakeEffect.timer=t,this.shakeEffect.duration=t,this.shakeEffect.intensity=e,console.log("シェイクエフェクト開始:",t,e)},enter(t,e){try{if(console.log("🧪 battleScreen.enter() 実行",{canvasEl:t,gameStateId:r.currentStageId}),!r.currentStageId){alert("ステージIDが未設定です。タイトルに戻ります。"),u("changeScreen","title");return}if(u("playBGM","battle"),r.playerStats.hp=r.playerStats.maxHp,d.turn="player",d.inputEnabled=!0,d.comboCount=0,d.message="",d.enemyAction=null,d.enemyActionTimer=0,this.isAnimatingExp=!1,this.expAnimQueue=[],this.levelUpMessage="",r.gameMode==="challenge"&&(d.timeRemaining=60,this.timerId=setInterval(()=>{d.timeRemaining--,d.timeRemaining<=0&&(clearInterval(this.timerId),this.timerId=null,u("changeScreen","gameOver"))},1e3)),t||(console.log("⚠️ canvasEl引数がありません。DOMから取得します。"),t=document.getElementById("gameCanvas")),!t)throw new Error("キャンバス要素が見つかりません");if(this.canvas=t,this.ctx=this.canvas.getContext("2d"),!this.ctx)throw new Error("Canvas 2Dコンテキストの取得に失敗しました");this.inputEl=document.getElementById("kanjiInput"),this.inputEl?(this.inputEl.style.display="block",this.inputEl.placeholder="よみを にゅうりょく",this._keydownHandler=a=>{if(a.key==="Enter"&&(a.preventDefault(),d.turn==="player"&&d.inputEnabled)){const l=d.lastCommandMode||"attack";setTimeout(()=>{try{l==="attack"?typeof Tt=="function"?Tt():(console.error("onAttack関数が定義されていません"),d.inputEnabled=!0):l==="heal"?typeof Mt=="function"?Mt():(console.error("onHeal関数が定義されていません"),d.inputEnabled=!0):typeof It=="function"?It():(console.error("onHint関数が定義されていません"),d.inputEnabled=!0)}catch(o){console.error("処理中にエラーが発生しました:",o),d.inputEnabled=!0,this.inputEl&&(this.inputEl.value="")}},0)}},this.inputEl.addEventListener("keydown",this._keydownHandler)):console.error("kanjiInput要素が見つかりません"),this.victoryCallback=e,r.correctKanjiList=[],r.wrongKanjiList=[],d.log=[];try{this.stageBgImage=S[`bg_${r.currentStageId}`]||null,console.log(`🖼️ 背景画像取得: ${r.currentStageId}`,this.stageBgImage?"成功":"失敗")}catch(a){console.warn("背景画像が見つかりませんでした:",a),this.stageBgImage=null}if(r.enemies=me(r.currentStageId),r.kanjiPool=_e(r.currentStageId),d.kanjiPool_onyomi=r.kanjiPool.filter(a=>a.onyomi&&(Array.isArray(a.onyomi)&&a.onyomi.length>0||typeof a.onyomi=="string"&&a.onyomi.trim()!=="")),d.kanjiPool_kunyomi=r.kanjiPool.filter(a=>a.kunyomi&&(Array.isArray(a.kunyomi)&&a.kunyomi.length>0||typeof a.kunyomi=="string"&&a.kunyomi.trim()!=="")),!r.kanjiPool.length){alert(`このステージに紐づく漢字データがありません。
ステージ選択へ戻ります。`),u("changeScreen","stageSelect");return}r.currentEnemyIndex=0,d.recentKanjiIds=[],d.shuffledKanjiList=[...r.kanjiPool].sort(()=>Math.random()-.5),d.currentKanjiIndex=0;for(const a of r.enemies)a.img=S[a.id]||null,a.hp=a.maxHp;d.playerHpDisplay=r.playerStats.hp,d.playerHpTarget=r.playerStats.hp,d.playerHpAnimating=!1,d.lastAnswered=null,$e(),vt(),this.logOffset=0,this.registerHandlers(),this.comboAnimation.active=!1,this.comboAnimation.timer=0,this.comboAnimation.scale=1,this.comboAnimation.comboCount=0;const s=r.playerStats,i=Ne(s.level),n=Math.max(0,s.exp-i);this.playerExpDisplay=n,this.playerExpTarget=n,this.playerExpAnimating=!1,r.hintLevel=0,console.log("✅ battleScreen.enter() 完了")}catch(s){console.error("❌ battleScreen.enter() でエラー発生:",s),alert(`ゲーム画面の初期化に失敗しました: ${s.message}
ステージ選択に戻ります。`),u("changeScreen","stageSelect")}},update(t){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.stageBgImage)this.ctx.drawImage(this.stageBgImage,0,0,this.canvas.width,this.canvas.height);else{const v=this.ctx.createLinearGradient(0,0,0,this.canvas.height);v.addColorStop(0,"#1e3c72"),v.addColorStop(1,"#2a5298"),this.ctx.fillStyle=v,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}[st.back,st.stage].forEach(v=>{const x=C(this.mouseX,this.mouseY,v);this.drawRichButton(this.ctx,v.x,v.y,v.w,v.h,v.label,"#34495e",x)});const e=r.currentEnemy,s=480,i=80,n=240,a=120;let l=0,o=0,c=0,h=1;if(d.enemyAction==="damage"&&d.enemyActionTimer>0)l=(Math.random()-.5)*20,o=(Math.random()-.5)*10,d.enemyActionTimer--,d.enemyActionTimer===0&&(d.enemyAction=null);else if(d.enemyAction==="attack"&&d.enemyActionTimer>0){const x=He/2,_=d.enemyActionTimer;l=-((x-Math.abs(_-x))/x)*30,d.enemyActionTimer--,d.enemyActionTimer===0&&(d.enemyAction=null)}if(d.enemyAction==="defeat"&&d.enemyActionTimer>0){const v=De,x=d.enemyActionTimer,_=(v-x)/v;c=_*(Math.PI/2),h=1-_,d.enemyActionTimer--,d.enemyActionTimer===0&&(d.enemyAction=null)}if(this.ctx.save(),this.ctx.globalAlpha=h,this.ctx.translate(s+n/2+l,i+a/2+o),this.ctx.rotate(c),e&&e.isBoss&&e.shieldHp>0){const v=Math.max(n,a)*.6,x=.3+(Math.sin(Date.now()/300)+1)*.1,_=this.ctx.createRadialGradient(0,0,v*.7,0,0,v);_.addColorStop(0,"rgba(100, 180, 255, 0)"),_.addColorStop(.7,`rgba(100, 180, 255, ${x*.5})`),_.addColorStop(1,`rgba(120, 210, 255, ${x})`),this.ctx.fillStyle=_,this.ctx.beginPath(),this.ctx.arc(0,0,v,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle=`rgba(200, 230, 255, ${x+.2})`,this.ctx.lineWidth=2,this.ctx.stroke()}e&&e.img?this.ctx.drawImage(e.img,-n/2,-a/2,n,a):(this.ctx.fillStyle="#6b8e23",this.ctx.fillRect(-n/2,-a/2,n,a),this.ctx.fillStyle="white",this.ctx.font="bold 20px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(e?e.name:"モンスター",0,0)),this.ctx.restore();const f=this.canvas.width/2,g=200,m=180,y=160;if(r.currentEnemy&&r.currentEnemy.weakness){const x=`弱点は${r.currentEnemy.weakness==="onyomi"?"音読み":"訓読み"}！`;this.drawTextWithOutline(x,f,g-y/2-20,"#f39c12","black",'bold 20px "UDデジタル教科書体",sans-serif',"center","bottom",3)}if((d.comboCount>=2&&d.comboCount>0||this.comboAnimation.active)&&this.drawComboIndicator(this.ctx),r.hintLevel>0){let v="",x="yellow";switch(r.hintLevel){case 1:v=`ヒント（基本）: 画数は${r.currentKanji.strokes}`,x="#3498db";break;case 2:const dt=r.currentKanji.id%2===0,lt=dt?r.currentKanji.onyomi:r.currentKanji.kunyomi;if(lt&&lt.length>0){const Qt=lt[0].substring(0,1)+"○○";v=`ヒント（読み）: ${dt?"音読み":"訓読み"}は「${Qt}」から始まる`}else v=`ヒント（読み）: ${dt?"訓読み":"音読み"}で読むことが多い`;x="#f39c12";break;case 3:v=`ヒント（意味）: ${r.currentKanji.meaning}`,x="#e74c3c";break}const _=160,j=this.ctx.measureText(v).width+40,O=30,H=f-j/2,U=g+_/2+10;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(H,U,j,O),this.ctx.strokeStyle=x,this.ctx.lineWidth=2,this.ctx.strokeRect(H,U,j,O);const z=["💡","💡💡","💡💡💡"][r.hintLevel-1];this.ctx.font="14px sans-serif",this.ctx.fillStyle=x,this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(z,H+10,U+O/2),this.drawTextWithOutline(v,H+40,U+O/2,x,"black",'16px "UDデジタル教科書体",sans-serif',"left","middle",1)}if(d.lastAnswered){this.drawPanelBackground(this.ctx,20,70,140,180,"stone"),this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.font='bold 14px "UDデジタル教科書体",sans-serif',this.ctx.fillText("1つまえの漢字",20+140/2,85),this.ctx.font="42px serif",this.ctx.fillText(d.lastAnswered.text,20+140/2,125),this.ctx.font='12px "UDデジタル教科書体",sans-serif';const O=d.lastAnswered.kunyomi.join("、");this.readingHighlight.active&&this.readingHighlight.type==="kunyomi"?this.ctx.fillStyle="yellow":this.ctx.fillStyle="white",this.ctx.textAlign="left",this.ctx.fillText(`訓読み: ${O}`,30,155);const H=d.lastAnswered.onyomi.join("、");this.readingHighlight.active&&this.readingHighlight.type==="onyomi"?this.ctx.fillStyle="yellow":this.ctx.fillStyle="white",this.ctx.fillText(`音読み: ${H}`,30,175),this.ctx.fillStyle="white",this.ctx.fillText(`画数: ${d.lastAnswered.strokes}`,30,195),this.lastIncorrectAnswer&&(this.ctx.fillStyle="rgba(231, 76, 60, 0.2)",this.ctx.fillRect(30,210,120,22),this.ctx.strokeStyle="rgba(231, 76, 60, 0.8)",this.ctx.lineWidth=1,this.ctx.strokeRect(30,210,120,22),this.ctx.fillStyle="#e74c3c",this.ctx.font='bold 12px "UDデジタル教科書体",sans-serif',this.ctx.textAlign="center",this.ctx.fillText(`あなたの答え: ${this.lastIncorrectAnswer}`,20+140/2,225))}if(!this.isAnimatingExp&&this.expAnimQueue.length>0){this.isAnimatingExp=!0;const v=this.expAnimQueue.shift(),x=ns(v);x.leveledUp&&(u("playSE","levelUp"),this.levelUpMessage=`レベルが ${x.newLevel} にあがった！`,this.startLevelUpEffect(120),Ft().catch(_=>{console.error("実績チェック中にエラーが発生しました:",_)}),d.playerHpTarget=r.playerStats.hp,d.playerHpAnimating=!0),this.isAnimatingExp=!1}if(d.playerHpAnimating){const v=d.playerHpDisplay,x=d.playerHpTarget,_=x-v;Math.abs(_)<=Ee?(d.playerHpDisplay=x,d.playerHpAnimating=!1):d.playerHpDisplay+=Math.sign(_)*Ee}if(this.playerExpAnimating){const v=this.playerExpDisplay,x=this.playerExpTarget,_=x-v;Math.abs(_)<=this.expAnimSpeed?(this.playerExpDisplay=x,this.playerExpAnimating=!1):this.playerExpDisplay+=Math.sign(_)*this.expAnimSpeed}this.drawPlayerStatusPanel(this.ctx),this.drawEnemyStatusPanel(this.ctx),Object.entries(st).forEach(([v,x])=>{if(v==="back"||v==="stage")return;let _="#2980b9";v==="attack"?_="#e74c3c":v==="heal"?_="#27ae60":v==="hint"&&(_="#f39c12");const j=C(this.mouseX,this.mouseY,x);this.drawRichButton(this.ctx,x.x,x.y,x.w,x.h,x.label,_,j);const H={attack:S.iconAttack,heal:S.iconHeal,hint:S.iconHint}[v],U=8,at=j?1.05:1;let z=x.x,Ht=x.y,dt=x.w,lt=x.h;if(j){const qe=x.x+x.w/2,Je=x.y+x.h/2;dt=x.w*at,lt=x.h*at,z=qe-dt/2,Ht=Je-lt/2}const Dt=lt-U*2;H&&this.ctx.drawImage(H,z+U,Ht+U,Dt,Dt);const Qt=z+U+(H?Dt+U:0),Ze=Ht+lt/2;this.drawTextWithOutline(x.label,Qt,Ze,"white","black",'16px "UDデジタル教科書体",sans-serif',"left","middle",1)}),this.inputEl&&(this.inputEl.style.display="block",this.inputEl.style.position="fixed",this.inputEl.style.left="50%",this.inputEl.style.transform="translateX(-50%)",window.innerWidth<=768?(this.inputEl.style.bottom="25vh",this.inputEl.style.top="auto",this.inputEl.style.width="70vw",this.inputEl.style.maxWidth="280px",this.inputEl.style.fontSize="16px"):(this.inputEl.style.top="320px",this.inputEl.style.bottom="auto",this.inputEl.style.width="280px",this.inputEl.style.fontSize="20px"),this.inputEl.style.padding="8px 12px",this.inputEl.style.textAlign="center",this.inputEl.style.zIndex="1000",this.inputEl.style.backgroundColor="white",this.inputEl.style.border="2px solid #ccc",this.inputEl.style.borderRadius="5px",this.inputEl.style.boxSizing="border-box");const p=this.canvas.width-380,k=450,b=360,E=130;this.drawPanelBackground(this.ctx,p,k,b,E,"stone"),this.drawTextWithOutline("バトルログ",p+b/2,k+8,"white","black",'bold 14px "UDデジタル教科書体", sans-serif',"center","top",1);const w=5,B=d.log.length,P=Math.max(0,B-w);this.logOffset=Math.min(Math.max(0,this.logOffset),P);const T=Math.max(0,B-w-this.logOffset);let A=d.log.slice(T,T+w);if(this.ctx.font='14px "UDデジタル教科書体", sans-serif',this.ctx.textAlign="left",this.ctx.textBaseline="top",this.typewriterEffect.active){if(this.typewriterEffect.charTimer--,this.typewriterEffect.charTimer<=0){if(this.typewriterEffect.displayedChars++,this.typewriterEffect.charTimer=this.typewriterEffect.charInterval,this.typewriterEffect.displayedChars%this.typewriterEffect.soundInterval===0)try{u("playSE","decide",.1)}catch(v){console.warn("タイプ音の再生に失敗しました:",v)}this.typewriterEffect.displayedChars>=this.typewriterEffect.targetMessage.length&&(this.typewriterEffect.active=!1)}if(this.typewriterEffect.messageIndex>=0&&this.typewriterEffect.messageIndex<A.length){const v=this.typewriterEffect.targetMessage.substring(0,this.typewriterEffect.displayedChars);A[this.typewriterEffect.messageIndex]=v}}if(A.forEach((v,x)=>{const _=this.getMessageColor(v),j=p+8,O=k+28+x*20,H=16,U=4;let at=0,z=null;v.includes("ダメージ")||v.includes("こうげき")?z=S.iconAttack:v.includes("せいかい！")||v.includes("弱点にヒット")||v.includes("ボーナス")?(z=S.iconAttack,this.ctx.save(),this.ctx.fillStyle="#2ecc71",this.ctx.font=`${H}px sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("✓",j+H/2,O+10),this.ctx.restore(),at=H+U):v.includes("かいふく")?z=S.iconHeal:v.includes("をたおした")||v.includes("あらわれた")?z=S.iconAttack:v.includes("経験値")||v.includes("レベル")?(this.ctx.save(),this.ctx.fillStyle="#f1c40f",this.ctx.font=`${H}px sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("★",j+H/2,O+10),this.ctx.restore(),at=H+U):v.includes("ヒント")&&(z=S.iconHint),z&&!v.includes("せいかい！")&&!v.includes("弱点にヒット")&&!v.includes("ボーナス")&&!v.includes("経験値")&&!v.includes("レベル")&&(this.ctx.save(),v.includes("ダメージ")||v.includes("こうげき")?this.ctx.filter="hue-rotate(0deg) saturate(1.2)":v.includes("かいふく")?this.ctx.filter="hue-rotate(90deg) saturate(1.5)":v.includes("ヒント")&&(this.ctx.filter="hue-rotate(45deg) saturate(1.3)"),this.ctx.drawImage(z,j,O+2,H,H),this.ctx.restore(),at=H+U),this.drawTextWithOutline(v,j+at,O,_,"black",'14px "UDデジタル教科書体", sans-serif',"left","top",1)}),B>w&&this.drawTextWithOutline("↑↓ スクロール可能 ↑↓",p+b/2,k+E-18,"rgba(255, 255, 255, 0.7)","black",'10px "UDデジタル教科書体", sans-serif',"center","top",1),this.levelUpMessage)if(this.levelUpEffect.active){this.ctx.save(),this.ctx.fillStyle=`rgba(0, 0, 0, ${this.levelUpEffect.overlayOpacity})`,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.levelUpEffect.timer--,this.levelUpEffect.timer<=0&&(this.levelUpEffect.active=!1,this.levelUpMessage="");const v=1+.2*Math.sin(Date.now()*this.levelUpEffect.pulsateSpeed),x=this.canvas.width/2,_=this.canvas.height/2,j=this.ctx.createLinearGradient(x-200,_,x+200,_);j.addColorStop(0,"#f39c12"),j.addColorStop(.5,"#f1c40f"),j.addColorStop(1,"#f39c12"),this.ctx.font=`bold ${38*v}px "UDデジタル教科書体", sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.lineWidth=6,this.ctx.strokeStyle="black",this.ctx.strokeText(this.levelUpMessage,x,_),this.ctx.fillStyle=j,this.ctx.fillText(this.levelUpMessage,x,_),this.ctx.save(),this.ctx.globalAlpha=.6+.4*Math.sin(Date.now()*.003),this.ctx.translate(x,_);for(let H=0;H<12;H++)this.ctx.rotate(Math.PI/6),this.ctx.beginPath(),this.ctx.moveTo(0,-20),this.ctx.lineTo(0,-150*v),this.ctx.strokeStyle="rgba(255, 215, 0, 0.3)",this.ctx.lineWidth=10,this.ctx.stroke();this.ctx.restore();const O="攻撃力アップ！ HP最大値アップ！";this.ctx.font='20px "UDデジタル教科書体", sans-serif',this.ctx.fillStyle="white",this.ctx.fillText(O,x,_+60),this.ctx.restore()}else{this.ctx.save(),this.ctx.fillStyle="yellow",this.ctx.font='32px "UDデジタル教科書体", sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.strokeStyle="black",this.ctx.lineWidth=2;const v=this.canvas.width/2,x=this.canvas.height/2;this.ctx.strokeText(this.levelUpMessage,v,x),this.ctx.fillText(this.levelUpMessage,v,x),this.ctx.restore()}if(r.gameMode==="challenge"&&this.drawTextWithOutline(`残り時間: ${d.timeRemaining}`,this.canvas.width/2,30,"yellow","black",'24px "UDデジタル教科書体", sans-serif',"center"),this.flashEffect.active){this.flashEffect.timer--;const v=this.flashEffect.timer/this.flashEffect.duration;this.ctx.save(),this.ctx.globalAlpha=v*.5,this.ctx.fillStyle=this.flashEffect.color,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.flashEffect.timer<=0&&(this.flashEffect.active=!1)}if(this.readingHighlight.active&&(this.readingHighlight.timer--,this.readingHighlight.timer<=0&&(this.readingHighlight.active=!1,this.readingHighlight.type=null)),this.stageClearPending&&!this.isAnimatingExp&&this.expAnimQueue.length===0&&(this.stageClearPending=!1,this.victoryCallback&&this.victoryCallback()),this.comboAnimation.active){this.comboAnimation.timer--;const v=this.comboAnimation.timer/this.comboAnimation.duration;this.comboAnimation.scale=1+(1-v)*.5,this.comboAnimation.timer<=0&&(this.comboAnimation.active=!1,this.comboAnimation.scale=1)}this.kanjiBoxEffect.active&&(this.kanjiBoxEffect.timer--,this.kanjiBoxEffect.timer<=0&&(this.kanjiBoxEffect.active=!1)),this.shakeEffect.active&&(this.shakeEffect.timer--,this.shakeEffect.timer<=0&&(this.shakeEffect.active=!1)),this.expParticles.active&&this.updateAndDrawExpParticles(),d.comboCount>0&&d.comboTimer>0&&(d.comboTimer--,d.comboTimer<=0&&(console.log("⏰ コンボタイマー終了：コンボがリセットされました"),d.comboCount=0,d.comboTimer=0)),d.comboCount<0&&(d.comboCount=0),this.canvas.width/2-90,this.canvas.width/2-90,this.canvas.width/2;let I=0,R=0;if(this.shakeEffect&&this.shakeEffect.active){this.shakeEffect.timer--;const v=this.shakeEffect.intensity*(this.shakeEffect.timer/this.shakeEffect.duration);I=(Math.random()*2-1)*v,R=(Math.random()*2-1)*v,this.shakeEffect.timer<=0&&(this.shakeEffect.active=!1)}let L=1;if(this.kanjiBoxEffect&&this.kanjiBoxEffect.active){this.kanjiBoxEffect.timer--,this.kanjiBoxEffect.pulsePhase+=.2;const v=1-this.kanjiBoxEffect.timer/this.kanjiBoxEffect.duration,x=Math.sin(this.kanjiBoxEffect.pulsePhase)*.5+.5;L=1+(this.kanjiBoxEffect.maxScale-1)*x*(1-v),this.kanjiBoxEffect.color,this.kanjiBoxEffect.timer<=0&&(this.kanjiBoxEffect.active=!1)}const q=m*L,wt=y*L,ve=f-q/2+I,ke=g-wt/2+R;ps(this.ctx,ve,ke,q,wt),r.currentKanji&&(this.ctx.font=`${80*L}px serif`,this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.shadowColor="rgba(0, 0, 0, 0.7)",this.ctx.shadowBlur=5,this.ctx.shadowOffsetX=3*L,this.ctx.shadowOffsetY=3*L,this.ctx.fillText(r.currentKanji.text,ve+q/2,ke+wt/2),this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0)},drawRichButton(t,e,s,i,n,a,l="#2980b9",o=!1,c=!1){const h=c?2:0,f=o?4:c?1:3,g=s+f-h;t.fillStyle=`rgba(0, 0, 0, ${c?.2:.3})`,t.fillRect(e+f,g+f,i,n),c&&this.darkenColor(l,10),t.save();const m=o?1.05:1,y=o?this.lightenColor(l,15):l;if(o){const E=e+i/2,w=s+n/2,B=i*m,P=n*m;e=E-B/2,s=w-P/2,i=B,n=P}const p=t.createLinearGradient(e,s,e,s+n);p.addColorStop(0,this.lightenColor(y,20)),p.addColorStop(1,this.darkenColor(y,20)),t.fillStyle=p,t.fillRect(e,s,i,n),t.strokeStyle=this.darkenColor(y,30),t.lineWidth=o?3:2,t.strokeRect(e,s,i,n);const k=t.createLinearGradient(e,s,e,s+n*.3),b=o?.4:.3;k.addColorStop(0,`rgba(255, 255, 255, ${b})`),k.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=k,t.fillRect(e,s,i,n*.3),o&&(t.strokeStyle="rgba(255, 255, 255, 0.6)",t.lineWidth=1,t.strokeRect(e+1,s+1,i-2,n-2)),t.restore()},lightenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)+i,a=(s>>8&255)+i,l=(s&255)+i;return"#"+(16777216+(n<255?n<1?0:n:255)*65536+(a<255?a<1?0:a:255)*256+(l<255?l<1?0:l:255)).toString(16).slice(1)},darkenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)-i,a=(s>>8&255)-i,l=(s&255)-i;return"#"+(16777216+(n>255?255:n<0?0:n)*65536+(a>255?255:a<0?0:a)*256+(l>255?255:l<0?0:l)).toString(16).slice(1)},drawPanelBackground(t,e,s,i,n,a="default"){t.save();let l="rgba(0, 0, 0, 0.7)";if(a==="stone"?l="rgba(50, 50, 60, 0.8)":a==="paper"&&(l="rgba(245, 235, 215, 0.9)"),t.fillStyle=l,t.fillRect(e,s,i,n),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=2,t.strokeRect(e,s,i,n),a==="stone"){t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=1;for(let o=1;o<3;o++)t.beginPath(),t.moveTo(e,s+n*o/3),t.lineTo(e+i,s+n*o/3),t.stroke()}t.restore()},startFlashEffect(t="rgba(255, 0, 0, 0.5)",e=15){this.flashEffect.active=!0,this.flashEffect.timer=e,this.flashEffect.duration=e,this.flashEffect.color=t},drawTextWithOutline(t,e,s,i,n,a,l="left",o="top",c=2){this.ctx.save(),this.ctx.font=a,this.ctx.textAlign=l,this.ctx.textBaseline=o,this.ctx.strokeStyle=n,this.ctx.lineWidth=c,this.ctx.strokeText(t,e,s),this.ctx.fillStyle=i,this.ctx.fillText(t,e,s),this.ctx.restore()},getMessageColor(t){return t.includes("せいかい！")||t.includes("弱点にヒット！")||t.includes("大ダメージ！")||t.includes("れんぞくせいかいボーナス！")||t.includes("かいふくせいこう！")||t.includes("シールドにヒビが入った！")||t.includes("ボスの防御が崩れた！")||t.includes("をたおした！")||t.includes("の経験値を獲得した！")?"#2ecc71":t.includes("弱点にヒット！")||t.includes("れんぞくせいかいボーナス！")?"#f1c40f":t.includes("こうげきしっぱい！")||t.includes("かいふくしっぱい！")||t.includes("のこうげき！")||t.includes("のダメージ！")?"#ff6b9d":t.includes("のダメージ！")?"#e74c3c":"white"},drawPlayerStatusPanel(t){S.panelPlayer&&t.drawImage(S.panelPlayer,20,450,260,130);const a=55,l=20+a,o=472,c=260-a*2;this.drawTextWithOutline(r.playerName,l,o,"#5C4033","#F5DEB3",'bold 16px "UDデジタル教科書体", sans-serif',"left","top",2),this.drawTextWithOutline(`Lv.${r.playerStats.level}`,l+c,o,"#DAA520","#654321",'bold 16px "UDデジタル教科書体", sans-serif',"right","top",2);const h=o+25,f=18;t.fillStyle="rgba(0, 0, 0, 0.2)",t.fillRect(l,h,c,f);const g=r.playerStats.hp/r.playerStats.maxHp;t.fillStyle=g>.5?"#2ecc71":g>.2?"#f39c12":"#e74c3c",t.fillRect(l,h,c*g,f),this.drawTextWithOutline(`${r.playerStats.hp} / ${r.playerStats.maxHp}`,l+c/2,h+f/2,"white","black",'12px "UDデジタル教科書体", sans-serif',"center","middle",2),this.drawTextWithOutline(`ATK: ${r.playerStats.attack}`,l,h+f+18,"#5C4033","#F5DEB3",'14px "UDデジタル教科書体", sans-serif',"left","top",2)},drawEnemyStatusPanel(t){if(S.panelEnemy&&t.drawImage(S.panelEnemy,500,10,280,120),!r.currentEnemy)return;const a=35,l=500+a,o=280-a*2,c=40,h=75,f=22,g=`Lv.${r.currentEnemy.level||1}`;if(this.drawTextWithOutline(g,l+o,c,"#FFD700","#000000",'bold 18px "UDデジタル教科書体", sans-serif',"right","top",3),r.currentEnemy.weakness){const y=t.measureText(g),p=20,b=l+o-y.width-8-p,E=c,w=r.currentEnemy.weakness==="onyomi"?S.iconOnyomi:S.iconKunyomi;w&&t.drawImage(w,b,E,p,p)}this.drawTextWithOutline(r.currentEnemy.name,l,c,"#FF6347","#000000",'bold 18px "UDデジタル教科書体", sans-serif',"left","top",3),t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(l,h,o,f);const m=r.currentEnemy.hp/r.currentEnemy.maxHp;t.fillStyle="#e74c3c",t.fillRect(l,h,o*m,f),this.drawTextWithOutline(`${r.currentEnemy.hp}/${r.currentEnemy.maxHp}`,l+o/2,h+f/2,"white","black",'14px "UDデジタル教科書体", sans-serif',"center","middle",2)},exit(){this.inputEl&&(this.inputEl.style.display="none",this.inputEl.removeEventListener("keydown",this._keydownHandler)),this._clickHandler&&this.unregisterHandlers(),this.timerId&&(clearInterval(this.timerId),this.timerId=null),this.canvas=this.ctx=this.inputEl=null},registerHandlers(){this._clickHandler=t=>{this.handleClick(t)},this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this._mousemoveHandler=t=>{const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height;this.mouseX=(t.clientX-e.left)*s,this.mouseY=(t.clientY-e.top)*i},this.canvas.addEventListener("mousemove",this._mousemoveHandler),this._wheelHandler=t=>{const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,n=this.canvas.width-330,a=450;if(s>=n&&s<=n+310&&i>=a&&i<=a+130){t.preventDefault();const c=5,h=d.log.length,f=Math.max(0,h-c);t.deltaY<0?this.logOffset=Math.min(this.logOffset+1,f):this.logOffset=Math.max(0,this.logOffset-1)}},this.canvas.addEventListener("wheel",this._wheelHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mousemoveHandler),this.canvas.removeEventListener("wheel",this._wheelHandler)},handleClick(t){t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a;return C(l,o,st.back)?(u("changeScreen","title"),!0):C(l,o,st.stage)?(u("changeScreen","stageSelect"),!0):C(l,o,st.attack)?(t.preventDefault(),t.stopPropagation(),Tt(),d.lastCommandMode="attack",!0):C(l,o,st.heal)?(t.preventDefault(),t.stopPropagation(),Mt(),d.lastCommandMode="heal",!0):C(l,o,st.hint)?(t.preventDefault(),t.stopPropagation(),It(),d.lastCommandMode="hint",!0):!1},startReadingHighlight(t,e=60){this.readingHighlight.active=!0,this.readingHighlight.timer=e,this.readingHighlight.duration=e,this.readingHighlight.type=t},drawComboIndicator(t){const e=this.comboAnimation.active?this.comboAnimation.comboCount:d.comboCount;if(console.log("🔢 コンボ表示:",{comboCount:e,battleStateCombo:d.comboCount,animationActive:this.comboAnimation.active}),e<2)return;const s=this.canvas.width/2,i=200,a=s+180/2+40,l=i;t.save(),this.comboAnimation.active&&(t.translate(a,l),t.scale(this.comboAnimation.scale,this.comboAnimation.scale),t.translate(-a,-l));let o="#3498db";e>=10?o="#e74c3c":e>=5?o="#f39c12":e>=3&&(o="#2ecc71"),t.fillStyle="rgba(0, 0, 0, 0.6)",t.beginPath(),t.arc(a,l,35,0,Math.PI*2),t.fill(),t.strokeStyle=o,t.lineWidth=3,t.beginPath(),t.arc(a,l,35,0,Math.PI*2),t.stroke(),this.drawTextWithOutline(`${e}`,a,l-5,o,"black",'bold 28px "UDデジタル教科書体", sans-serif',"center","middle"),this.drawTextWithOutline("コンボ",a,l+20,"white","black",'bold 14px "UDデジタル教科書体", sans-serif',"center","middle"),t.restore()},startComboAnimation(t){this.comboAnimation.active=!0,this.comboAnimation.timer=this.comboAnimation.duration,this.comboAnimation.scale=1.5,this.comboAnimation.comboCount=t},startExpParticleEffect(t,e,s,i,n){this.expParticles={active:!0,particles:[],maxParticles:15,sourceX:t,sourceY:e,targetX:s,targetY:i,expAmount:n};for(let a=0;a<this.expParticles.maxParticles;a++){const l=Math.PI*2*a/this.expParticles.maxParticles+Math.random()*.5,o=2+Math.random()*3,c=a*3;this.expParticles.particles.push({x:t,y:e,vx:Math.cos(l)*o,vy:Math.sin(l)*o,life:0,maxLife:60+Math.random()*30,size:3+Math.random()*4,delay:c,phase:"spread",alpha:1,color:`hsl(${45+Math.random()*30}, 100%, ${60+Math.random()*20}%)`})}},startLevelUpEffect(t=120){if(this.levelUpEffect.active=!0,this.levelUpEffect.timer=t,this.levelUpEffect.duration=t,this.canvas){const i=this.canvas.style.transform||"",n=()=>{const c=(Math.random()-.5)*5,h=(Math.random()-.5)*5;this.canvas.style.transform=`${i} translate(${c}px, ${h}px)`};let a=0;const l=50,o=setInterval(()=>{n(),a+=l,a>=500&&(clearInterval(o),this.canvas.style.transform=i)},l)}},startTypewriterEffect(t){const e=d.log.length;if(e===0)return;const s=5,i=Math.max(0,e-s-this.logOffset),n=e-1-i;n>=0&&n<s&&(this.typewriterEffect.active=!0,this.typewriterEffect.targetMessage=t,this.typewriterEffect.displayedChars=0,this.typewriterEffect.messageIndex=n,this.typewriterEffect.charTimer=this.typewriterEffect.charInterval)},drawSimpleIcon(t,e,s,i,n,a){t.save(),t.fillStyle=a,t.font=`${n}px sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillStyle="rgba(0, 0, 0, 0.3)",t.beginPath(),t.arc(s+n/2,i+n/2,n/2+2,0,Math.PI*2),t.fill(),t.fillStyle=a,t.fillText(e,s+n/2,i+n/2),t.restore()},startTypewriterEffect(t){const e=d.log.length;if(e===0)return;const s=5,i=Math.max(0,e-s-this.logOffset),n=e-1-i;n>=0&&n<s&&(this.typewriterEffect.active=!0,this.typewriterEffect.targetMessage=t,this.typewriterEffect.displayedChars=0,this.typewriterEffect.messageIndex=n,this.typewriterEffect.charTimer=this.typewriterEffect.charInterval)},drawOnyomiIcon(t,e,s,i){this.drawSimpleIcon(t,"🔴",e,s,i,"red")},drawKunyomiIcon(t,e,s,i){this.drawSimpleIcon(t,"🌿",e,s,i,"blue")},drawOnyomiIcon(t,e,s,i){t.save(),t.fillStyle="rgba(231, 76, 60, 0.2)",t.beginPath(),t.arc(e+i/2,s+i/2,i/2,0,Math.PI*2),t.fill();const n=e+i/2,a=s+i/2;t.strokeStyle="#e74c3c",t.lineWidth=2,t.lineCap="round",t.beginPath(),t.arc(n,a,i*.15,-Math.PI/3,Math.PI/3),t.stroke(),t.beginPath(),t.arc(n,a,i*.25,-Math.PI/4,Math.PI/4),t.stroke(),t.beginPath(),t.arc(n,a,i*.35,-Math.PI/6,Math.PI/6),t.stroke(),t.fillStyle="#e74c3c",t.beginPath(),t.arc(n,a,i*.08,0,Math.PI*2),t.fill(),t.restore()},drawKunyomiIcon(t,e,s,i){t.save(),t.fillStyle="rgba(46, 204, 113, 0.2)",t.beginPath(),t.arc(e+i/2,s+i/2,i/2,0,Math.PI*2),t.fill();const n=e+i/2,a=s+i/2;t.fillStyle="#27ae60",t.beginPath(),t.moveTo(n,a-i*.3),t.quadraticCurveTo(n+i*.25,a-i*.1,n+i*.15,a+i*.2),t.quadraticCurveTo(n,a+i*.3,n-i*.15,a+i*.2),t.quadraticCurveTo(n-i*.25,a-i*.1,n,a-i*.3),t.fill(),t.strokeStyle="#1e8449",t.lineWidth=1.5,t.lineCap="round",t.beginPath(),t.moveTo(n,a-i*.25),t.lineTo(n,a+i*.25),t.stroke(),t.beginPath(),t.moveTo(n,a-i*.1),t.lineTo(n-i*.12,a+i*.1),t.moveTo(n,a-i*.1),t.lineTo(n+i*.12,a+i*.1),t.stroke(),t.restore()},updateAndDrawExpParticles(){if(!this.ctx){console.warn("描画コンテキストがnullです。パーティクル更新をスキップします。"),this.expParticles.active=!1;return}const t=this.expParticles.particles;let e=0;for(let s=t.length-1;s>=0;s--){const i=t[s];if(i.delay>0){i.delay--,e++;continue}if(i.life++,i.phase==="spread")i.x+=i.vx,i.y+=i.vy,i.life>20&&(i.phase="converge");else if(i.phase==="converge"){const a=this.expParticles.targetX-i.x,l=this.expParticles.targetY-i.y,o=Math.sqrt(a*a+l*l);if(o<5){i.phase="arrived",this.expAnimQueue||(this.expAnimQueue=[]),this.expAnimQueue.push(Math.floor(this.expParticles.expAmount/this.expParticles.maxParticles)),this.createExpImpactEffect(i.x,i.y),t.splice(s,1);continue}else{const c=Math.min(8,o*.1);i.vx=a/o*c,i.vy=l/o*c,i.x+=i.vx,i.y+=i.vy}}if(i.life>i.maxLife){t.splice(s,1);continue}const n=i.life/i.maxLife;n>.8&&(i.alpha=1-(n-.8)/.2),this.drawExpParticle(i),e++}e===0&&(this.expParticles.active=!1)},drawExpParticle(t){if(!this.ctx){console.warn("描画コンテキストがnullです。パーティクル描画をスキップします。");return}this.ctx.save(),this.ctx.globalAlpha=t.alpha;const e=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,t.size*2);e.addColorStop(0,t.color),e.addColorStop(.5,t.color.replace(")",", 0.5)").replace("hsl","hsla")),e.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.size,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 255, 255, 0.8)",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.size*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()},createExpImpactEffect(t,e){if(!this.ctx){console.warn("描画コンテキストがnullです。エフェクト描画をスキップします。");return}this.ctx.save();for(let i=0;i<6;i++){const n=Math.PI*2*i/6,a=8+Math.random()*4;this.ctx.strokeStyle="rgba(255, 215, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+Math.cos(n)*a,e+Math.sin(n)*a),this.ctx.stroke()}const s=this.ctx.createRadialGradient(t,e,0,t,e,12);s.addColorStop(0,"rgba(255, 255, 255, 0.9)"),s.addColorStop(.5,"rgba(255, 215, 0, 0.6)"),s.addColorStop(1,"rgba(255, 215, 0, 0)"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t,e,12,0,Math.PI*2),this.ctx.fill(),this.ctx.restore(),u("playSE","expGain")},handleAttack(){typeof Tt=="function"?Tt():console.error("onAttack関数が定義されていません")},handleHeal(){typeof Mt=="function"?Mt():console.error("onHeal関数が定義されていません")},handleHint(){typeof It=="function"?It():console.error("onHint関数が定義されていません")},drawIconWithText(t,e,s,i,n,a="white"){e&&t.drawImage(e,i,n,this.UI_CONSTANTS.ICON_SIZE,this.UI_CONSTANTS.ICON_SIZE);const l=i+this.UI_CONSTANTS.ICON_SIZE+this.UI_CONSTANTS.ICON_MARGIN;this.drawTextWithOutline(s,l,n+this.UI_CONSTANTS.ICON_SIZE/2,a,"black")},drawWeaknessIndicator(t,e,s,i){const a={onyomi:{icon:S.iconOnyomi},kunyomi:{icon:S.iconKunyomi}}[e];if(!a||!a.icon)return;const l=32;t.drawImage(a.icon,s-l/2,i-l/2,l,l)},drawExpBarWithPercentage(t,e,s,i,n,a,l){$s(t,e,s,i,n,a,l);const o=Math.floor(a/l*100),c=`${o}%`;t.font='10px "UDデジタル教科書体", sans-serif',t.textAlign="center";const h=o>50?"black":"white";this.drawTextWithOutline(c,e+i/2,s+n/2,h,h==="black"?"white":"black",'10px "UDデジタル教科書体", sans-serif',"center","middle",1)},getResponsiveLayout(){const t=this.canvas,e=t.width<600||t.height<400,s=t.width<800||t.height<600;return{panelScale:e?.8:s?.9:1,fontSize:e?12:s?14:16,buttonSize:e?.8:1,spacing:e?8:12}},drawResponsivePanel(t,e,s,i,n){const a=this.getResponsiveLayout(),l=e*a.panelScale,o=s*a.panelScale,c=i*a.panelScale,h=n*a.panelScale;return{x:l,y:o,w:c,h}},drawComboIndicatorWithTimer(t){if(!(d.comboCount<2)&&(this.drawComboIndicator(t),d.comboTimer>0)){const e=this.canvas.width/2,s=200,n=e+180/2+40,a=s,l=d.comboTimer/300,o=60,c=4;t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(n-o/2,a+45,o,c);const h=l>.3?"#2ecc71":"#e74c3c";t.fillStyle=h,t.fillRect(n-o/2,a+45,o*l,c)}},ACCESSIBLE_COLORS:{success:"#2ecc71",warning:"#f39c12",danger:"#e74c3c",info:"#3498db",successPattern:"✓",warningPattern:"⚠",dangerPattern:"✗",infoPattern:"ℹ"},drawStatusWithPattern(t,e,s,i){const n=this.ACCESSIBLE_COLORS[e];n&&(t.fillStyle=n,t.fillRect(s,i,20,20),t.fillStyle="white",t.font="16px sans-serif",t.textAlign="center",t.fillText(this.ACCESSIBLE_COLORS[e+"Pattern"],s+10,i+15))},UI_CONSTANTS:{ICON_SIZE:16,ICON_MARGIN:8,TEXT_PADDING:12,SECTION_SPACING:20},startShakeEffect(t=15,e=5){this.shakeEffect.active=!0,this.shakeEffect.timer=t,this.shakeEffect.duration=t,this.shakeEffect.intensity=e,console.log("シェイクエフェクト開始:",t,e)},handleMouseDown(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;Object.entries(st).forEach(([n,a])=>{C(s,i,a)&&this.pressedButtons.add(n)})},handleMouseUp(t){this.pressedButtons&&this.pressedButtons.clear()},registerHandlers(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseUp.bind(this))},unregisterHandlers(){this.canvas.removeEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.removeEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.removeEventListener("mouseleave",this.handleMouseUp.bind(this))}};function $e(){const t=r.enemies[r.currentEnemyIndex];r.currentEnemy=t,je(t.name,t.hp,t.maxHp),d.log=[],nt(`${t.name} があらわれた！`),u("playSE","appear"),r.hintLevel=0}function Tt(){if(console.log("🗡 onAttack() called — turn:",d.turn,"inputEnabled:",d.inputEnabled),d.turn!=="player"||!d.inputEnabled)return;d.inputEnabled=!1;const t=F.inputEl;if(!t)return;const e=t.value.trim(),s=Ut(e),i=r.currentKanji.onyomi.join("、"),n=r.currentKanji.kunyomi.join("、"),a=`正しいよみ: 音「${i}」訓「${n}」`;if(Se(r.currentKanji).includes(s)){console.log("正解！エフェクト開始"),F.startKanjiBoxEffect("rgba(241, 196, 15, 0.8)",20),F.lastAnsweredKanji={...r.currentKanji},F.lastIncorrectAnswer=null,t.style.borderColor="green",t.style.backgroundColor="rgba(0, 255, 0, 0.1)",setTimeout(()=>{t.style.borderColor="#ccc",t.style.backgroundColor="white"},500),d.lastAnswered={...r.currentKanji},r.correctKanjiList.push({...r.currentKanji}),u("playSE","correct"),u("addToKanjiDex",r.currentKanji.id),r.playerStats.totalCorrect++,r.playerStats.comboCount++;const c=et.find(b=>b.id===r.currentKanji.id);c&&(c.correctCount=(c.correctCount||0)+1,console.log(`📈 漢字ID:${r.currentKanji.id} の正解カウント: ${c.correctCount}`)),r.gameMode==="challenge"&&(d.timeRemaining+=5),d.comboCount++,d.comboCount>=2&&F.startComboAnimation(d.comboCount);let h=r.playerStats.attack,f=Math.random()*.2-.1,g=Math.round(h*(1+f)),m=null,y=!1;const p=r.currentKanji.kunyomi.includes(s),k=r.currentKanji.onyomi.includes(s);if(p&&!k?m="kunyomi":k&&!p?m="onyomi":p&&k&&(m=r.currentEnemy.weakness),m&&r.currentEnemy.weakness===m&&(y=!0,g=Math.floor(g*1.5),d.log.push("弱点にヒット！大ダメージ！"),r.playerStats.weaknessHits++,console.log(`🎯 弱点ヒット! 敵の弱点: ${r.currentEnemy.weakness}, プレイヤーの読み: ${m}`)),d.comboCount===5&&(g=Math.floor(g*1.5),d.log.push("れんぞくせいかいボーナス！"),d.comboCount=0),r.currentEnemy.isBoss)if(r.currentEnemy.shieldHp>0)if(y){r.currentEnemy.shieldHp--,d.log.push(`せいかい！${a}`),d.log.push("シールドにヒビが入った！"),r.currentEnemy.shieldHp===0&&d.log.push("ボスの防御が崩れた！"),g=0,d.lastCommandMode="attack",d.turn="enemy",d.inputEnabled=!1,setTimeout(()=>{Gt(),setTimeout(()=>{vt(),d.turn="player",d.inputEnabled=!0},1500)},1e3),t.value="";return}else g=1,d.log.push(`せいかい！${a}、しかし${r.currentEnemy.name}の防御は固い！`);else d.log.push(`せいかい！${a}、${r.currentEnemy.name}に${g}のダメージ！`);else d.log.push(`せいかい！${a}、${r.currentEnemy.name}に${g}のダメージ！`);if(g>0&&(r.currentEnemy.hp=Math.max(0,r.currentEnemy.hp-g)),d.enemyAction="damage",d.enemyActionTimer=Hs,je(r.currentEnemy.name,r.currentEnemy.hp,r.currentEnemy.maxHp),r.currentEnemy.hp===0){d.log.push(`${r.playerName}は${r.currentEnemy.name}をたおした！`),u("playSE","defeat"),d.enemyAction="defeat",d.enemyActionTimer=De,r.currentEnemy.isBoss&&r.playerStats.bossesDefeated++,Ps(r.currentEnemy.id),es(),Ft().catch(I=>{console.error("実績チェック中にエラーが発生しました:",I)});const b=r.currentEnemy.exp||30,E=480+240/2,w=80+120/2,B=20,T=F.canvas.height-120+25+35,A=B+140;F.startExpParticleEffect(E,w,A,T,b),d.log.push(`${b}の経験値を獲得した！`),r.currentEnemyIndex<r.enemies.length-1?setTimeout(()=>{const I=F.inputEl;I&&(I.value=""),r.currentEnemyIndex++,$e(),vt(),d.turn="player",d.inputEnabled=!0,r.hintLevel=0},500):setTimeout(()=>{const I=F.inputEl;I&&(I.value=""),F.stageClearPending=!0},500);return}else d.lastCommandMode="attack",d.turn="enemy",d.inputEnabled=!1,setTimeout(()=>{Gt(),setTimeout(()=>{vt(),d.turn="player",d.inputEnabled=!0},1500)},1e3)}else{t.style.borderColor="red",t.style.backgroundColor="rgba(255, 0, 0, 0.1)",setTimeout(()=>{t.style.borderColor="#ccc",t.style.backgroundColor="white"},500),F.lastIncorrectAnswer=s,d.lastAnswered={...r.currentKanji},r.wrongKanjiList.push({...r.currentKanji}),u("addToReview",r.currentKanji.id),u("playSE","wrong"),nt(`こうげきしっぱい！${a}`),r.playerStats.totalIncorrect++,d.mistakesThisStage++,r.playerStats.comboCount=0;const c=et.find(p=>p.id===r.currentKanji.id);c&&(c.incorrectCount=(c.incorrectCount||0)+1,console.log(`📉 漢字ID:${r.currentKanji.id} の不正解カウント: ${c.incorrectCount}`)),d.comboCount=0,d.comboTimer=0,console.log("❌ 不正解によりコンボがリセットされました");const h=r.currentKanji.onyomi||[],f=r.currentKanji.kunyomi||[];let g=1/0,m=1/0;for(const p of h){const k=Te(s,p);g=Math.min(g,k)}for(const p of f){const k=Te(s,p);m=Math.min(m,k)}let y;g<m?y="onyomi":y="kunyomi",F.startReadingHighlight(y),d.turn="enemy",d.inputEnabled=!1,console.log("🔄 敵のターンに移行します"),setTimeout(()=>{console.log("👹 敵の攻撃を開始"),Gt(),setTimeout(()=>{console.log("📝 次の漢字を出題"),vt(),setTimeout(()=>{console.log("🎮 プレイヤーターンに戻ります"),d.turn="player",d.inputEnabled=!0},500)},1500)},1e3)}t.value=""}function Te(t,e){const s=t.trim().toLowerCase(),i=e.trim().toLowerCase(),n=[];for(let a=0;a<=i.length;a++)n[a]=[a];for(let a=0;a<=s.length;a++)n[0][a]=a;for(let a=1;a<=i.length;a++)for(let l=1;l<=s.length;l++)i.charAt(a-1)===s.charAt(l-1)?n[a][l]=n[a-1][l-1]:n[a][l]=Math.min(n[a-1][l-1]+1,n[a][l-1]+1,n[a-1][l]+1);return n[i.length][s.length]}function Mt(){if(console.log("💚 onHeal() called — turn:",d.turn,"inputEnabled:",d.inputEnabled),d.turn!=="player"||!d.inputEnabled)return;if(r.playerStats.healCount<=0){alert("回復はもう使えません！");return}d.inputEnabled=!1;const t=F.inputEl;if(!t)return;const e=t.value.trim(),s=Ut(e),i=r.currentKanji.onyomi.join("、"),n=r.currentKanji.kunyomi.join("、"),a=`正しいよみ: 音「${i}」訓「${n}」`;if(Se(r.currentKanji).includes(s))F.lastIncorrectAnswer=null,d.lastAnswered={...r.currentKanji},d.comboCount++,r.correctKanjiList.push({...r.currentKanji}),u("playSE","correct"),u("addToKanjiDex",r.currentKanji.id),r.playerStats.totalCorrect++,r.playerStats.comboCount++,r.playerStats.hp,u("playSE","heal"),r.playerStats.hp=Math.min(r.playerStats.maxHp,r.playerStats.hp+30),d.playerHpTarget=r.playerStats.hp,d.playerHpAnimating=!0,d.log.push(`かいふくせいこう！${a}`),r.playerStats.healsSuccessful++,r.gameMode==="challenge"&&(d.timeRemaining+=5);else if(F.lastIncorrectAnswer=s,d.lastAnswered={...r.currentKanji},r.wrongKanjiList.push({...r.currentKanji}),u("addToReview",r.currentKanji.id),u("playSE","wrong"),nt(`かいふくしっぱい！${a}`),r.playerStats.totalIncorrect++,d.mistakesThisStage++,r.playerStats.comboCount=0,r.gameMode==="challenge"){const c=r.currentEnemy.atk||5;if(r.playerStats.hp=Math.max(0,r.playerStats.hp-c),r.playerStats.hp===0)return setTimeout(()=>u("changeScreen","gameOver"),500)}t.value="",d.turn="enemy",setTimeout(()=>{Gt(),vt(),setTimeout(()=>{d.turn="player",d.inputEnabled=!0},500)},1e3)}function It(){switch(r.hintLevel=(r.hintLevel+1)%4,r.hintLevel){case 0:nt("ヒントを非表示にした");break;case 1:nt(`ヒント（基本）: 画数は${r.currentKanji.strokes}`);break;case 2:const t=Math.random()>.5,e=t?r.currentKanji.onyomi:r.currentKanji.kunyomi;if(e&&e.length>0){const i=e[0].substring(0,1)+"○○";nt(`ヒント（読み）: ${t?"音読み":"訓読み"}は「${i}」から始まる`)}else nt(`ヒント（読み）: ${t?"訓読み":"音読み"}で読むことが多い`);break;case 3:nt(`ヒント（意味）: ${r.currentKanji.meaning}`);break}}function Gt(){d.enemyAction="attack",d.enemyActionTimer=He;const t=r.currentEnemy.atk||5;if(d.log.push(`${r.currentEnemy.name} のこうげき！${r.playerName}に${t}のダメージ！`),r.playerStats.hp=Math.max(0,r.playerStats.hp-t),d.playerHpTarget=r.playerStats.hp,d.playerHpAnimating=!0,F.startFlashEffect("rgba(255, 0, 0, 0.5)",15),u("playSE","damage"),r.playerStats.hp<=0)return F.timerId&&(clearInterval(F.timerId),F.timerId=null),setTimeout(()=>u("changeScreen","gameOver"),1500)}function vt(){r.hintLevel=0,console.log("🎯 pickNextKanji() 開始 (属性システム対応)");const t=r.currentEnemy;if(!t||!t.weakness)return console.warn("⚠️ 敵の弱点情報が見つかりません。通常の選択方法を使用します。"),$t(r.kanjiPool,"全体プール");console.log(`🎯 敵の弱点: ${t.weakness}`);const e=t.weakness==="onyomi"?d.kanjiPool_onyomi:d.kanjiPool_kunyomi,s=t.weakness==="onyomi"?d.kanjiPool_kunyomi:d.kanjiPool_onyomi;console.log(`📋 第一候補プール: ${e.length}件`),console.log(`📋 フォールバックプール: ${s.length}件`);const i=$t(e,"第一候補");if(i)return console.log("✅ 第一候補プールから問題を選択しました"),i;console.log("⚠️ 第一候補プールが尽きました。フォールバックプールを使用します。");const n=$t(s,"フォールバック");return n?(console.log("✅ フォールバックプールから問題を選択しました"),n):(console.warn("⚠️ 全てのプールが尽きました。全体プールから強制選択します。"),$t(r.kanjiPool,"最終フォールバック"))}function $t(t,e){if(!t||t.length===0)return console.warn(`⚠️ ${e}が空です`),!1;let s=t.filter(a=>!d.recentKanjiIds.includes(a.id));s.length===0&&(console.warn(`⚠️ ${e}の全ての漢字が直近に出題済みです。全範囲から選択します。`),s=t);const i=s[Math.floor(Math.random()*s.length)];if(!i)return console.error(`❌ ${e}から漢字を選択できませんでした`),!1;d.recentKanjiIds.push(i.id),d.recentKanjiIds.length>Ls&&d.recentKanjiIds.shift();const n=a=>a?Array.isArray(a)?a.map(l=>Ut(l.trim())).filter(Boolean):typeof a=="string"?a.split(" ").map(l=>Ut(l.trim())).filter(Boolean):[]:[];return r.currentKanji={id:i.id,text:i.kanji,kunyomi:n(i.kunyomi),onyomi:n(i.onyomi),weakness:i.weakness,readings:Se(i),meaning:i.meaning,strokes:i.strokes},r.showHint=!1,nt(`「${r.currentKanji.text}」をよもう！`),console.log(`✅ ${e}から選択: ${i.kanji} (ID: ${i.id})`),console.log("📝 直近リスト:",d.recentKanjiIds),!0}function je(t,e,s){const i=F.ctx,n=F.canvas;if(!i||!n)return;i.clearRect(0,0,n.width,50),i.fillStyle="white",i.font='20px "UDデジタル教科書体",sans-serif',i.fillText(`${t} HP: ${e}／${s}`,20,30);const a=200,l=e/s;i.fillStyle="red",i.fillRect(20,35,a*l,10),i.strokeStyle="white",i.strokeRect(20,35,a,10)}const Ds=t=>String.fromCharCode(t.charCodeAt(0)-96),Pt=t=>t.replace(/[\u30a1-\u30f6]/g,Ds).trim();function Se(t){const e=new Set;return t.kunyomi&&(Array.isArray(t.kunyomi)?t.kunyomi.forEach(s=>{s&&typeof s=="string"&&e.add(Pt(s.trim()))}):typeof t.kunyomi=="string"&&t.kunyomi.split(" ").forEach(s=>{s&&e.add(Pt(s.trim()))})),t.onyomi&&(Array.isArray(t.onyomi)?t.onyomi.forEach(s=>{s&&typeof s=="string"&&e.add(Pt(s.trim()))}):typeof t.onyomi=="string"&&t.onyomi.split(" ").forEach(s=>{s&&e.add(Pt(s.trim()))})),[...e].filter(Boolean)}function Ut(t){if(!t)return"";let e=t.trim().replace(/\s+/g,"");return e=Pt(e),e}function $s(t,e,s,i,n,a,l){if(t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(e,s,i,n),l>0){const o=Math.min(a/l,1),c=t.createLinearGradient(e,s,e,s+n);if(c.addColorStop(0,"#f1c40f"),c.addColorStop(1,"#f39c12"),t.fillStyle=c,t.fillRect(e,s,i*o,n),F.playerExpAnimating){const f=e+i*o-5,g=t.createLinearGradient(f,s,f+5,s);g.addColorStop(0,"rgba(255, 255, 255, 0.1)"),g.addColorStop(.5,"rgba(255, 255, 255, 0.8)"),g.addColorStop(1,"rgba(255, 255, 255, 0.1)"),t.fillStyle=g,t.fillRect(f,s,5,n),t.fillStyle="rgba(255, 255, 255, 0.7)";for(let m=0;m<3;m++){const y=e+Math.random()*(i*o),p=s+Math.random()*n,k=1+Math.random()*2;t.fillRect(y,p,k,k)}}}t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=1,t.strokeRect(e,s,i,n),t.strokeStyle="rgba(255, 255, 255, 0.2)",t.beginPath();for(let o=1;o<5;o++){const c=e+i*o/5;t.moveTo(c,s),t.lineTo(c,s+n)}t.stroke()}function Ne(t){if(!Number.isInteger(t)||t<1||t===1)return 100;const e=Ne(t-1);return Math.floor(e*1.2)+20}function nt(t){d.log.push(t),F.startTypewriterEffect(t)}function js(t){return{enter(e){console.log(`🎮 battleStateFactory.enter() - ステージ: ${t}`,{props:e}),me(t),_e(t),r.currentStageId=t,Wt(t);let s=e;if((!s||typeof s!="object"||!s.getContext)&&(console.log("引数からキャンバスを取得できません。DOMから取得します。"),s=document.getElementById("gameCanvas")),!s){console.error("gameCanvas要素が見つかりません"),alert("ゲーム画面が見つかりません。ステージ選択に戻ります。"),u("changeScreen","stageSelect");return}console.log("🖼️ キャンバス要素を取得しました:",s),F.enter(s,()=>{localStorage.setItem(`clear_${t}`,"1"),r.currentStageId,r.correctKanjiList,r.wrongKanjiList,r.playerStats.hp,u("changeScreen","resultWin")})},update(e){F.update(e)},exit(){F.exit()}}}const jt=[{label:"1年",grade:1},{label:"2年",grade:2},{label:"3年",grade:2},{label:"4年",grade:4},{label:"5年",grade:5},{label:"6年",grade:6},{label:"総復習",grade:0}],Ns={enter(t){this.canvas=t||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),r.currentGrade==null&&(r.currentGrade=1),this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler)},update(t){const{ctx:e,canvas:s}=this,i=s.width,n=s.height,a=jt.length,l=i/a,o=50;e.clearRect(0,0,i,n),e.textAlign="center",e.textBaseline="middle",e.font="16px sans-serif",jt.forEach((c,h)=>{const f=h*l;e.fillStyle=c.grade===r.currentGrade?"#ddd":"#ccc",e.fillRect(f,0,l,o),e.fillStyle="#000",e.fillText(c.label,f+l/2,o/2);const g=this.getClearRate(c.grade)+"%",m=4;e.font="12px sans-serif";const p=e.measureText(g).width+m*2,k=20,b=f+l-p-8,E=8;e.fillStyle="#f00",e.fillRect(b,E,p,k),e.fillStyle="#fff",e.fillText(g,b+p/2,E+k/2),e.font="16px sans-serif"})},exit(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas=null,this.ctx=null},handleClick(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=Math.floor(s/(this.canvas.width/jt.length)),n=jt[i];n&&(r.currentGrade=n.grade,u("changeScreen","stageSelect"))},getClearRate(t){var l;const s=((l=window.fsm)!=null&&l.states?Object.keys(window.fsm.states):[]).filter(o=>o!=="stageSelect"),i=t===0?s:s.filter(o=>o.startsWith(`${t}_`)),n=i.length;if(n===0)return 0;const a=i.filter(o=>localStorage.getItem(`clear_${o}`)).length;return Math.round(a/n*100)}},se=[{grade:1,name:"北海道",x:665,y:170,color:"#4A90E2"},{grade:2,name:"東北",x:615,y:220,color:"#7ED321"},{grade:3,name:"関東",x:595,y:290,color:"#F5A623"},{grade:4,name:"中部",x:535,y:315,color:"#BD10E0"},{grade:5,name:"近畿",x:475,y:355,color:"#B8E986"},{grade:6,name:"中国",x:415,y:375,color:"#50E3C2"}],ft={x:10,y:540,width:120,height:40,text:"タイトルへ"},Ws={canvas:null,ctx:null,animationTime:0,hoveredMarker:null,isZooming:!1,zoomProgress:0,zoomTarget:null,zoomStartTime:0,zoomDuration:800,camera:{x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},enter(t){this.canvas=t||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.animationTime=0,this.hoveredMarker=null,this.isZooming=!1,this.zoomProgress=0,this.zoomTarget=null,this.camera={x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},this._clickHandler=this.handleClick.bind(this),this._mouseMoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mouseMoveHandler)},calculateRegionProgress(t){const e=X.filter(i=>i.grade===t);if(e.length===0)return 0;const s=e.filter(i=>{var l;const n=localStorage.getItem(`clear_${i.stageId}`),a=r.stageProgress&&((l=r.stageProgress[i.stageId])==null?void 0:l.cleared);return n||a});return Math.round(s.length/e.length*100)},getNextRegion(){for(let t=1;t<=6;t++)if(this.calculateRegionProgress(t)<100)return t;return null},startZoomAnimation(t){this.isZooming=!0,this.zoomProgress=0,this.zoomTarget=t,this.zoomStartTime=this.animationTime;const e=this.canvas.width/2,s=this.canvas.height/2;let i=2.2;t.grade===1?i=2.5:t.grade===4&&(i=2),this.camera.targetX=e-t.x*i,this.camera.targetY=s-t.y*i,this.camera.targetScale=i,u("playSE","decide")},updateZoomAnimation(t){if(!this.isZooming)return;const e=this.animationTime-this.zoomStartTime;this.zoomProgress=Math.min(e/this.zoomDuration,1);const s=this.zoomProgress<.5?4*this.zoomProgress*this.zoomProgress*this.zoomProgress:1-Math.pow(-2*this.zoomProgress+2,3)/2,i=.15;this.camera.x=this.camera.x+(this.camera.targetX-this.camera.x)*s*i,this.camera.y=this.camera.y+(this.camera.targetY-this.camera.y)*s*i,this.camera.scale=this.camera.scale+(this.camera.targetScale-this.camera.scale)*s*i,this.zoomProgress>=1&&(this.camera.x=this.camera.targetX,this.camera.y=this.camera.targetY,this.camera.scale=this.camera.targetScale,this.isZooming=!1,r.currentGrade=this.zoomTarget.grade,setTimeout(()=>{u("changeScreen","stageSelect")},200))},update(t){this.animationTime+=t,this.updateZoomAnimation(t),this.ctx.save(),this.ctx.translate(this.camera.x,this.camera.y),this.ctx.scale(this.camera.scale,this.camera.scale),this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(-this.camera.x/this.camera.scale,-this.camera.y/this.camera.scale,this.canvas.width/this.camera.scale,this.canvas.height/this.camera.scale),this.drawJapanMap(),this.drawTitle(),this.drawRegionMarkers(),this.ctx.restore(),this.isZooming||G(this.ctx,ft.x,ft.y,ft.width,ft.height,ft.text),this.hoveredMarker&&!this.isZooming&&this.drawMarkerTooltip(this.hoveredMarker)},drawJapanMap(){const t=S.stageSelect0||S.stageSelect;if(t){const e=this.canvas.width*.3,s=100,i=this.canvas.width*.65,n=this.canvas.height-200;this.ctx.drawImage(t,e,s,i,n),this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(e+5,s+5,i,n),this.ctx.restore()}else console.warn("日本地図画像が見つかりません。シンプルな代替地図を表示します。"),this.drawFallbackJapanMap()},drawFallbackJapanMap(){const t=this.canvas.width*.3,e=100,s=this.canvas.width*.65,i=this.canvas.height-200;this.ctx.fillStyle="#4682B4",this.ctx.fillRect(t,e,s,i),this.ctx.fillStyle="#228B22",this.ctx.strokeStyle="#006400",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.ellipse(t+s*.5,e+i*.6,s*.35,i*.15,-.2,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(t+s*.7,e+i*.25,s*.15,i*.12,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(t+s*.25,e+i*.85,s*.12,i*.08,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(t+s*.4,e+i*.75,s*.08,i*.05,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#2F4F4F",this.ctx.lineWidth=3,this.ctx.strokeRect(t,e,s,i)},drawTitle(){const t=this.canvas.width/2;if(S.woodenSign)this.ctx.drawImage(S.woodenSign,t-200,10,400,80);else{this.ctx.fillStyle="#8B4513",this.ctx.fillRect(t-200,20,400,60),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let e=0;e<5;e++)this.ctx.beginPath(),this.ctx.moveTo(t-190,30+e*10),this.ctx.lineTo(t+190,30+e*10),this.ctx.stroke();this.ctx.strokeStyle="#4A4A4A",this.ctx.lineWidth=3,this.ctx.strokeRect(t-200,20,400,60)}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font="bold 28px serif",this.ctx.strokeText("挑戦する地方を選ぼう",t,55),this.ctx.fillText("挑戦する地方を選ぼう",t,55)},drawRegionMarkers(){const t=this.getNextRegion();this.hoveredMarker&&this.drawRegionBoundaryHighlight(this.hoveredMarker),se.forEach(e=>{const s=this.hoveredMarker===e,i=t===e.grade;let a=1+Math.sin(this.animationTime*.003)*.1;s&&(a=1.4+Math.sin(this.animationTime*.01)*.1);const l=this.calculateRegionProgress(e.grade),o=s?5:3;if(this.ctx.fillStyle=`rgba(0, 0, 0, ${s?.4:.3})`,this.ctx.beginPath(),this.ctx.ellipse(e.x+o,e.y+o,25*a,25*a,0,0,2*Math.PI),this.ctx.fill(),s){const c=40*a,h=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,c);h.addColorStop(0,`${e.color}40`),h.addColorStop(.7,`${e.color}20`),h.addColorStop(1,"transparent"),this.ctx.fillStyle=h,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,c,c,0,0,2*Math.PI),this.ctx.fill()}if(S.regionMarker){const c=50*a;this.ctx.drawImage(S.regionMarker,e.x-c/2,e.y-c/2,c,c)}else this.ctx.fillStyle=s?this.lightenColor(e.color,30):e.color,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,25*a,25*a,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,18*a,18*a,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=s?this.lightenColor(e.color,30):e.color,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,8*a,8*a,0,0,2*Math.PI),this.ctx.fill();if(this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font=`bold ${16*a}px sans-serif`,this.ctx.strokeText(e.grade.toString(),e.x,e.y+5),this.ctx.fillText(e.grade.toString(),e.x,e.y+5),this.drawProgressBar(e.x,e.y+40*a,l,s),this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.textAlign="center",this.ctx.font=`bold ${12*(s?1.1:1)}px sans-serif`,this.ctx.strokeText(`${l}%`,e.x,e.y+65*a),this.ctx.fillText(`${l}%`,e.x,e.y+65*a),i&&this.drawNextIndicator(e.x,e.y),s){this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.ellipse(e.x,e.y,35*a,35*a,0,0,2*Math.PI),this.ctx.stroke();for(let c=0;c<12;c++){const h=(this.animationTime*.003+c*Math.PI/6)%(2*Math.PI),f=45+Math.sin(this.animationTime*.005+c)*5,g=e.x+Math.cos(h)*f,m=e.y+Math.sin(h)*f,y=.5+.5*Math.sin(this.animationTime*.008+c);this.ctx.fillStyle=`rgba(255, 215, 0, ${y})`,this.ctx.beginPath(),this.ctx.ellipse(g,m,4,4,0,0,2*Math.PI),this.ctx.fill()}}})},drawRegionBoundaryHighlight(t){const e=`region${t.grade}Boundary`,s=S[e];if(s){const i=this.canvas.width*.3,n=100,a=this.canvas.width*.65,l=this.canvas.height-200,o=.4+.3*Math.sin(this.animationTime*.008);this.ctx.save(),this.ctx.globalAlpha=o,this.ctx.globalCompositeOperation="multiply",this.ctx.fillStyle=t.color,this.ctx.fillRect(i,n,a,l),this.ctx.globalCompositeOperation="source-over",this.ctx.globalAlpha=o*1.5,this.ctx.drawImage(s,i,n,a,l),this.ctx.restore(),this.drawBoundaryGlowEffect(i,n,a,l,t.color)}else this.drawFallbackRegionHighlight(t)},drawBoundaryGlowEffect(t,e,s,i,n){this.ctx.save();const a=.3+.4*Math.sin(this.animationTime*.01);this.ctx.strokeStyle=n,this.ctx.lineWidth=4,this.ctx.globalAlpha=a,this.ctx.shadowColor=n,this.ctx.shadowBlur=15,this.ctx.strokeRect(t,e,s,i),this.ctx.restore()},drawFallbackRegionHighlight(t){const e=this.canvas.width*.3,s=100,i=this.canvas.width*.65,n=this.canvas.height-200,a=.2+.2*Math.sin(this.animationTime*.008);switch(this.ctx.save(),this.ctx.globalAlpha=a,this.ctx.fillStyle=t.color,t.grade){case 1:this.ctx.fillRect(e+i*.6,s,i*.4,n*.4);break;case 2:this.ctx.fillRect(e+i*.5,s+n*.3,i*.3,n*.3);break;case 3:this.ctx.fillRect(e+i*.45,s+n*.45,i*.25,n*.25);break;case 4:this.ctx.fillRect(e+i*.3,s+n*.4,i*.3,n*.3);break;case 5:this.ctx.fillRect(e+i*.25,s+n*.5,i*.25,n*.25);break;case 6:this.ctx.fillRect(e+i*.1,s+n*.55,i*.3,n*.25);break}this.ctx.restore()},lightenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)+i,a=(s>>8&255)+i,l=(s&255)+i;return"#"+(16777216+(n<255?n<1?0:n:255)*65536+(a<255?a<1?0:a:255)*256+(l<255?l<1?0:l:255)).toString(16).slice(1)},drawProgressBar(t,e,s,i=!1){const n=i?70:60,a=i?10:8,l=t-n/2,o=e-a/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(l,o,n,a);const c=n*s/100;s===100?this.ctx.fillStyle=i?"#FFED4E":"#FFD700":s>=75?this.ctx.fillStyle=i?"#4ADE80":"#32CD32":s>=50?this.ctx.fillStyle=i?"#FBBF24":"#FFA500":s>=25?this.ctx.fillStyle=i?"#FB7185":"#FF6347":this.ctx.fillStyle=i?"#F87171":"#FF4500",this.ctx.fillRect(l,o,c,a),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=i?2:1,this.ctx.strokeRect(l,o,n,a)},drawNextIndicator(t,e){const s=.5+.5*Math.sin(this.animationTime*.008);this.ctx.fillStyle=`rgba(255, 69, 0, ${s})`,this.ctx.fillRect(t+35,e-20,50,20),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.strokeRect(t+35,e-20,50,20),this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=1,this.ctx.textAlign="center",this.ctx.font="bold 10px sans-serif",this.ctx.strokeText("NEXT!",t+60,e-7),this.ctx.fillText("NEXT!",t+60,e-7);const i=Math.sin(this.animationTime*.01)*3;this.ctx.fillStyle=`rgba(255, 215, 0, ${s})`,this.ctx.beginPath(),this.ctx.moveTo(t+30+i,e-10),this.ctx.lineTo(t+25+i,e-15),this.ctx.lineTo(t+25+i,e-5),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=1,this.ctx.stroke()},drawMarkerTooltip(t){const e=this.calculateRegionProgress(t.grade),s=X.filter(g=>g.grade===t.grade),i=s.filter(g=>{var p;const m=localStorage.getItem(`clear_${g.stageId}`),y=r.stageProgress&&((p=r.stageProgress[g.stageId])==null?void 0:p.cleared);return m||y}),n=t.x*this.camera.scale+this.camera.x,a=t.y*this.camera.scale+this.camera.y,l=n+40,o=a-50,c=200,h=90,f=this.ctx.createLinearGradient(l,o,l,o+h);f.addColorStop(0,"rgba(0, 0, 0, 0.95)"),f.addColorStop(1,"rgba(20, 20, 20, 0.95)"),this.ctx.fillStyle=f,this.ctx.fillRect(l,o,c,h),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(l,o,c,h),this.ctx.strokeStyle="rgba(255, 215, 0, 0.5)",this.ctx.lineWidth=1,this.ctx.strokeRect(l+2,o+2,c-4,h-4),this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.font="bold 16px sans-serif",this.ctx.fillText(`${t.grade}年生 ${t.name}地方`,l+10,o+25),this.ctx.font="14px sans-serif",this.ctx.fillStyle=e===100?"#FFD700":"#FFFFFF",this.ctx.fillText(`進捗: ${e}%`,l+10,o+50),this.ctx.fillStyle="#CCCCCC",this.ctx.font="12px sans-serif",this.ctx.fillText(`${i.length} / ${s.length} ステージクリア`,l+10,o+70)},handleMouseMove(t){if(this.isZooming)return;const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,n=(t.clientX-e.left)*s,a=(t.clientY-e.top)*i,l=(n-this.camera.x)/this.camera.scale,o=(a-this.camera.y)/this.camera.scale,c=this.hoveredMarker;this.hoveredMarker=null;for(const h of se)if(Math.sqrt((l-h.x)**2+(o-h.y)**2)<=35){this.hoveredMarker=h,this.canvas.style.cursor="pointer",c!==h&&u("playSE","hover");break}this.hoveredMarker||(this.canvas.style.cursor="default")},exit(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mouseMoveHandler),this.canvas.style.cursor="default"},handleClick(t){if(this.isZooming)return;t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a,c=(l-this.camera.x)/this.camera.scale,h=(o-this.camera.y)/this.camera.scale;for(const f of se)if(Math.sqrt((c-f.x)**2+(h-f.y)**2)<=35){this.startZoomAnimation(f);return}if(C(l,o,ft)){u("playSE","decide"),u("changeScreen","title");return}},render(){this.update(0)}},ut=32,Xs={enter(t,e={}){this.canvas=t||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const{grade:s,region:i}=e;s!=null&&(r.currentGrade=s),i!=null&&(r.currentRegion=i),this.stages=X.filter(n=>n.grade===r.currentGrade&&n.region===r.currentRegion),this._click=this.handleClick.bind(this),this.canvas.addEventListener("click",this._click),this._key=this.handleKeydown.bind(this),window.addEventListener("keydown",this._key)},update(t){const{ctx:e,canvas:s,stages:i}=this;e.clearRect(0,0,s.width,s.height),i.forEach(n=>{const{pos:a}=n;S.markerPref?e.drawImage(S.markerPref,a.x,a.y,ut,ut):(e.fillStyle="#f00",e.fillRect(a.x,a.y,ut,ut))})},exit(){this.canvas.removeEventListener("click",this._click),window.removeEventListener("keydown",this._key),this.canvas=null,this.ctx=null,this.stages=[]},handleClick(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;for(const n of this.stages){const{pos:a,stageId:l}=n;if(s>=a.x&&s<=a.x+ut&&i>=a.y&&i<=a.y+ut){r.currentStageId=l,u("changeScreen","battle");return}}},handleKeydown(t){t.key==="Escape"&&u("changeScreen","regionSelect")}},Ys=()=>{let t=document.getElementById("uiOverlay");return t||(t=document.createElement("div"),t.id="uiOverlay",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.pointerEvents="none",document.body.appendChild(t)),t},$={width:160,height:40,gap:20,y:540},We=$.width*4+$.gap*3,Lt=(800-We)/2,ie={x:Lt,y:$.y,width:$.width,height:$.height,text:"もどる",icon:"⬅️"},ne={x:Lt+($.width+$.gap)*1,y:$.y,width:$.width,height:$.height,text:"復習",icon:"📖"},ae={x:Lt+($.width+$.gap)*2,y:$.y,width:$.width,height:$.height,text:"漢字図鑑",icon:"📚"},le={x:Lt+($.width+$.gap)*3,y:$.y,width:$.width,height:$.height,text:"モンスター",icon:"👾"},Q=32,Nt=[{label:"1年",grade:1},{label:"2年",grade:2},{label:"3年",grade:3},{label:"4年",grade:4},{label:"5年",grade:5},{label:"6年",grade:6},{label:"総復習",grade:0}],Xe={canvas:null,ctx:null,stages:[],stageButtons:[],_clickHandler:null,_mousemoveHandler:null,cbToggle:null,fontToggle:null,mouseX:0,mouseY:0,hoveredStage:null,animationTime:0,crossfadeState:{active:!1,timer:0,duration:30,oldImage:null,newImage:null,oldGrade:null,newGrade:null},reviewChallengeButton:{x:50,y:200,width:300,height:80,text:"今日の復習に挑戦！"},enter(t){u("playBGM","title"),this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),r.currentGrade==null&&(r.currentGrade=0),this.updateStageList(),this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler);const e=document.getElementById("btnReview");e&&(e.disabled=ot.size()===0,e.onclick=()=>u("changeScreen","reviewStage"));const s=Ys(),i=document.createElement("label");i.innerHTML=`
      <input type="checkbox" id="cbMode">
      <span></span>
    `,s.appendChild(i),this.cbToggle=i;const n=document.createElement("label");n.innerHTML=`
      <input type="checkbox" id="bigFont">
      <span>文字サイズ +20%</span>
    `,s.appendChild(n),this.fontToggle=n},updateStageList(){if(this.stages=r.currentGrade===0?X:X.filter(o=>o.grade===r.currentGrade),r.currentGrade===0){this.stageButtons=[];return}const t=this.stages.length,e=80,s=this.canvas.width/2;let i,n,a;t>7?(i=40,n=8,a=16):(i=50,n=15,a=20);const l=s-60;this.stageButtons=this.stages.map((o,c)=>({id:o.stageId,text:o.name,x:30,y:e+c*(i+n),width:l,height:i,fontSize:a,stage:o}))},isStageCleared(t){var i;const e=localStorage.getItem(`clear_${t}`),s=r.stageProgress&&((i=r.stageProgress[t])==null?void 0:i.cleared);return e||s},getNextStage(){for(const t of this.stages)if(!this.isStageCleared(t.stageId))return t;return null},selectReviewStage(){const t=X.filter(s=>!this.isStageCleared(s.stageId));if(t.length>0)return t.sort((s,i)=>s.grade-i.grade),t[0];if(ot.size()>0){const s=Array.from(ot.getAll());for(const i of X)if(i.kanjiPoolIdList&&i.kanjiPoolIdList.some(n=>s.includes(n)))return i}const e=Math.floor(Math.random()*X.length);return X[e]},startCrossfade(t,e){const s=t===0?"stageSelect0":`stageSelect${t}`,i=e===0?"stageSelect0":`stageSelect${e}`;this.crossfadeState.active=!0,this.crossfadeState.timer=0,this.crossfadeState.oldImage=S[s]||S.stageSelect0,this.crossfadeState.newImage=S[i]||S.stageSelect0,this.crossfadeState.oldGrade=t,this.crossfadeState.newGrade=e},handleMouseMove(t){const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height;if(this.mouseX=(t.clientX-e.left)*s,this.mouseY=(t.clientY-e.top)*i,this.hoveredStage=null,r.currentGrade!==0){if(this.stageButtons){for(const n of this.stageButtons)if(C(this.mouseX,this.mouseY,n)){this.hoveredStage=n.stage;return}}if(r.currentGrade!==0)for(const n of this.stages){const{x:a,y:l}=n.pos;if(this.mouseX>=a&&this.mouseX<=a+Q&&this.mouseY>=l&&this.mouseY<=l+Q){this.hoveredStage=n;return}}}},drawTooltip(t){if(!t)return;const e=this.ctx,s=this.mouseX+20,i=this.mouseY-80,n=200,a=90;e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(s,i,n,a),e.strokeStyle="#fff",e.lineWidth=2,e.strokeRect(s,i,n,a),e.fillStyle="#fff",e.font="14px sans-serif",e.textAlign="left",e.textBaseline="top";let l=10;e.fillText(`ステージ: ${t.name}`,s+10,i+l),l+=20,t.recommendedLevel&&(e.fillText(`推奨Lv: ${t.recommendedLevel}`,s+10,i+l),l+=20),e.fillText(`地方: ${t.region}`,s+10,i+l),l+=20;const o=this.isStageCleared(t.stageId);e.fillStyle=o?"#4CAF50":"#FFC107",e.fillText(o?"クリア済み":"未クリア",s+10,i+l)},drawReviewStats(t){this.drawPanelBackground(t,50,320,300,120,"paper");const a=X.length,l=X.filter(p=>this.isStageCleared(p.stageId)).length,o=Math.round(l/a*100),c=ot.size();t.fillStyle="#333",t.font='16px "UDデジタル教科書体", sans-serif',t.textAlign="left",t.textBaseline="top";let h=15;t.fillText("📊 学習状況",65,320+h),h+=25,t.font='14px "UDデジタル教科書体", sans-serif',t.fillText(`ステージクリア率: ${o}% (${l}/${a})`,65,320+h),h+=20,t.fillText(`復習待ち漢字: ${c}個`,65,320+h),h+=20;const f=65,g=320+h,m=270,y=10;t.fillStyle="#ddd",t.fillRect(f,g,m,y),t.fillStyle="#4CAF50",t.fillRect(f,g,m*(o/100),y),t.strokeStyle="#999",t.lineWidth=1,t.strokeRect(f,g,m,y)},drawRichButton(t,e,s,i,n,a,l="#2980b9",o=!1){t.save();const c=o?1.05:1,h=o?this.lightenColor(l,15):l;if(o){const k=e+i/2,b=s+n/2,E=i*c,w=n*c;e=k-E/2,s=b-w/2,i=E,n=w}const f=o?4:3,g=o?.4:.3;t.fillStyle=`rgba(0, 0, 0, ${g})`,t.fillRect(e+f,s+f,i,n);const m=t.createLinearGradient(e,s,e,s+n);m.addColorStop(0,this.lightenColor(h,20)),m.addColorStop(1,this.darkenColor(h,20)),t.fillStyle=m,t.fillRect(e,s,i,n),t.strokeStyle=this.darkenColor(h,30),t.lineWidth=o?3:2,t.strokeRect(e,s,i,n);const y=t.createLinearGradient(e,s,e,s+n*.3),p=o?.4:.3;y.addColorStop(0,`rgba(255, 255, 255, ${p})`),y.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=y,t.fillRect(e,s,i,n*.3),o&&(t.strokeStyle="rgba(255, 255, 255, 0.6)",t.lineWidth=1,t.strokeRect(e+1,s+1,i-2,n-2)),t.fillStyle="white",t.font='18px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(a,e+i/2,s+n/2),t.restore()},drawPanelBackground(t,e,s,i,n,a="default"){t.save();let l="rgba(0, 0, 0, 0.7)";if(a==="stone"?l="rgba(50, 50, 60, 0.8)":a==="paper"&&(l="rgba(245, 235, 215, 0.9)"),t.fillStyle=l,t.fillRect(e,s,i,n),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=2,t.strokeRect(e,s,i,n),a==="stone"){t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=1;for(let o=1;o<3;o++)t.beginPath(),t.moveTo(e,s+n*o/3),t.lineTo(e+i,s+n*o/3),t.stroke()}t.restore()},lightenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)+i,a=(s>>8&255)+i,l=(s&255)+i;return"#"+(16777216+(n<255?n<1?0:n:255)*65536+(a<255?a<1?0:a:255)*256+(l<255?l<1?0:l:255)).toString(16).slice(1)},darkenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)-i,a=(s>>8&255)-i,l=(s&255)-i;return"#"+(16777216+(n>255?255:n<0?0:n)*65536+(a>255?255:a<0?0:a)*256+(l>255?255:l<0?0:l)).toString(16).slice(1)},update(t){const{ctx:e,canvas:s,stages:i}=this,n=s.width,a=s.height;e.clearRect(0,0,n,a),this.animationTime+=t||16,this.crossfadeState.active&&(this.crossfadeState.timer++,this.crossfadeState.timer>=this.crossfadeState.duration&&(this.crossfadeState.active=!1));const l=n/2;if(this.crossfadeState.active){const p=this.crossfadeState.timer/this.crossfadeState.duration,k=1-p,b=p;this.crossfadeState.oldImage&&(e.save(),e.globalAlpha=k,e.drawImage(this.crossfadeState.oldImage,l,0,n/2,a),e.restore()),this.crossfadeState.newImage&&(e.save(),e.globalAlpha=b,e.drawImage(this.crossfadeState.newImage,l,0,n/2,a),e.restore())}else{const p=r.currentGrade??0,k=p===0?"stageSelect0":`stageSelect${p}`,b=S[k]||S.stageSelect0;b&&e.drawImage(b,l,0,n/2,a)}const o=10,c=60,h=n/2-20,f=a-140;this.drawPanelBackground(e,o,c,h,f,"stone");const g=Nt.length,m=n/g,y=50;if(e.textAlign="center",e.textBaseline="middle",e.font="16px sans-serif",Nt.forEach((p,k)=>{const b=k*m;e.fillStyle=p.grade===r.currentGrade?"#ddd":"#ccc",e.fillRect(b,0,m,y),e.fillStyle="#000",e.fillText(p.label,b+m/2,y/2)}),r.currentGrade===0){e.fillStyle="white",e.font='24px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="top",e.fillText("総復習モード",o+h/2,c+20),e.font='14px "UDデジタル教科書体", sans-serif',e.fillStyle="#ccc",e.fillText("あなたに最適なステージを自動選択します",o+h/2,c+55);const p=this.reviewChallengeButton,k=C(this.mouseX,this.mouseY,p),b=Math.sin(this.animationTime*.003)*.2+.8,E=`hsl(${120+Math.sin(this.animationTime*.002)*30}, 70%, ${50+b*10}%)`;this.drawRichButton(e,p.x,p.y,p.width,p.height,p.text,E,k),e.fillStyle="white",e.font="24px sans-serif",e.textAlign="center",e.fillText("🎯",p.x+30,p.y+p.height/2),this.drawReviewStats(e)}else{if(this.stageButtons){const p=this.getNextStage();this.stageButtons.forEach(k=>{const b=k.stage,E=this.isStageCleared(b.stageId),w=p&&p.stageId===b.stageId,B=this.hoveredStage&&this.hoveredStage.stageId===b.stageId;let P="#2980b9";E?P="#27ae60":w&&(P="#e74c3c"),this.drawRichButton(e,k.x,k.y,k.width,k.height,k.text,P,B),e.textAlign="left",e.textBaseline="top",e.font="12px sans-serif",E&&(e.fillStyle="#FFD700",e.font="16px sans-serif",e.fillText("⭐",k.x+k.width-25,k.y+5)),b.recommendedLevel&&(e.fillStyle="#fff",e.font="10px sans-serif",e.fillText(`推奨Lv.${b.recommendedLevel}`,k.x+5,k.y+k.height-15)),w&&(e.fillStyle="#FFD700",e.font="10px sans-serif",e.fillText("NEXT!",k.x+k.width-50,k.y+k.height-15))})}if(r.currentGrade!==0){const p=this.getNextStage();i.forEach(k=>{const{x:b,y:E}=k.pos,w=this.isStageCleared(k.stageId),B=p&&p.stageId===k.stageId;let P=S.markerPref,T=1,A=1;if(w)P=S.markerCleared||S.markerPref,e.save(),e.globalAlpha=1,e.filter="hue-rotate(45deg) saturate(1.5) brightness(1.2)";else if(B){const I=Math.sin(this.animationTime*.005)*.3+.7;T=1+I*.2,A=I,e.save(),e.globalAlpha=A}else e.save(),e.globalAlpha=.7;if(P){const I=Q*T,R=(I-Q)/2,L=(I-Q)/2;e.drawImage(P,b-R,E-L,I,I)}else{e.fillStyle=w?"#FFD700":B?"#FF6B35":"#f00";const I=Q*T,R=(I-Q)/2,L=(I-Q)/2;e.fillRect(b-R,E-L,I,I)}e.restore()})}}this._drawFooterBar(e,n,a),r.currentGrade!==0&&this.drawTooltip(this.hoveredStage)},_drawFooterBar(t,e,s){const i=Lt-10,n=$.y-10,a=We+20,l=$.height+20;t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(i,n,a,l),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,t.strokeRect(i,n,a,l);const o=15,c=t.createLinearGradient(i,n,i,n+o);c.addColorStop(0,"rgba(255, 255, 255, 0.2)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=c,t.fillRect(i,n,a,o);const h=C(this.mouseX,this.mouseY,ie),f=C(this.mouseX,this.mouseY,ne),g=C(this.mouseX,this.mouseY,ae),m=C(this.mouseX,this.mouseY,le);this._drawRichFooterButton(t,ie,"#808080",h),this._drawRichFooterButton(t,ne,"#2980b9",f),this._drawRichFooterButton(t,ae,"#2980b9",g),this._drawRichFooterButton(t,le,"#2980b9",m)},_drawRichFooterButton(t,e,s,i){t.save();const n=i?1.02:1,a=i?this.lightenColor(s,15):s;let{x:l,y:o,width:c,height:h}=e;if(i){const b=l+c/2,E=o+h/2,w=c*n,B=h*n;l=b-w/2,o=E-B/2,c=w,h=B}const f=i?3:2,g=i?.4:.3;t.fillStyle=`rgba(0, 0, 0, ${g})`,t.fillRect(l+f,o+f,c,h);const m=t.createLinearGradient(l,o,l,o+h);m.addColorStop(0,this.lightenColor(a,20)),m.addColorStop(1,this.darkenColor(a,20)),t.fillStyle=m,t.fillRect(l,o,c,h),t.strokeStyle=this.darkenColor(a,30),t.lineWidth=i?2:1,t.strokeRect(l,o,c,h);const y=t.createLinearGradient(l,o,l,o+h*.3),p=i?.4:.3;y.addColorStop(0,`rgba(255, 255, 255, ${p})`),y.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=y,t.fillRect(l,o,c*.8,h*.3),i&&(t.strokeStyle="rgba(255, 255, 255, 0.6)",t.lineWidth=1,t.strokeRect(l+1,o+1,c-2,h-2)),t.fillStyle="white",t.textAlign="center",t.textBaseline="middle",e.icon&&(t.font="16px sans-serif",t.fillText(e.icon,l+c*.25,o+h/2)),t.font='14px "UDデジタル教科書体", sans-serif';const k=e.icon?l+c*.65:l+c/2;t.fillText(e.text,k,o+h/2),t.restore()},exit(){this.unregisterHandlers();const t=document.getElementById("bgmVolumeSlider");t&&t.remove();const e=document.getElementById("seVolumeSlider");e&&e.remove(),this.cbToggle&&(this.cbToggle.remove(),this.cbToggle=null),this.fontToggle&&(this.fontToggle.remove(),this.fontToggle=null),this.canvas=null,this.ctx=null,this.backButton=null,this.resetButton=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mousemoveHandler)},handleClick(t){t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a,c=Nt.length,h=this.canvas.width/c;if(o>=0&&o<=50){const g=Math.floor(l/h),m=Nt[g];if(m){const y=r.currentGrade;r.currentGrade=m.grade,this.startCrossfade(y,m.grade),this.updateStageList(),u("playSE","decide")}return}if(r.currentGrade===0){const g=this.reviewChallengeButton;if(C(l,o,g)){const m=this.selectReviewStage();m&&(r.currentStageId=m.stageId,Wt(m.stageId),u("playSE","decide"),u("changeScreen","stageLoading"));return}}else{if(this.stageButtons){for(const g of this.stageButtons)if(C(l,o,g)){r.currentStageId=g.id,Wt(g.id),u("playSE","decide"),u("changeScreen","stageLoading");return}}if(r.currentGrade!==0)for(const g of this.stages){const{x:m,y}=g.pos;if(l>=m&&l<=m+Q&&o>=y&&o<=y+Q){r.currentStageId=g.stageId,Wt(g.stageId),u("playSE","decide"),u("changeScreen","stageLoading");return}}}if(C(l,o,ie)){u("playSE","decide"),u("changeScreen","title");return}if(C(l,o,ne)){u("playSE","decide"),u("changeScreen","reviewStage");return}if(C(l,o,ae)){u("playSE","decide"),u("changeScreen","kanjiDex");return}if(C(l,o,le)){u("playSE","decide"),u("changeScreen","monsterDex");return}},render(){this.update(0)}};Xe.render=function(){this.update(0)};const Gs={enter(t){u("playBGM","title"),this.canvas=t||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const e=this.canvas.width/2;this.animationTime=0,this.logoFloatSpeed=.02,this.logoFloatAmplitude=8,this.particleTime=0,r.playerName&&r.playerName.trim()!==""?(this.jikkuriButton={x:e-150,y:320,width:300,height:50,text:"つづきから（じっくり）"},this.challengeButton={x:e-150,y:380,width:300,height:50,text:"つづきから（チャレンジ）"},this.settingsButton={x:e-80,y:450,width:160,height:50,text:"せってい"},this.resetButton={x:e-90,y:520,width:180,height:35,text:"はじめから"}):(this.jikkuriButton={x:e-150,y:350,width:300,height:50,text:"じっくりモードで はじめる"},this.challengeButton={x:e-150,y:420,width:300,height:50,text:"チャレンジモードで はじめる"},this.resetButton=null,this.settingsButton={x:e-80,y:490,width:160,height:50,text:"せってい"}),this.registerHandlers()},update(t){this.animationTime+=t||16,this.particleTime+=t||16;const e=this.canvas.width,s=this.canvas.height,i=this.ctx;i.clearRect(0,0,e,s),this._drawFantasyBackground(i,e,s),this._drawAnimatedLogo(i,e,s),r.playerName&&r.playerName.trim()!==""&&this._drawWelcomeMessage(i,e,s),this._drawFantasyButtons(i),this._drawCopyright(i,e,s)},_drawFantasyBackground(t,e,s){const i=t.createLinearGradient(0,0,e,s);i.addColorStop(0,"#2c1810"),i.addColorStop(.25,"#3d2414"),i.addColorStop(.5,"#2c1810"),i.addColorStop(.75,"#3d2414"),i.addColorStop(1,"#2c1810"),t.fillStyle=i,t.fillRect(0,0,e,s);const n=t.createRadialGradient(e*.3,s*.2,0,e*.3,s*.2,e*.4);n.addColorStop(0,"rgba(222, 184, 135, 0.15)"),n.addColorStop(1,"transparent"),t.fillStyle=n,t.fillRect(0,0,e,s);const a=t.createRadialGradient(e*.7,s*.8,0,e*.7,s*.8,e*.5);a.addColorStop(0,"rgba(205, 133, 63, 0.1)"),a.addColorStop(1,"transparent"),t.fillStyle=a,t.fillRect(0,0,e,s),this._drawPaperTexture(t,e,s),this._drawMagicParticles(t,e,s)},_drawPaperTexture(t,e,s){t.save(),t.globalAlpha=.1,t.strokeStyle="rgba(222, 184, 135, 0.3)",t.lineWidth=.5;for(let i=0;i<50;i++){t.beginPath();const n=Math.random()*e,a=Math.random()*s,l=n+(Math.random()-.5)*100,o=a+(Math.random()-.5)*100;t.moveTo(n,a),t.lineTo(l,o),t.stroke()}t.strokeStyle="rgba(139, 69, 19, 0.05)";for(let i=0;i<e+s;i+=6)t.beginPath(),t.moveTo(i,0),t.lineTo(i-s,s),t.stroke(),t.beginPath(),t.moveTo(0,i),t.lineTo(e,i-e),t.stroke();t.restore()},_drawMagicParticles(t,e,s){t.save();for(let i=0;i<20;i++){const n=e*.2+Math.sin(this.particleTime*.001+i)*e*.6,a=s*.3+Math.cos(this.particleTime*8e-4+i*.5)*s*.4,l=2+Math.sin(this.particleTime*.002+i)*1,o=.3+Math.sin(this.particleTime*.003+i)*.2;t.globalAlpha=o;const c=t.createRadialGradient(n,a,0,n,a,l*3);c.addColorStop(0,"rgba(255, 215, 0, 0.8)"),c.addColorStop(.5,"rgba(255, 165, 0, 0.4)"),c.addColorStop(1,"transparent"),t.fillStyle=c,t.beginPath(),t.arc(n,a,l*3,0,Math.PI*2),t.fill()}t.restore()},_drawAnimatedLogo(t,e,s){if(S.logo){const{width:i,height:n}=S.logo;let a=e*.6,l=e*.6/i*n;l>s*.25&&(l=s*.25,a=s*.25/n*i);const o=Math.sin(this.animationTime*this.logoFloatSpeed)*this.logoFloatAmplitude,c=(e-a)/2,h=s*.2-l/2+o;this._drawLogoPedestal(t,c-20,h+l-10,a+40,30),t.save(),t.shadowColor="rgba(255, 215, 0, 0.4)",t.shadowBlur=15,t.shadowOffsetX=0,t.shadowOffsetY=5,t.drawImage(S.logo,c,h,a,l),t.restore()}},_drawLogoPedestal(t,e,s,i,n){t.save();const a=t.createLinearGradient(e,s,e,s+n);a.addColorStop(0,"#8B7355"),a.addColorStop(.3,"#A0522D"),a.addColorStop(.7,"#8B4513"),a.addColorStop(1,"#654321"),t.fillStyle=a,t.fillRect(e,s,i,n),t.strokeStyle="#D2B48C",t.lineWidth=2,t.strokeRect(e,s,i,n),t.strokeStyle="rgba(245, 222, 179, 0.5)",t.lineWidth=1,t.strokeRect(e+2,s+2,i-4,n-4),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(e+5,s+n,i,8),t.restore()},_drawWelcomeMessage(t,e,s){const i=`ようこそ、${r.playerName}さん！`,n=e/2-200,a=s*.4-20;this._drawScroll(t,n,a,400,40),t.save(),t.fillStyle="#2F1B14",t.font='24px "UDデジタル教科書体", serif',t.textAlign="center",t.textBaseline="middle",t.fillText(i,e/2,s*.4),t.restore()},_drawScroll(t,e,s,i,n){t.save();const a=t.createLinearGradient(e,s,e,s+n);a.addColorStop(0,"#F5DEB3"),a.addColorStop(.5,"#DEB887"),a.addColorStop(1,"#D2B48C"),t.fillStyle=a,t.fillRect(e,s,i,n),t.fillStyle="#8B4513",t.fillRect(e-10,s-5,20,n+10),t.fillRect(e+i-10,s-5,20,n+10),t.strokeStyle="#8B4513",t.lineWidth=2,t.strokeRect(e,s,i,n),t.restore()},_drawFantasyButtons(t){this._drawStyledButton(t,this.jikkuriButton,"primary"),this._drawStyledButton(t,this.challengeButton,"primary"),this._drawStyledButton(t,this.settingsButton,"secondary"),this.resetButton&&(this._drawStyledButton(t,this.resetButton,"danger"),t.save(),t.font='10px "UDデジタル教科書体", sans-serif',t.fillStyle="#CD853F",t.textAlign="center",t.fillText("※データがリセットされます",this.resetButton.x+this.resetButton.width/2,this.resetButton.y+this.resetButton.height+15),t.restore())},_drawStyledButton(t,e,s="primary"){t.save();const{x:i,y:n,width:a,height:l,text:o}=e;let c,h,f;switch(s){case"primary":c=["#CD853F","#8B4513"],h="#D2B48C",f="#FFFFFF";break;case"secondary":c=["#D2B48C","#CD853F"],h="#8B4513",f="#FFFFFF";break;case"danger":c=["#e74c3c","#c0392b"],h="#a93226",f="#FFFFFF";break}t.fillStyle="rgba(0, 0, 0, 0.4)",t.fillRect(i+4,n+4,a,l);const g=t.createLinearGradient(i,n,i,n+l);g.addColorStop(0,c[0]),g.addColorStop(1,c[1]),t.fillStyle=g,t.fillRect(i,n,a,l),t.strokeStyle=h,t.lineWidth=2,t.strokeRect(i,n,a,l),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,t.strokeRect(i+2,n+2,a-4,l-4),t.fillStyle=f,t.font='16px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="middle",t.save(),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillText(o,i+a/2+1,n+l/2+1),t.restore(),t.fillStyle=f,t.fillText(o,i+a/2,n+l/2),t.restore()},_drawCopyright(t,e,s){t.save(),t.font='12px "UDデジタル教科書体", sans-serif',t.fillStyle="#8B7355",t.textAlign="center",t.fillText("© あなたの名前 2025",e/2,s-30),t.restore()},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},_startGame(t){if(!r.playerName){r.pendingGameMode=t,u("changeScreen","playerNameInput");return}r.gameMode=t,r.currentGrade=0,u("changeScreen","courseSelect")},async _resetGameData(){try{if(!confirm(`【最終確認】レベル、図鑑、ステージの進捗など、全てのセーブデータが完全に削除されます。
この操作は取り消せません。よろしいですか？`)){console.log("データリセット操作がキャンセルされました（第1段階）");return}const e=prompt(`最終確認として、以下の文字を正確に入力してください：

「リセット」

※ひらがな・カタカナは区別されます`);if(e!=="リセット"){e===null?console.log("データリセット操作がキャンセルされました（第2段階）"):(alert("入力された文字が正しくありません。データリセットを中止します。"),console.log("データリセット操作が中止されました（確認ワード不一致）"));return}console.log("データリセット処理を開始します...");try{os();const s=Vt();s!=null&&s.uid,console.log("データリセット処理が完了しました"),alert(`全てのデータが正常にリセットされました。
タイトル画面をリロードします。`),window.location.reload()}catch(s){console.error("データリセット処理中にエラーが発生しました:",s),alert(`データのリセット中にエラーが発生しました。
一部のデータが削除されていない可能性があります。`)}}catch(t){console.error("データリセット処理でエラーが発生しました:",t),alert("データのリセットに失敗しました。")}},handleClick(t){t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a;if(C(l,o,this.jikkuriButton)){u("playSE","decide"),this._startGame("jikkuri");return}if(C(l,o,this.challengeButton)){u("playSE","decide"),this._startGame("challenge");return}if(this.resetButton&&C(l,o,this.resetButton)){u("playSE","decide"),this._resetGameData();return}C(l,o,this.settingsButton)&&(u("playSE","decide"),u("changeScreen","settings"))},render(){this.update(0)}},Os={canvas:null,ctx:null,startButton:null,statusButton:null,achievementsButton:null,settingsButton:null,_clickHandler:null,enter(t){this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const e=this.canvas.width/2;this.startButton={x:e-150,y:200,width:300,height:60,text:"冒険を始める"},this.statusButton={x:e-100,y:280,width:200,height:50,text:"ステータス"},this.achievementsButton={x:e-100,y:340,width:200,height:50,text:"トロフィー"},this.settingsButton={x:e-100,y:400,width:200,height:50,text:"設定"},this.registerHandlers()},update(t){const{ctx:e,canvas:s,startButton:i,statusButton:n,achievementsButton:a,settingsButton:l}=this;e.clearRect(0,0,s.width,s.height),e.fillStyle="black",e.fillRect(0,0,s.width,s.height),e.fillStyle="white",e.font='40px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillText("メインメニュー",s.width/2,100),r.playerName&&(e.font='20px "UDデジタル教科書体", sans-serif',e.fillText(`ようこそ、${r.playerName} さん`,s.width/2,150));const o=r.playerStats.skillPoints;n.text=o>0?`ステータス (+${o})`:"ステータス";const c=r.unlockedAchievements.size;c>0?a.text=`トロフィー (${c})`:a.text="トロフィー",S.buttonNormal&&(e.drawImage(S.buttonNormal,i.x,i.y,i.width,i.height),e.drawImage(S.buttonNormal,n.x,n.y,n.width,n.height),e.drawImage(S.buttonNormal,a.x,a.y,a.width,a.height),e.drawImage(S.buttonNormal,l.x,l.y,l.width,l.height)),G(e,i.x,i.y,i.width,i.height,i.text,"#2ecc71");const h=o>0?"#f39c12":"#9b59b6";G(e,n.x,n.y,n.width,n.height,n.text,h);const f=c>0?"#FFD700":"#8e44ad";G(e,a.x,a.y,a.width,a.height,a.text,f),G(e,l.x,l.y,l.width,l.height,l.text,"#3498db")},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},handleClick(t){t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a;if(C(l,o,this.startButton)){r.currentGrade=0,u("changeScreen","stageSelect");return}if(C(l,o,this.statusButton)){u("changeScreen","status");return}if(C(l,o,this.achievementsButton)){u("changeScreen","achievements");return}if(C(l,o,this.settingsButton)){u("changeScreen","settings");return}}},Us={canvas:null,ctx:null,_clickHandler:null,enter(t){this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const e=document.getElementById("uiOverlay")||document.body;this.cleanupDOM(),this.createSettingsContainer(e),this.registerHandlers()},createSettingsContainer(t){const e=document.createElement("div");e.id="settingsContainer",e.className="settings-container";const s=document.createElement("h2");s.textContent="設定",s.className="settings-title",e.appendChild(s);const i=this.createAudioPanel();e.appendChild(i);const n=this.createDisplayPanel();e.appendChild(n);const a=this.createButtonSection();e.appendChild(a),t.appendChild(e)},createButtonSection(){const t=document.createElement("div");t.className="settings-button-section";const e=document.createElement("button");e.className="settings-button danger",e.textContent="データリセット（はじめから）",e.addEventListener("click",()=>{u("playSE","decide"),this.resetData()});const s=document.createElement("button");return s.className="settings-button primary",s.textContent="メインメニューへもどる",s.addEventListener("click",()=>{u("playSE","decide"),u("changeScreen","title")}),t.appendChild(e),t.appendChild(s),t},createAudioPanel(){const t=document.createElement("div");t.className="settings-panel";const e=document.createElement("h3");e.className="panel-title",e.textContent="オーディオ設定",t.appendChild(e);const s=document.createElement("div");s.className="setting-group";const i=document.createElement("label");i.className="setting-label",i.textContent="BGM音量";const n=document.createElement("input");n.type="range",n.id="bgmVolumeSlider",n.className="volume-slider",n.min="0",n.max="1",n.step="0.01",n.value="0.7";const a=document.createElement("span");a.className="volume-value",a.textContent="70%",s.appendChild(i),s.appendChild(n),s.appendChild(a),t.appendChild(s);const l=document.createElement("div");l.className="setting-group";const o=document.createElement("label");o.className="setting-label",o.textContent="SE音量";const c=document.createElement("input");c.type="range",c.id="seVolumeSlider",c.className="volume-slider",c.min="0",c.max="1",c.step="0.01",c.value="0.7";const h=document.createElement("span");return h.className="volume-value",h.textContent="70%",l.appendChild(o),l.appendChild(c),l.appendChild(h),t.appendChild(l),this.setupAudioEvents(n,a,c,h),t},createDisplayPanel(){const t=document.createElement("div");t.className="settings-panel";const e=document.createElement("h3");e.className="panel-title",e.textContent="表示・アクセシビリティ",t.appendChild(e);const s=this._createAccessibilityToggleWithTooltip("cbMode","色弱フレンドリーモード","赤と緑の区別がつきやすい配色に変更します。色覚に配慮したカラーパレットを使用し、より快適にゲームをお楽しみいただけます。");t.appendChild(s);const i=this._createAccessibilityToggleWithTooltip("bigFont","文字サイズ +20%","ゲーム内の全ての文字を20%大きく表示します。小さな文字が見づらい場合や、より読みやすい表示をお求めの方におすすめです。");return t.appendChild(i),this.setupAccessibilityEvents(),t},_createAccessibilityToggleWithTooltip(t,e,s){const i=document.createElement("div");i.className="setting-group";const n=document.createElement("label");n.className="toggle-switch";const a=document.createElement("div");a.className="toggle-label-container";const l=document.createElement("span");l.className="toggle-label",l.textContent=e;const o=document.createElement("span");return o.className="tooltip-trigger",o.textContent="？",o.setAttribute("data-tooltip",s),a.appendChild(l),a.appendChild(o),n.innerHTML=`
        <input type="checkbox" id="${t}">
        <span class="slider"></span>
      `,n.appendChild(a),this._setupTooltipEvents(o,s),i.appendChild(n),i},_setupTooltipEvents(t,e){let s=null;t.addEventListener("mouseover",i=>{this._removeActiveTooltip(),s=document.createElement("div"),s.className="settings-tooltip",s.textContent=e;const n=t.getBoundingClientRect();s.style.left=n.left+"px",s.style.top=n.bottom+5+"px",document.body.appendChild(s),setTimeout(()=>{s&&s.classList.add("show")},10)}),t.addEventListener("mouseout",()=>{this._removeActiveTooltip(),s=null}),t.addEventListener("click",i=>{i.preventDefault(),this._removeActiveTooltip()})},_removeActiveTooltip(){document.querySelectorAll(".settings-tooltip").forEach(e=>{e.remove()})},setupAudioEvents(t,e,s,i){u("getBGMVolume",n=>{t.value=n,e.textContent=Math.round(n*100)+"%"}),t.addEventListener("input",n=>{const a=parseFloat(n.target.value);e.textContent=Math.round(a*100)+"%",u("setBGMVolume",a)}),t.addEventListener("change",n=>{u("playSE","decide"),console.log("BGM音量設定完了:",parseFloat(n.target.value))}),u("getSEVolume",n=>{s.value=n,i.textContent=Math.round(n*100)+"%"}),s.addEventListener("input",n=>{const a=parseFloat(n.target.value);i.textContent=Math.round(a*100)+"%",u("setSEVolume",a),u("playSE","decide")}),s.addEventListener("change",n=>{console.log("SE音量設定完了:",parseFloat(n.target.value))})},setupAccessibilityEvents(){const t=()=>{const e=document.getElementById("cbMode"),s=document.getElementById("bigFont");e&&localStorage.setItem("cbMode",e.checked?"1":"0"),s&&localStorage.setItem("bigFont",s.checked?"1":"0"),this.applyAccessibility(),u("playSE","decide")};setTimeout(()=>{const e=document.getElementById("cbMode"),s=document.getElementById("bigFont");e&&(e.checked=localStorage.getItem("cbMode")==="1",e.addEventListener("change",t)),s&&(s.checked=localStorage.getItem("bigFont")==="1",s.addEventListener("change",t)),this.applyAccessibility()},100)},applyAccessibility(){document.body.classList.toggle("cb-mode",localStorage.getItem("cbMode")==="1"),document.body.classList.toggle("big-font",localStorage.getItem("bigFont")==="1")},cleanupDOM(){const t=document.getElementById("settingsContainer");t&&t.remove()},update(t){const{ctx:e,canvas:s}=this;Ts(e,s.width,s.height)},exit(){this.unregisterHandlers(),this.cleanupDOM(),this._removeActiveTooltip(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas&&this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler))},handleClick(t){t.preventDefault()},exit(){this.unregisterHandlers(),this.cleanupDOM(),this._removeActiveTooltip(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas&&this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler))},handleClick(t){t.preventDefault()},createButtonSection(){const t=document.createElement("div");t.className="settings-button-section";const e=document.createElement("div");e.style.position="relative",e.style.display="flex",e.style.alignItems="center",e.style.gap="10px";const s=document.createElement("button");s.className="settings-button danger",s.textContent="データリセット（はじめから）",s.addEventListener("click",()=>{u("playSE","decide"),this.resetData()});const i=document.createElement("span");i.className="tooltip-trigger",i.textContent="？",i.style.flexShrink="0",e.appendChild(s),e.appendChild(i),this._setupTooltipEvents(i,"全てのセーブデータが削除され、元に戻せなくなります。レベル、図鑑、ステージ進捗、設定など、ゲームの全ての記録が完全に消去されます。");const n=document.createElement("button");return n.className="settings-button primary",n.textContent="メインメニューへもどる",n.addEventListener("click",()=>{u("playSE","decide"),u("changeScreen","title")}),t.appendChild(e),t.appendChild(n),t},async resetData(){const t=Vt();try{if(!confirm(`【最終確認】レベル、図鑑、ステージの進捗など、全てのセーブデータが完全に削除されます。
この操作は取り消せません。よろしいですか？`)){console.log("データリセット操作がキャンセルされました（第1段階）");return}const s=prompt(`最終確認として、以下の文字を正確に入力してください：

「リセット」

※ひらがな・カタカナは区別されます`);if(s!=="リセット"){s===null?console.log("データリセット操作がキャンセルされました（第2段階）"):(alert("入力された文字が正しくありません。データリセットを中止します。"),console.log("データリセット操作が中止されました（確認ワード不一致）"));return}console.log("データリセット処理を開始します...");const i=this._showLoadingMessage("データを削除中...");try{this._clearLocalStorageData(),t!=null&&t.uid&&await this._clearFirebaseUserData(t.uid),this._resetAccessibilitySettings(),this._resetGameState(),this._hideLoadingMessage(i),console.log("データリセット処理が完了しました"),alert(`全てのデータが正常にリセットされました。
タイトル画面に戻ります。`),u("changeScreen","title")}catch(n){console.error("データリセット処理中にエラーが発生しました:",n),this._hideLoadingMessage(i),alert(`データのリセット中にエラーが発生しました。
一部のデータが削除されていない可能性があります。`)}}catch(e){console.error("データリセット処理でエラーが発生しました:",e),alert("データのリセットに失敗しました。")}},_clearLocalStorageData(){const t=[];for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e);s&&(s.startsWith("game_")||s.startsWith("kanji_")||s.startsWith("user_")||s.startsWith("progress_")||s.startsWith("level_")||s.startsWith("dex_")||s.startsWith("battle_")||s.startsWith("achievement_")||s==="bgmVolume"||s==="seVolume"||s==="cbMode"||s==="bigFont"||s==="lastPlayedStage"||s==="playerStats"||s==="unlockedStages")&&t.push(s)}t.forEach(e=>{localStorage.removeItem(e),console.log(`LocalStorage key removed: ${e}`)}),console.log(`LocalStorage cleaned: ${t.length} keys removed`)},async _clearFirebaseUserData(t){return new Promise(async(e,s)=>{try{console.log(`Firebase user data deletion started for UID: ${t}`),u("deleteUserData",t,async i=>{i&&i.success?(console.log("Firebase user data cleared successfully"),e()):(console.error("Failed to clear Firebase user data:",(i==null?void 0:i.error)||"Unknown error"),s(new Error((i==null?void 0:i.error)||"Failed to delete user data")))}),setTimeout(()=>{s(new Error("Firebase data deletion timeout"))},1e4)}catch(i){console.error("Error in _clearFirebaseUserData:",i),s(i)}})},_resetGameState(){typeof r<"u"&&r.reset&&(r.reset(),console.log("GameState has been reset")),u("resetGameState")},_resetAccessibilitySettings(){document.body.classList.remove("cb-mode"),document.body.classList.remove("big-font"),console.log("アクセシビリティ設定がリセットされました")},_showLoadingMessage(t){const e=document.createElement("div");e.id="resetLoadingMessage",e.className="reset-loading-overlay";const s=document.createElement("div");s.className="loading-message-container";const i=document.createElement("div");i.className="loading-spinner";const n=document.createElement("div");return n.className="loading-text",n.textContent=t,s.appendChild(i),s.appendChild(n),e.appendChild(s),document.body.appendChild(e),e},_hideLoadingMessage(t){t&&t.parentNode&&t.parentNode.removeChild(t)},render(){this.update(0)}};function Ks(t){return String.fromCharCode(t.charCodeAt(0)-96)}function ue(t){return t.trim().replace(/\s+/g,"").replace(/[\u30a1-\u30f6]/g,Ks)}function zs(t){const e=new Set;return t.kunyomi&&t.kunyomi.split(" ").forEach(s=>{s&&e.add(ue(s.trim()))}),t.onyomi&&t.onyomi.split(" ").forEach(s=>{s&&e.add(ue(s.trim()))}),[...e]}const Ye={canvas:null,ctx:null,inputEl:null,_keydownHandler:null,_clickHandler:null,kanjiIds:[],currentIndex:0,currentKanji:null,message:"",enter(t){var e;if(this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.kanjiIds=ot.popBatch(5).filter(s=>s!=null),this.kanjiIds.length===0){u("changeScreen","stageSelect");return}this.inputEl=document.getElementById("kanjiInput"),this.inputEl&&(this.inputEl.style.display="block",this.inputEl.value=""),this.currentIndex=0,this._loadCurrent(),this._keydownHandler=this._onKeydown.bind(this),(e=this.inputEl)==null||e.addEventListener("keydown",this._keydownHandler),this._clickHandler=s=>{const i=this.canvas.getBoundingClientRect(),n=s.clientX-i.left,a=s.clientY-i.top;n>=20&&n<=120&&a>=20&&a<=50&&(u("playSE","decide"),u("changeScreen","stageSelect"))},this.canvas.addEventListener("click",this._clickHandler)},_loadCurrent(){const t=this.kanjiIds[this.currentIndex++],e=it(t);this.currentKanji={...e,readings:zs(e)},this.message=`「${e.kanji}」をよもう！`},_onKeydown(t){if(t.key!=="Enter"||(t.preventDefault(),!this.currentKanji))return;const e=ue(this.inputEl.value);this.currentKanji.readings.includes(e)?(u("playSE","correct"),this.message="正解！",ot.updateReview(this.currentKanji.id,5)):(u("playSE","wrong"),this.message=`不正解…正答: ${this.currentKanji.readings.join("、")}`,ot.updateReview(this.currentKanji.id,1)),setTimeout(()=>{this.currentIndex<this.kanjiIds.length?(this.inputEl.value="",this._loadCurrent()):(this.inputEl.style.display="none",u("changeScreen","stageSelect"))},1e3)},update(t){const{ctx:e,canvas:s}=this;if(!this.currentKanji)return;e.fillStyle="#1e3c72",e.fillRect(0,0,s.width,s.height),e.fillStyle="white",e.font='24px "UDデジタル教科書体",sans-serif',e.fillText("復習モード",20,50),G(e,20,20,100,30,"ステージ選択");const i=s.width/2,n=s.height/2,a=180,l=180;e.strokeStyle="white",e.lineWidth=2,e.strokeRect(i-a/2,n-l/2,a,l),e.fillStyle="white",e.font="100px serif",e.textAlign="center",e.textBaseline="middle",e.fillText(this.currentKanji.kanji,i,n),e.font='20px "UDデジタル教科書体",sans-serif',e.textBaseline="top",e.fillText(this.message,i,n+l/2+10)},exit(){var t;(t=this.inputEl)==null||t.removeEventListener("keydown",this._keydownHandler),this.inputEl&&(this.inputEl.style.display="none"),this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler),this.canvas=this.ctx=this.inputEl=null}};Ye.render=function(){this.update(0)};const Ge={canvas:null,ctx:null,dexSet:null,allList:[],scroll:0,selectedKanjiId:null,_clickHandler:null,_keyHandler:null,sortMode:"default",showCollectedOnly:!1,filteredList:[],container:null,cardGrid:null,cardsPerPage:20,enter(t){this.dexSet=fe(),this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.allList=et.map(e=>e.id),this.scroll=0,this.selectedKanjiId=null,this.sortMode="default",this.showCollectedOnly=!1,this.updateFilteredList(),this.createDOMHeader(),this.createDOMContent(),this.renderKanjiCards(),this._keyHandler=e=>{if(this.selectedKanjiId&&e.key==="Escape"){this.selectedKanjiId=null,this.closeModal();return}e.key==="ArrowLeft"||e.key==="PageUp"?this.prevPage():(e.key==="ArrowRight"||e.key==="PageDown")&&this.nextPage()},window.addEventListener("keydown",this._keyHandler)},createDOMHeader(){this.container&&this.container.remove(),this.container=document.createElement("div"),this.container.id="kanjiDexContainer",this.container.className="kanji-dex-container";const t=document.createElement("div");t.className="kanji-collection-stats";const e=document.createElement("div");e.className="kanji-stats-text";const s=Math.round(this.dexSet.size/this.allList.length*100);e.textContent=`漢字収集率: ${this.dexSet.size}/${this.allList.length} (${s}%)`;const i=document.createElement("div");i.className="kanji-progress-bar";const n=document.createElement("div");n.className="kanji-progress-fill",n.style.width=`${s}%`,i.appendChild(n),t.appendChild(e),t.appendChild(i);const a=document.createElement("div");a.className="kanji-dex-navigation";const l=document.createElement("div");l.className="nav-controls-left";const o=document.createElement("button");o.textContent="📚 ステージ選択へ",o.addEventListener("click",()=>{u("playSE","decide"),u("changeScreen","stageSelect")}),l.appendChild(o);const c=document.createElement("div");c.className="nav-controls-center";const h=document.createElement("button");h.textContent="📊 学年順",h.className=this.sortMode==="grade"?"sort-active":"",h.addEventListener("click",()=>{this.sortList("grade"),this.updateNavigationButtons(),this.renderKanjiCards(),u("playSE","decide")});const f=document.createElement("button");f.textContent="✏️ 画数順",f.className=this.sortMode==="strokes"?"sort-active":"",f.addEventListener("click",()=>{this.sortList("strokes"),this.updateNavigationButtons(),this.renderKanjiCards(),u("playSE","decide")});const g=document.createElement("button");g.textContent="⭐ 習熟度順",g.className=this.sortMode==="mastery"?"sort-active":"",g.addEventListener("click",()=>{this.sortList("mastery"),this.updateNavigationButtons(),this.renderKanjiCards(),u("playSE","decide")}),c.appendChild(h),c.appendChild(f),c.appendChild(g);const m=document.createElement("div");m.className="nav-controls-right";const y=document.createElement("label");y.className="kanji-toggle-switch";const p=document.createElement("input");p.type="checkbox",p.checked=this.showCollectedOnly,p.addEventListener("change",()=>{this.toggleFilter(),this.updateNavigationButtons(),this.renderKanjiCards(),u("playSE","decide")});const k=document.createElement("span");k.className="slider";const b=document.createElement("span");b.className="toggle-label",b.textContent="収集済のみ",y.appendChild(p),y.appendChild(k),y.appendChild(b);const E=document.createElement("button");E.textContent="⬅️ 前のページ",E.addEventListener("click",()=>{this.prevPage()});const w=document.createElement("span");w.className="page-info";const B=document.createElement("button");B.textContent="次のページ ➡️",B.addEventListener("click",()=>{this.nextPage()}),m.appendChild(y),m.appendChild(E),m.appendChild(w),m.appendChild(B),a.appendChild(l),a.appendChild(c),a.appendChild(m),this.container.appendChild(t),this.container.appendChild(a),document.body.appendChild(this.container),this.updateNavigationButtons()},createDOMContent(){this.cardGrid=document.createElement("div"),this.cardGrid.id="kanjiCardGrid",this.cardGrid.className="kanji-card-grid",this.container.appendChild(this.cardGrid)},renderKanjiCards(){this.cardGrid&&(this.cardGrid.innerHTML="");const t=this.scroll,e=Math.min(t+this.cardsPerPage,this.filteredList.length);for(let s=t;s<e;s++){const i=this.filteredList[s],n=it(i),a=this._createKanjiCard(n);this.cardGrid.appendChild(a)}},_createKanjiCard(t){const e=this.dexSet.has(t.id),s=document.createElement("div");s.className="kanji-card",e||s.classList.add("locked");const i=document.createElement("h2");i.className="kanji-character",i.textContent=e?t.kanji:"？",s.appendChild(i);const n=document.createElement("div");n.className="kanji-info";const a=document.createElement("p");a.className="kanji-grade";const l=t.grade||"?";if(a.textContent=`${l}年生`,n.appendChild(a),e){const o=document.createElement("p");o.className="kanji-reading";const c=[];t.onyomi&&c.push(`音: ${t.onyomi}`),t.kunyomi&&c.push(`訓: ${t.kunyomi}`),o.textContent=c.join(" "),n.appendChild(o);const h=document.createElement("p");h.className="kanji-strokes",h.textContent=`${t.strokes}画`,n.appendChild(h);const f=document.createElement("div");f.className="kanji-mastery";const g=t.correctCount||0,m=t.incorrectCount||0,y=g+m;if(y>0){const p=g/y,k=Math.round(p*100);let b=1;p>=.9?b=3:p>=.7&&(b=2);for(let w=0;w<b;w++){const B=document.createElement("span");B.className="mastery-star",B.textContent="⭐",f.appendChild(B)}const E=document.createElement("span");E.className="mastery-accuracy",E.textContent=`${k}%`,f.appendChild(E)}else f.textContent="未挑戦";n.appendChild(f)}else{const o=document.createElement("p");o.className="kanji-locked-message",o.textContent="未収集",n.appendChild(o)}return s.appendChild(n),e&&s.addEventListener("click",()=>{this.selectedKanjiId=t.id,this.showModal(t.id),u("playSE","decide")}),s},showModal(t){const e=it(t);if(!e)return;const s=document.createElement("div");s.className="kanji-modal",s.id="kanjiModal";const i=document.createElement("div");i.className="modal-content";const n=document.createElement("button");n.className="modal-close",n.textContent="×",n.addEventListener("click",()=>{this.closeModal()}),i.appendChild(n);const a=document.createElement("h1");a.className="modal-kanji",a.textContent=e.kanji,i.appendChild(a);const l=document.createElement("div");l.className="kanji-detail-info";const o=document.createElement("div");if(o.className="kanji-basic-info",e.onyomi){const w=document.createElement("p");w.innerHTML=`<strong>音読み:</strong> ${e.onyomi}`,o.appendChild(w)}if(e.kunyomi){const w=document.createElement("p");w.innerHTML=`<strong>訓読み:</strong> ${e.kunyomi}`,o.appendChild(w)}if(e.meaning){const w=document.createElement("p");w.innerHTML=`<strong>意味:</strong> ${e.meaning}`,o.appendChild(w)}const c=document.createElement("p");c.innerHTML=`<strong>学年:</strong> ${e.grade||"?"}年 <strong>画数:</strong> ${e.strokes}画`,o.appendChild(c),l.appendChild(o);const h=document.createElement("div");h.className="kanji-stats-section";const f=document.createElement("h3");f.textContent="学習記録",h.appendChild(f);const g=e.correctCount||0,m=e.incorrectCount||0,y=g+m,p=y>0?Math.round(g/y*100):0;let k="初心者",b="#8B4513";p>=90?(k="マスター",b="#DAA520"):p>=70?(k="上級者",b="#CD853F"):p>=50&&(k="中級者",b="#D2B48C");const E=document.createElement("p");if(E.className="mastery-level",E.innerHTML=`<strong>習熟度:</strong> <span style="color:${b}">${k}</span>`,h.appendChild(E),y>0){const w=document.createElement("div");w.className="stats-details";const B=document.createElement("p");B.innerHTML=`<strong>挑戦回数:</strong> ${y}回`,w.appendChild(B);const P=document.createElement("p");P.innerHTML=`<strong>正答率:</strong> ${p}%`,w.appendChild(P);const T=document.createElement("div");T.className="accuracy-graph-container";const A=document.createElement("div");A.className="accuracy-graph";const I=document.createElement("div");I.className="correct-bar",I.style.width=`${p}%`,I.textContent=`正解: ${g}`,A.appendChild(I);const R=document.createElement("div");R.className="incorrect-bar",R.style.width=`${100-p}%`,R.textContent=`不正解: ${m}`,A.appendChild(R),T.appendChild(A),w.appendChild(T),h.appendChild(w)}else{const w=document.createElement("p");w.textContent="まだ挑戦記録がありません",h.appendChild(w)}l.appendChild(h),i.appendChild(l),s.appendChild(i),document.body.appendChild(s),s.addEventListener("click",w=>{w.target===s&&this.closeModal()})},closeModal(){const t=document.getElementById("kanjiModal");t&&t.remove(),this.selectedKanjiId=null,u("playSE","cancel")},prevPage(){this.scroll<=0||(this.scroll=Math.max(0,this.scroll-this.cardsPerPage),this.updateNavigationButtons(),this.renderKanjiCards(),u("playSE","decide"))},nextPage(){const t=Math.max(0,this.filteredList.length-this.cardsPerPage);this.scroll>=t||(this.scroll=Math.min(t,this.scroll+this.cardsPerPage),this.updateNavigationButtons(),this.renderKanjiCards(),u("playSE","decide"))},updateNavigationButtons(){var l,o,c;if(!this.container)return;const t=this.container.querySelector(".page-info");if(t){const h=Math.floor(this.scroll/this.cardsPerPage)+1,f=Math.ceil(this.filteredList.length/this.cardsPerPage);t.textContent=`${h} / ${f}`}const e=this.container.querySelector(".nav-controls-right button:first-of-type"),s=this.container.querySelector(".nav-controls-right button:last-of-type");if(e&&(e.disabled=this.scroll<=0),s){const h=Math.max(0,this.filteredList.length-this.cardsPerPage);s.disabled=this.scroll>=h}const i=this.container.querySelectorAll(".nav-controls-center button");i.forEach(h=>h.classList.remove("sort-active")),this.sortMode==="grade"?(l=i[0])==null||l.classList.add("sort-active"):this.sortMode==="strokes"?(o=i[1])==null||o.classList.add("sort-active"):this.sortMode==="mastery"&&((c=i[2])==null||c.classList.add("sort-active"));const n=this.container.querySelector(".kanji-stats-text"),a=this.container.querySelector(".kanji-progress-fill");if(n&&a){const h=Math.round(this.dexSet.size/this.allList.length*100);this.showCollectedOnly?n.textContent=`表示中: ${this.filteredList.length} / 収集済: ${this.dexSet.size} (${h}%)`:n.textContent=`漢字収集率: ${this.dexSet.size}/${this.allList.length} (${h}%)`,a.style.width=`${h}%`}},update(t){const{ctx:e,canvas:s}=this;e.fillStyle="#2c1810",e.fillRect(0,0,s.width,s.height),e.fillStyle="rgba(139, 69, 19, 0.1)";for(let i=0;i<10;i++)for(let n=0;n<10;n++)(i+n)%2===0&&e.fillRect(i*80,n*60,40,30)},exit(){this.container&&(this.container.remove(),this.container=null),this.closeModal(),this._keyHandler&&window.removeEventListener("keydown",this._keyHandler),this.canvas=this.ctx=null,this.selectedKanjiId=null},sortList(t){switch(this.sortMode=t,t){case"grade":this.allList.sort((e,s)=>{const i=it(e),n=it(s),a=i.grade||999,l=n.grade||999;return a-l});break;case"strokes":this.allList.sort((e,s)=>{const i=it(e),n=it(s),a=i.strokes||999,l=n.strokes||999;return a-l});break;case"mastery":this.allList.sort((e,s)=>{const i=it(e),n=it(s),a=i.correctCount||0,l=i.incorrectCount||0,o=a+l,c=o>0?a/o:0,h=n.correctCount||0,f=n.incorrectCount||0,g=h+f;return(g>0?h/g:0)-c});break;default:this.allList=et.map(e=>e.id);break}this.scroll=0,this.updateFilteredList()},updateFilteredList(){this.showCollectedOnly?this.filteredList=this.allList.filter(t=>this.dexSet.has(t)):this.filteredList=[...this.allList]},toggleFilter(){this.showCollectedOnly=!this.showCollectedOnly,this.scroll=0,this.updateFilteredList()}};Ge.render=function(){this.update(0)};const Kt={1:"grade1-hokkaido",2:"grade2-touhoku",3:"grade3-kantou",4:"grade4-chuubu",5:"grade5-kinki",6:"grade6-chuugoku"},zt={1:"北海道",2:"東北",3:"関東",4:"中部",5:"近畿",6:"中国"},Oe=new IntersectionObserver(t=>{t.forEach(e=>{if(e.isIntersecting){const s=e.target.querySelector("img");s.src=s.dataset.thumb,Oe.unobserve(e.target)}})},{rootMargin:"200px"});function Vs(t){const e=document.createElement("div");e.classList.add("monster-card"),t.collected||e.classList.add("locked"),e.addEventListener("click",()=>{if(t.collected){Zs(t),_s(t.id);const o=e.querySelector(".new-badge");o&&o.remove()}});const s=document.createElement("img"),n=`/assets/images/monsters/thumb/${Kt[t.grade]||Kt[1]}/${t.id}.webp`;s.dataset.thumb=n,s.alt=t.name,e.appendChild(s);const a=document.createElement("p");a.textContent=t.collected?t.name:"？？？",a.classList.add("monster-name"),e.appendChild(a);const l=document.createElement("p");if(l.textContent=t.collected?t.prefecture||zt[t.grade]||"不明":"？？？",l.classList.add("monster-prefecture"),e.appendChild(l),As(t.id)){const o=document.createElement("div");o.classList.add("new-badge"),o.textContent="NEW!",e.appendChild(o)}return Oe.observe(e),e}function Zs(t){const e=document.createElement("div");e.classList.add("monster-modal");const s=document.createElement("div");s.classList.add("modal-content");const i=document.createElement("button");i.classList.add("modal-close"),i.textContent="×",i.onclick=()=>e.remove();const n=document.createElement("img"),a=Kt[t.grade]||Kt[1];n.src=`/assets/images/monsters/thumb/${a}/${t.id}.webp`,n.alt=t.name,n.classList.add("modal-monster-image");const l=document.createElement("div");l.classList.add("monster-info"),l.innerHTML=`
    <h2>${t.name}</h2>
    <p><strong>学年:</strong> ${t.grade}年生</p>
    <p><strong>地方:</strong> ${zt[t.grade]||"不明"}</p>
    <p><strong>生息地:</strong> ${t.prefecture||zt[t.grade]||"不明"}</p>
    <p><strong>読み:</strong> ${t.reading||"不明"}</p>
    <p><strong>意味:</strong> ${t.meaning||"詳細情報なし"}</p>
  `,s.appendChild(i),s.appendChild(n),s.appendChild(l),e.appendChild(s),e.onclick=o=>{o.target===e&&e.remove()},document.body.appendChild(e),u("playSE","decide")}const qs={canvas:null,dexSet:null,seenSet:null,allMonsterIds:[],filteredMonsterIds:[],itemsPerPage:15,currentPage:0,totalPages:0,currentRegionFilter:"all",currentSortOrder:"id",enter(t){this.canvas=t||document.getElementById("gameCanvas"),this.canvas.style.display="none",this.dexSet=qt(),this.seenSet=ye(),this.allMonsterIds=vs(),this.applyFiltersAndSort(),this.currentPage=0,this.renderPage()},calculateRegionCompletion(){const t={};for(let e=1;e<=6;e++){const s=this.allMonsterIds.filter(n=>{const a=bt(n);return a&&a.grade===e}),i=s.filter(n=>this.dexSet.has(n));t[e]={total:s.length,collected:i.length,isComplete:s.length>0&&i.length===s.length}}return t},applyFiltersAndSort(){let t=this.allMonsterIds;this.currentRegionFilter!=="all"&&(t=this.allMonsterIds.filter(e=>{const s=bt(e);return s&&s.grade===this.currentRegionFilter})),this.currentSortOrder==="name"?t.sort((e,s)=>{const i=bt(e),n=bt(s);return!i||!n?0:i.name.localeCompare(n.name,"ja")}):t.sort((e,s)=>e.localeCompare(s)),this.filteredMonsterIds=t,this.totalPages=Math.ceil(this.filteredMonsterIds.length/this.itemsPerPage)},renderPage(){const t=document.getElementById("monsterContainer");if(!t)return;t.innerHTML="",t.style.display="grid";const e=this.calculateRegionCompletion(),s=document.createElement("div");s.className="collection-stats";const i=this.dexSet.size,n=this.allMonsterIds.length,a=n>0?Math.round(i/n*100):0,l=document.createElement("div");l.className="stats-text",l.textContent=`収集率: ${a}% (${i} / ${n})`;const o=document.createElement("div");o.className="progress-bar";const c=document.createElement("div");c.className="progress-fill",c.style.width=`${a}%`,o.appendChild(c),s.appendChild(l),s.appendChild(o),t.appendChild(s);const h=document.createElement("div");h.className="dex-navigation";const f=document.createElement("button");f.textContent="ステージ選択へ",f.onclick=()=>u("changeScreen","stageSelect");const g=document.createElement("select");g.className="region-filter";let m='<option value="all">すべて表示</option>';for(let R=1;R<=6;R++){const L=zt[R],wt=e[R].isComplete?" 👑":"";m+=`<option value="${R}">${L}${wt}</option>`}g.innerHTML=m,g.value=this.currentRegionFilter,g.onchange=R=>{this.currentRegionFilter=R.target.value==="all"?"all":parseInt(R.target.value),this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),u("playSE","decide")};const y=document.createElement("button");y.textContent="図鑑番号順",y.className=this.currentSortOrder==="id"?"sort-active":"",y.onclick=()=>{this.currentSortOrder="id",this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),u("playSE","decide")};const p=document.createElement("button");p.textContent="五十音順",p.className=this.currentSortOrder==="name"?"sort-active":"",p.onclick=()=>{this.currentSortOrder="name",this.applyFiltersAndSort(),this.currentPage=0,this.renderPage(),u("playSE","decide")};const k=document.createElement("button");k.textContent="前のページ",k.disabled=this.currentPage===0,k.onclick=()=>this.changePage(this.currentPage-1);const b=document.createElement("span");b.className="page-info",b.textContent=`${this.currentPage+1} / ${this.totalPages} ページ`;const E=document.createElement("button");E.textContent="次のページ",E.disabled=this.currentPage>=this.totalPages-1,E.onclick=()=>this.changePage(this.currentPage+1);const w=document.createElement("div");w.className="nav-controls-left",w.appendChild(f),w.appendChild(g);const B=document.createElement("div");B.className="nav-controls-center",B.appendChild(y),B.appendChild(p);const P=document.createElement("div");P.className="nav-controls-right",P.appendChild(k),P.appendChild(b),P.appendChild(E),h.appendChild(w),h.appendChild(B),h.appendChild(P),t.appendChild(h);const T=this.currentPage*this.itemsPerPage,A=T+this.itemsPerPage;this.filteredMonsterIds.slice(T,A).forEach(R=>{const L=bt(R);if(L){L.collected=this.dexSet.has(R);const q=Vs(L);t.appendChild(q)}})},changePage(t){t>=0&&t<this.totalPages&&(this.currentPage=t,this.renderPage(),u("playSE","decide"))},exit(){const t=document.getElementById("monsterContainer");t&&(t.style.display="none",t.innerHTML="");const e=document.querySelector(".monster-modal");e&&e.remove(),this.canvas&&(this.canvas.style.display="")},update(t){},render(){}},oe={x:300,y:480,width:200,height:50,text:"ステージ選択へ"},Ue={canvas:null,ctx:null,_clickHandler:null,_mousemoveHandler:null,mouseX:0,mouseY:0,animationTime:0,resultData:null,async enter(t,e){this.resultData=e||{correct:r.correctKanjiList||[],wrong:r.wrongKanjiList||[],time:d.timeRemaining||0,playerHp:r.playerStats.hp||0};try{await Ft()}catch(s){console.error("実績チェック中にエラーが発生しました:",s)}if(u("playBGM","victory"),ss(),r.playerStats.stagesCleared++,d.mistakesThisStage===0?(r.justClearedPerfectly=!0,console.log("🏆 パーフェクトクリア達成！")):r.justClearedPerfectly=!1,this.canvas=t||document.getElementById("gameCanvas"),!this.canvas){console.error("キャンバス要素が見つかりません");return}this.ctx=this.canvas.getContext("2d"),u("playSE","victory"),this.animationTime=0,this.registerHandlers()},update(t){if(!this.ctx||!this.canvas)return;const{ctx:e,canvas:s}=this;this.animationTime+=16,e.clearRect(0,0,s.width,s.height),this.drawParchmentBackground(e,s.width,s.height),this.drawDecorativeTitle(e,s.width/2,120),r.justClearedPerfectly&&this.drawPerfectClearCrown(e,s.width/2+200,80),this.drawResultPanel(e,s.width/2-150,200,300,180);const i=C(this.mouseX,this.mouseY,oe);this.drawRichButton(e,oe,i),r.wrongKanjiList&&r.wrongKanjiList.length>0&&this.drawMistakeScrollPanel(e,50,420,250,150)},drawParchmentBackground(t,e,s){t.save();const i=t.createLinearGradient(0,0,e,s);i.addColorStop(0,"#F5DEB3"),i.addColorStop(.3,"#F0E68C"),i.addColorStop(.7,"#DDD8B8"),i.addColorStop(1,"#D2B48C"),t.fillStyle=i,t.fillRect(0,0,e,s),t.fillStyle="rgba(139, 69, 19, 0.05)";for(let n=0;n<200;n++){const a=Math.random()*e,l=Math.random()*s,o=Math.random()*3+1;t.beginPath(),t.arc(a,l,o,0,Math.PI*2),t.fill()}t.fillStyle="rgba(160, 82, 45, 0.08)";for(let n=0;n<50;n++){const a=Math.random()*e,l=Math.random()*s,o=Math.random()*20+10;t.beginPath(),t.arc(a,l,o,0,Math.PI*2),t.fill()}t.strokeStyle="rgba(139, 69, 19, 0.3)",t.lineWidth=8,t.strokeRect(10,10,e-20,s-20),t.strokeStyle="rgba(160, 82, 45, 0.2)",t.lineWidth=4,t.strokeRect(15,15,e-30,s-30),t.restore()},drawDecorativeTitle(t,e,s){t.save();const i=400,n=60,a=t.createLinearGradient(e-i/2,s-n/2,e+i/2,s+n/2);a.addColorStop(0,"#DAA520"),a.addColorStop(.5,"#FFD700"),a.addColorStop(1,"#B8860B"),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(e-i/2+5,s-n/2+5,i,n),t.fillStyle=a,t.fillRect(e-i/2,s-n/2,i,n),t.strokeStyle="#8B4513",t.lineWidth=3,t.strokeRect(e-i/2,s-n/2,i,n),t.font='bold 42px "UDデジタル教科書体", serif',t.textAlign="center",t.textBaseline="middle",t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillText("ステージクリア！",e+3,s+3);const l=t.createLinearGradient(e,s-20,e,s+20);l.addColorStop(0,"#FFFACD"),l.addColorStop(.5,"#FFD700"),l.addColorStop(1,"#DAA520"),t.fillStyle=l,t.fillText("ステージクリア！",e,s),t.strokeStyle="#8B4513",t.lineWidth=2,t.strokeText("ステージクリア！",e,s),t.font='24px "UDデジタル教科書体", sans-serif',t.fillStyle="#8B4513",t.fillText("おめでとうございます！",e,s+50),t.restore()},drawPerfectClearCrown(t,e,s){t.save();const i=1+.1*Math.sin(this.animationTime*.005),n=this.animationTime*.002;t.translate(e,s),t.rotate(n),t.scale(i,i),t.fillStyle="rgba(0, 0, 0, 0.3)",t.beginPath(),t.moveTo(2,12),t.lineTo(-18,-8),t.lineTo(-8,-18),t.lineTo(2,-8),t.lineTo(12,-18),t.lineTo(22,-8),t.closePath(),t.fill();const a=t.createLinearGradient(0,-20,0,10);a.addColorStop(0,"#FFD700"),a.addColorStop(.5,"#FFA500"),a.addColorStop(1,"#DAA520"),t.fillStyle=a,t.beginPath(),t.moveTo(0,10),t.lineTo(-20,-10),t.lineTo(-10,-20),t.lineTo(0,-10),t.lineTo(10,-20),t.lineTo(20,-10),t.closePath(),t.fill(),t.strokeStyle="#B8860B",t.lineWidth=2,t.stroke(),t.fillStyle="#FF1493",t.beginPath(),t.arc(0,-5,4,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.7)",t.beginPath(),t.arc(-1,-7,2,0,Math.PI*2),t.fill(),t.restore(),t.save(),t.font='bold 20px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillStyle="#FF6347",t.fillText("PERFECT!",e,s+40),t.restore()},drawResultPanel(t,e,s,i,n){t.save(),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(e+5,s+5,i,n);const a=t.createLinearGradient(e,s,e,s+n);a.addColorStop(0,"#DEB887"),a.addColorStop(.5,"#D2B48C"),a.addColorStop(1,"#BC9A6A"),t.fillStyle=a,t.fillRect(e,s,i,n),t.strokeStyle="#8B4513",t.lineWidth=3,t.strokeRect(e,s,i,n),t.strokeStyle="#A0522D",t.lineWidth=1,t.strokeRect(e+5,s+5,i-10,n-10),t.font='bold 24px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillStyle="#8B4513",t.fillText("戦績",e+i/2,s+30);const l=[`正解数: ${r.correctKanjiList?r.correctKanjiList.length:0}`,`間違い: ${r.wrongKanjiList?r.wrongKanjiList.length:0}`,`現在レベル: ${r.playerStats.level}`,`総ステージクリア: ${r.playerStats.stagesCleared}`];t.font='18px "UDデジタル教科書体", sans-serif',t.textAlign="left",t.fillStyle="#654321",l.forEach((o,c)=>{t.fillText(o,e+20,s+70+c*25)}),r.justClearedPerfectly&&(t.font='bold 16px "UDデジタル教科書体", sans-serif',t.fillStyle="#FF6347",t.textAlign="center",t.fillText("✨ パーフェクトクリア ✨",e+i/2,s+n-15)),t.restore()},drawRichButton(t,e,s){t.save();const{x:i,y:n,width:a,height:l,text:o}=e,c=s?1.05:1,h=a*c,f=l*c,g=i+(a-h)/2,m=n+(l-f)/2;t.fillStyle="rgba(0, 0, 0, 0.4)",t.fillRect(g+4,m+4,h,f);const y=t.createLinearGradient(g,m,g,m+f);s?(y.addColorStop(0,"#32CD32"),y.addColorStop(.5,"#228B22"),y.addColorStop(1,"#006400")):(y.addColorStop(0,"#228B22"),y.addColorStop(.5,"#006400"),y.addColorStop(1,"#004000")),t.fillStyle=y,t.fillRect(g,m,h,f),t.strokeStyle=s?"#FFD700":"#8B4513",t.lineWidth=s?3:2,t.strokeRect(g,m,h,f);const p=t.createLinearGradient(g,m,g,m+f*.3);p.addColorStop(0,"rgba(255, 255, 255, 0.3)"),p.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=p,t.fillRect(g,m,h,f*.3),t.font='bold 20px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillText(o,g+h/2+2,m+f/2+2),t.fillStyle=s?"#FFFACD":"white",t.fillText(o,g+h/2,m+f/2),t.restore()},drawMistakeScrollPanel(t,e,s,i,n){if(!r.wrongKanjiList||r.wrongKanjiList.length===0)return;t.save(),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(e+3,s+3,i,n);const a=t.createLinearGradient(e,s,e+i,s);a.addColorStop(0,"#F5E6D3"),a.addColorStop(.5,"#E6D3C1"),a.addColorStop(1,"#D3C1A8"),t.fillStyle=a,t.fillRect(e,s,i,n),t.strokeStyle="#8B4513",t.lineWidth=2,t.strokeRect(e,s,i,n),t.fillStyle="#A0522D",t.fillRect(e,s,i,8),t.fillRect(e,s+n-8,i,8),t.font='bold 16px "UDデジタル教科書体", sans-serif',t.textAlign="left",t.fillStyle="#8B4513",t.fillText("復習が必要な漢字:",e+10,s+25),t.font='14px "UDデジタル教科書体", sans-serif',t.fillStyle="#654321";const l=Math.min(r.wrongKanjiList.length,4);for(let o=0;o<l;o++){const c=r.wrongKanjiList[o],h=`${c.text||c}（${c.meaning||""}）`;t.fillText(h,e+15,s+50+o*20)}r.wrongKanjiList.length>4&&(t.fillStyle="#A0522D",t.fillText(`...他${r.wrongKanjiList.length-4}個`,e+15,s+130)),t.restore()},exit(){this.canvas&&this.unregisterHandlers(),this.canvas=null,this.ctx=null,this.resultData=null},registerHandlers(){this.canvas&&(this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler))},unregisterHandlers(){this.canvas&&(this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)),this._mousemoveHandler&&this.canvas.removeEventListener("mousemove",this._mousemoveHandler),this._clickHandler=null,this._mousemoveHandler=null)},handleMouseMove(t){if(!this.canvas)return;const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height;this.mouseX=(t.clientX-e.left)*s,this.mouseY=(t.clientY-e.top)*i},handleClick(t){if(!this.canvas)return;t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a;C(l,o,oe)&&(u("playSE","decide"),u("changeScreen","stageSelect"))}};Ue.render=function(){this.update(0)};const re={x:250,y:420,width:140,height:50,text:"リトライ"},ce={x:410,y:420,width:140,height:50,text:"タイトルへ"},Js={canvas:null,ctx:null,_clickHandler:null,_mousemoveHandler:null,mouseX:0,mouseY:0,animationTime:0,enter(){if(u("playBGM","gameover"),this.canvas=document.getElementById("gameCanvas"),!this.canvas){console.error("キャンバス要素が見つかりません");return}this.ctx=this.canvas.getContext("2d"),u("playSE","gameover"),this.animationTime=0,this.registerHandlers()},update(t){if(!this.ctx||!this.canvas)return;const{ctx:e,canvas:s}=this;this.animationTime+=16,e.clearRect(0,0,s.width,s.height),this.drawStormyBackground(e,s.width,s.height),this.drawCrackedTitle(e,s.width/2,120),this.drawWeatheredResultPanel(e,s.width/2-150,220,300,160);const i=C(this.mouseX,this.mouseY,re),n=C(this.mouseX,this.mouseY,ce);this.drawSomberButton(e,re,i,"retry"),this.drawSomberButton(e,ce,n,"title"),this.drawDespairEffects(e,s.width,s.height)},drawStormyBackground(t,e,s){t.save();const i=t.createLinearGradient(0,0,0,s);i.addColorStop(0,"#2C3E50"),i.addColorStop(.3,"#34495E"),i.addColorStop(.7,"#1C2833"),i.addColorStop(1,"#17202A"),t.fillStyle=i,t.fillRect(0,0,e,s);const n=this.animationTime*.001%(e+100);t.fillStyle="rgba(44, 62, 80, 0.3)";for(let a=0;a<5;a++){const l=(n+a*200-100)%(e+200)-100,o=50+a*30,c=40+a*10;t.beginPath(),t.arc(l,o,c,0,Math.PI*2),t.arc(l+30,o,c*.8,0,Math.PI*2),t.arc(l+60,o,c*.6,0,Math.PI*2),t.fill()}t.fillStyle="rgba(85, 85, 85, 0.4)";for(let a=0;a<300;a++){const l=Math.random()*e,o=Math.random()*s,c=Math.random()*2+.5;t.beginPath(),t.arc(l,o,c,0,Math.PI*2),t.fill()}t.strokeStyle="rgba(169, 169, 169, 0.3)",t.lineWidth=1;for(let a=0;a<8;a++){t.beginPath();const l=Math.random()*e,o=Math.random()*s;let c=l,h=o;t.moveTo(c,h);for(let f=0;f<5;f++)c+=(Math.random()-.5)*100,h+=(Math.random()-.5)*100,t.lineTo(c,h);t.stroke()}t.strokeStyle="rgba(105, 105, 105, 0.5)",t.lineWidth=6,t.strokeRect(8,8,e-16,s-16),t.strokeStyle="rgba(128, 128, 128, 0.3)",t.lineWidth=3,t.strokeRect(12,12,e-24,s-24),t.restore()},drawCrackedTitle(t,e,s){t.save(),t.font='bold 48px "UDデジタル教科書体", serif',t.textAlign="center",t.textBaseline="middle",t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillText("ゲームオーバー",e+4,s+4);const i=t.createLinearGradient(e-150,s-25,e+150,s+25);i.addColorStop(0,"#8B0000"),i.addColorStop(.5,"#DC143C"),i.addColorStop(1,"#B22222"),t.fillStyle=i,t.fillText("ゲームオーバー",e,s),t.strokeStyle="#2F4F4F",t.lineWidth=2,t.strokeText("ゲームオーバー",e,s),t.strokeStyle="rgba(105, 105, 105, 0.6)",t.lineWidth=1,t.beginPath(),t.moveTo(e-120,s-10),t.lineTo(e-80,s+5),t.lineTo(e-40,s-8),t.moveTo(e+20,s+8),t.lineTo(e+60,s-5),t.lineTo(e+100,s+10),t.stroke(),t.font='24px "UDデジタル教科書体", sans-serif',t.fillStyle="#696969",t.fillText("チャレンジ失敗...",e,s+50),t.fillStyle="rgba(169, 169, 169, 0.4)";for(let n=0;n<6;n++){const a=Math.PI*2*n/6,l=80+Math.sin(this.animationTime*.003+n)*10,o=e+Math.cos(a)*l,c=s+Math.sin(a)*l,h=3+Math.random()*2;t.beginPath(),t.arc(o,c,h,0,Math.PI*2),t.fill()}t.restore()},drawWeatheredResultPanel(t,e,s,i,n){t.save(),t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(e+6,s+6,i,n);const a=t.createLinearGradient(e,s,e,s+n);a.addColorStop(0,"#708090"),a.addColorStop(.3,"#696969"),a.addColorStop(.7,"#556B2F"),a.addColorStop(1,"#2F4F4F"),t.fillStyle=a,t.fillRect(e,s,i,n),t.strokeStyle="#2F2F2F",t.lineWidth=4,t.strokeRect(e,s,i,n),t.strokeStyle="#A9A9A9",t.lineWidth=1,t.strokeRect(e+8,s+8,i-16,n-16),t.strokeStyle="rgba(169, 169, 169, 0.5)",t.lineWidth=2,t.beginPath(),t.moveTo(e+20,s+n*.3),t.lineTo(e+i-30,s+n*.7),t.moveTo(e+i*.7,s+15),t.lineTo(e+i*.3,s+n-20),t.stroke(),t.font='bold 22px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.fillStyle="#F5F5DC",t.fillText("戦績",e+i/2,s+35);const l=[`正解した漢字: ${r.correctKanjiList.length}個`,`間違えた漢字: ${r.wrongKanjiList.length}個`,`現在レベル: ${r.playerStats.level}`,`挑戦回数: ${r.playerStats.totalAttempts||1}`];t.font='16px "UDデジタル教科書体", sans-serif',t.textAlign="left",t.fillStyle="#DCDCDC",l.forEach((o,c)=>{t.fillText(o,e+20,s+70+c*22)}),t.font='italic 14px "UDデジタル教科書体", sans-serif',t.fillStyle="#CD5C5C",t.textAlign="center",t.fillText("次こそは勝利を掴もう...",e+i/2,s+n-15),t.restore()},drawSomberButton(t,e,s,i){t.save();const{x:n,y:a,width:l,height:o,text:c}=e,h=s?1.05:1,f=l*h,g=o*h,m=n+(l-f)/2,y=a+(o-g)/2;t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(m+5,y+5,f,g);const p=t.createLinearGradient(m,y,m,y+g);i==="retry"?s?(p.addColorStop(0,"#4682B4"),p.addColorStop(.5,"#2F4F4F"),p.addColorStop(1,"#191970")):(p.addColorStop(0,"#2F4F4F"),p.addColorStop(.5,"#191970"),p.addColorStop(1,"#0F0F23")):s?(p.addColorStop(0,"#A0522D"),p.addColorStop(.5,"#8B4513"),p.addColorStop(1,"#654321")):(p.addColorStop(0,"#8B4513"),p.addColorStop(.5,"#654321"),p.addColorStop(1,"#2F1B14")),t.fillStyle=p,t.fillRect(m,y,f,g),t.strokeStyle=s?"#696969":"#2F2F2F",t.lineWidth=s?3:2,t.strokeRect(m,y,f,g),s||(t.strokeStyle="rgba(169, 169, 169, 0.3)",t.lineWidth=1,t.beginPath(),t.moveTo(m+10,y+g*.3),t.lineTo(m+f-10,y+g*.7),t.stroke());const k=t.createLinearGradient(m,y,m,y+g*.3);k.addColorStop(0,"rgba(255, 255, 255, 0.1)"),k.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=k,t.fillRect(m,y,f,g*.3),t.font='bold 18px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillText(c,m+f/2+2,y+g/2+2),t.fillStyle=s?"#F5F5DC":"#DCDCDC",t.fillText(c,m+f/2,y+g/2),t.restore()},drawDespairEffects(t,e,s){t.save(),t.fillStyle="rgba(169, 169, 169, 0.3)";for(let n=0;n<20;n++){const a=(this.animationTime*.02+n*40)%e,l=(this.animationTime*.05+n*30)%s,o=1+Math.random()*2;t.beginPath(),t.arc(a,l,o,0,Math.PI*2),t.fill()}const i=t.createRadialGradient(e/2,s/2,0,e/2,s/2,Math.max(e,s)*.7);i.addColorStop(0,"rgba(0, 0, 0, 0)"),i.addColorStop(1,"rgba(0, 0, 0, 0.4)"),t.fillStyle=i,t.fillRect(0,0,e,s),t.restore()},exit(){this.canvas&&this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this.canvas&&(this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler))},unregisterHandlers(){this.canvas&&(this._clickHandler&&(this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)),this._mousemoveHandler&&this.canvas.removeEventListener("mousemove",this._mousemoveHandler),this._clickHandler=null,this._mousemoveHandler=null)},handleMouseMove(t){if(!this.canvas)return;const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height;this.mouseX=(t.clientX-e.left)*s,this.mouseY=(t.clientY-e.top)*i},handleClick(t){if(!this.canvas)return;t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a;C(l,o,re)&&(u("playSE","decide"),u("changeScreen",r.currentStageId)),C(l,o,ce)&&(u("playSE","decide"),u("changeScreen","title"))},render(){this.update(0)}},Qs={canvas:null,ctx:null,finalScore:0,correctCount:0,wrongCount:0,ranking:[],enter(t,e){if(this.canvas=t||document.getElementById("gameCanvas"),!this.canvas){console.error("Canvas element not found!");return}if(this.ctx=this.canvas.getContext("2d"),!this.ctx){console.error("Canvas context not available!");return}const s=e||{correct:r.correctKanjiList||[],wrong:r.wrongKanjiList||[],time:0,playerHp:r.playerStats.hp};this.correctCount=s.correct.length,this.wrongCount=s.wrong.length;let i=this.correctCount*10,n=s.playerHp||0,a=0;r.gameMode==="challenge"&&s.time>0&&(a=s.time*2),this.finalScore=i+n+a;const l=this.canvas.width/2;this.retryButton={x:l-150,y:400,width:300,height:50,text:"もう一度プレイ"},this.titleButton={x:l-150,y:470,width:300,height:50,text:"タイトルへもどる"},this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.updateRanking()},update(t){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.font="48px sans-serif",this.ctx.fillText("結果発表",this.canvas.width/2,80),this.ctx.font="32px sans-serif",this.ctx.fillText(`スコア: ${this.finalScore} 点`,this.canvas.width/2,150),this.ctx.font="24px sans-serif",this.ctx.fillText(`正解数: ${this.correctCount}`,this.canvas.width/2,200),this.ctx.fillText(`不正解数: ${this.wrongCount}`,this.canvas.width/2,230),this.ctx.font="28px sans-serif",this.ctx.fillText("ランキング",this.canvas.width/2,280),this.ranking.forEach((e,s)=>{this.ctx.font="22px sans-serif";const i=`${s+1}位: ${e.score}点 (${new Date(e.date).toLocaleDateString()})`;this.ctx.fillText(i,this.canvas.width/2,320+s*30)}),G(this.ctx,this.retryButton.x,this.retryButton.y,this.retryButton.width,this.retryButton.height,this.retryButton.text),G(this.ctx,this.titleButton.x,this.titleButton.y,this.titleButton.width,this.titleButton.height,this.titleButton.text)},exit(){this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler)},handleClick(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;C(s,i,this.retryButton)&&u("changeScreen","stageSelect"),C(s,i,this.titleButton)&&u("changeScreen","title")},updateRanking(){const t=localStorage.getItem("kanjiBattleScores"),e=t?JSON.parse(t):[];e.push({score:this.finalScore,date:new Date().toISOString()}),e.sort((i,n)=>n.score-i.score);const s=e.slice(0,5);localStorage.setItem("kanjiBattleScores",JSON.stringify(s)),this.ranking=s},render(){this.update(0)}},ti={canvas:null,ctx:null,_clickHandler:null,hpUpgradeButton:null,attackUpgradeButton:null,backButton:null,enter(t){this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const e=this.canvas.width/2;this.hpUpgradeButton={x:e-180,y:300,width:160,height:50,text:"HP+10 (SP:1)",cost:1,stat:"maxHp",increase:10},this.attackUpgradeButton={x:e+20,y:300,width:160,height:50,text:"攻撃+2 (SP:1)",cost:1,stat:"attack",increase:2},this.backButton={x:e-100,y:400,width:200,height:50,text:"メニューに戻る"},this.registerHandlers()},update(t){const{ctx:e,canvas:s}=this,i=r.playerStats;e.clearRect(0,0,s.width,s.height),e.fillStyle="black",e.fillRect(0,0,s.width,s.height),e.fillStyle="white",e.font='36px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillText("プレイヤーステータス",s.width/2,80),r.playerName&&(e.font='24px "UDデジタル教科書体", sans-serif',e.fillText(`${r.playerName}`,s.width/2,120)),e.font='20px "UDデジタル教科書体", sans-serif',e.textAlign="left";const n=s.width/2-120,a=160,l=30;e.fillText(`レベル: ${i.level}`,n,a),e.fillText(`HP: ${i.hp} / ${i.maxHp}`,n,a+l),e.fillText(`攻撃力: ${i.attack}`,n,a+l*2),e.fillStyle=i.skillPoints>0?"#FFD700":"white",e.font='22px "UDデジタル教科書体", sans-serif',e.fillText(`スキルポイント: ${i.skillPoints}`,n,a+l*3),i.skillPoints===0&&(e.fillStyle="#888888",e.font='16px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillText("レベルアップでスキルポイントを獲得できます",s.width/2,a+l*4.5)),this.drawUpgradeButton(this.hpUpgradeButton,i.skillPoints>=this.hpUpgradeButton.cost),this.drawUpgradeButton(this.attackUpgradeButton,i.skillPoints>=this.attackUpgradeButton.cost),e.fillStyle="white",G(e,this.backButton.x,this.backButton.y,this.backButton.width,this.backButton.height,this.backButton.text,"#34495e")},drawUpgradeButton(t,e){const{ctx:s}=this,i=e?"#27ae60":"#95a5a6";S.buttonNormal&&e&&s.drawImage(S.buttonNormal,t.x,t.y,t.width,t.height),G(s,t.x,t.y,t.width,t.height,t.text,i),e||(s.fillStyle="rgba(0, 0, 0, 0.3)",s.fillRect(t.x,t.y,t.width,t.height))},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler)},unregisterHandlers(){this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler)},handleClick(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,n=r.playerStats;if(C(s,i,this.hpUpgradeButton)&&n.skillPoints>=this.hpUpgradeButton.cost){this.upgradeStatus(this.hpUpgradeButton),u("playSE","correct");return}if(C(s,i,this.attackUpgradeButton)&&n.skillPoints>=this.attackUpgradeButton.cost){this.upgradeStatus(this.attackUpgradeButton),u("playSE","correct");return}if(C(s,i,this.backButton)){u("changeScreen","menu");return}},upgradeStatus(t){const e=r.playerStats;e.skillPoints-=t.cost,e.skillPointsUsed+=t.cost,e[t.stat]+=t.increase,t.stat==="maxHp"&&(e.hp+=t.increase),Ft().catch(s=>{console.error("実績チェック中にエラーが発生しました:",s)}),console.log(`${t.stat} を ${t.increase} 上昇させました。残りSP: ${e.skillPoints}`)}},W={back:{x:20,y:20,w:100,h:30,label:"メニューへ"},prevPage:{x:580,y:500,w:100,h:40,label:"前のページ"},nextPage:{x:690,y:500,w:100,h:40,label:"次のページ"}},Ke={canvas:null,ctx:null,achievements:[],scroll:0,itemsPerPage:8,_clickHandler:null,_keyHandler:null,async enter(t){this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),await this.loadAchievements(),this.scroll=0,this._clickHandler=e=>{const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;if(C(i,n,W.back)){u("playSE","decide"),u("changeScreen","menu");return}if(C(i,n,W.prevPage)){this.scroll=Math.max(0,this.scroll-this.itemsPerPage),u("playSE","decide");return}if(C(i,n,W.nextPage)){const a=Math.max(0,this.achievements.length-this.itemsPerPage);this.scroll=Math.min(a,this.scroll+this.itemsPerPage),u("playSE","decide");return}},this.canvas.addEventListener("click",this._clickHandler),this._keyHandler=e=>{if(e.key==="ArrowUp")this.scroll=Math.max(0,this.scroll-this.itemsPerPage);else if(e.key==="ArrowDown"){const s=Math.max(0,this.achievements.length-this.itemsPerPage);this.scroll=Math.min(s,this.scroll+this.itemsPerPage)}},window.addEventListener("keydown",this._keyHandler)},async loadAchievements(){try{const t=await fetch("/src/data/achievements.json");if(!t.ok)throw new Error(`実績データの読み込みに失敗: ${t.statusText}`);this.achievements=await t.json(),console.log(`📋 実績データを読み込みました: ${this.achievements.length}件`)}catch(t){console.error("❌ 実績データの読み込みエラー:",t),this.achievements=[]}},update(t){const{ctx:e,canvas:s}=this;e.fillStyle="#1a1a2e",e.fillRect(0,0,s.width,s.height),G(e,W.back.x,W.back.y,W.back.w,W.back.h,W.back.label),this.achievements.length>this.itemsPerPage&&(G(e,W.prevPage.x,W.prevPage.y,W.prevPage.w,W.prevPage.h,W.prevPage.label),G(e,W.nextPage.x,W.nextPage.y,W.nextPage.w,W.nextPage.h,W.nextPage.label)),e.fillStyle="white",e.font='28px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillText("実績一覧",s.width/2,70);const i=r.unlockedAchievements.size,n=this.achievements.length,a=n>0?Math.round(i/n*100):0;if(e.font='18px "UDデジタル教科書体", sans-serif',e.textAlign="right",e.fillStyle="#FFD700",e.fillText(`🏆 ${i}/${n} (${a}%)`,s.width-20,40),this.drawAchievementsList(),this.achievements.length>this.itemsPerPage){const l=Math.floor(this.scroll/this.itemsPerPage)+1,o=Math.ceil(this.achievements.length/this.itemsPerPage);e.fillStyle="white",e.font='16px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.fillText(`${l} / ${o}`,s.width/2,525)}},drawAchievementsList(){const{ctx:t}=this,e=110,s=45,i=680,n=40;t.textAlign="left",t.textBaseline="middle";for(let a=0;a<this.itemsPerPage;a++){const l=this.scroll+a;if(l>=this.achievements.length)break;const o=this.achievements[l],c=e+a*s,h=Be(o.id);if(h){const f=t.createLinearGradient(50,c-n/2,50+i,c+n/2);f.addColorStop(0,"rgba(255, 215, 0, 0.1)"),f.addColorStop(.5,"rgba(255, 215, 0, 0.2)"),f.addColorStop(1,"rgba(255, 215, 0, 0.1)"),t.fillStyle=f}else t.fillStyle="rgba(100, 100, 100, 0.1)";t.fillRect(50,c-n/2,i,n),t.strokeStyle=h?"#FFD700":"#555",t.lineWidth=1,t.strokeRect(50,c-n/2,i,n),h?this.drawUnlockedAchievement(o,c):this.drawLockedAchievement(o,c)}},drawUnlockedAchievement(t,e){const{ctx:s}=this;s.fillStyle="#FFD700",s.font="24px serif",s.fillText("🏆",60,e),s.fillStyle="#FFD700",s.font='bold 18px "UDデジタル教科書体", sans-serif',s.fillText(t.title,95,e-8),s.fillStyle="white",s.font='14px "UDデジタル教科書体", sans-serif',s.fillText(t.description,95,e+12),s.fillStyle="#00FF00",s.font='12px "UDデジタル教科書体", sans-serif',s.textAlign="right",s.fillText("✓ 解除済み",720,e),s.textAlign="left"},drawLockedAchievement(t,e){const{ctx:s}=this;s.fillStyle="#666",s.font="24px serif",s.fillText("🔒",60,e),s.fillStyle="#666",s.font='18px "UDデジタル教科書体", sans-serif',s.fillText("？？？",95,e-8),s.fillStyle="#555",s.font='14px "UDデジタル教科書体", sans-serif',s.fillText("未解除の実績です",95,e+12),this.shouldShowHint(t)&&(s.fillStyle="#888",s.font='12px "UDデジタル教科書体", sans-serif',s.textAlign="right",s.fillText(this.getConditionHint(t),720,e),s.textAlign="left")},shouldShowHint(t){const{condition:e}=t,s=r.playerStats;switch(e.type){case"enemiesDefeated":return s.enemiesDefeated>0;case"levelReached":return s.level>1;case"stagesCleared":return s.stagesCleared>0;default:return!1}},getConditionHint(t){var i,n;const{condition:e}=t,s=r.playerStats;switch(e.type){case"enemiesDefeated":return`敵撃破 ${s.enemiesDefeated}/${e.value}`;case"levelReached":return`レベル ${s.level}/${e.value}`;case"stagesCleared":return`ステージ ${s.stagesCleared}/${e.value}`;case"kanjiCollected":return`漢字 ${((i=r.kanjiDex)==null?void 0:i.size)||0}/${e.value}`;case"monstersCollected":return`モンスター ${((n=r.monsterDex)==null?void 0:n.size)||0}/${e.value}`;default:return"条件を満たすと解除"}},exit(){this.canvas&&this._clickHandler&&this.canvas.removeEventListener("click",this._clickHandler),this._keyHandler&&window.removeEventListener("keydown",this._keyHandler),this.canvas=this.ctx=null,this.achievements=[]}};Ke.render=function(){this.update(0)};const ei={enter(t){this.canvas=t||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const e=this.canvas.width/2;if(this.confirmButton={x:e-100,y:400,width:200,height:50,text:"けってい"},this.nameInputElement=document.getElementById("playerNameInputField"),this.nameInputElement){this.nameInputElement.style.display="block",this.nameInputElement.value="",this.nameInputElement.maxLength=10;const s=this.canvas.getBoundingClientRect();this.nameInputElement.style.left=`${s.left+e-this.nameInputElement.offsetWidth/2}px`,this.nameInputElement.style.top=`${s.top+300}px`,this.nameInputElement.focus()}this.registerHandlers()},update(t){const e=this.canvas.width,s=this.canvas.height,i=this.ctx;i.clearRect(0,0,e,s),i.fillStyle="#1e3c72",i.fillRect(0,0,e,s),i.fillStyle="white",i.font='32px "UDデジタル教科書体",sans-serif',i.textAlign="center",i.fillText("なまえを にゅうりょく してください",e/2,150),i.font='20px "UDデジタル教科書体",sans-serif',i.fillText("(10もじまで)",e/2,200),i.strokeStyle="white",i.lineWidth=2,i.strokeRect(e/2-150,280,300,40),S.buttonNormal&&i.drawImage(S.buttonNormal,this.confirmButton.x,this.confirmButton.y,this.confirmButton.width,this.confirmButton.height),G(i,this.confirmButton.x,this.confirmButton.y,this.confirmButton.width,this.confirmButton.height,this.confirmButton.text)},exit(){this.unregisterHandlers(),this.nameInputElement&&(this.nameInputElement.style.display="none",this.nameInputElement.onkeydown=null),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this._keyHandler=this.handleKeydown.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.nameInputElement&&(this.nameInputElement.onkeydown=this._keyHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},handleKeydown(t){t.key==="Enter"&&(this.submitNameAndSave(),t.preventDefault())},handleClick(t){t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a;C(l,o,this.confirmButton)&&(u("playSE","decide"),this.submitNameAndSave())},async submitNameAndSave(){if(!this.nameInputElement)return;const t=this.nameInputElement.value.trim();if(t===""||t==="ななしのごんべえ"||t==="ゲスト"||t==="新規プレイヤー"){alert("有効な なまえを いれてください。"),this.nameInputElement.value="",this.nameInputElement.focus();return}Pe(t);const e=Vt();if(e&&e.uid)try{const s=await pe(e.uid,t);s&&console.log("New player profile created/updated in Firestore:",s)}catch(s){console.error("Firebase保存エラー:",s)}r.pendingGameMode&&(r.gameMode=r.pendingGameMode,r.pendingGameMode=null),r.currentGrade=0,u("changeScreen","regionSelect")},render(){this.update(0)}},si={canvas:null,ctx:null,progress:0,stageId:null,async enter(t){try{if(console.log("🔄 stageLoadingState.enter() 実行",{canvas:t,stageId:r.currentStageId}),this.canvas=t||document.getElementById("gameCanvas"),this.canvas||(console.error("キャンバス要素が見つかりません。DOMから取得を試みます。"),this.canvas=document.getElementById("gameCanvas")),!this.canvas)throw new Error("キャンバス要素が見つかりません");if(this.ctx=this.canvas.getContext("2d"),this.progress=0,this.stageId=r.currentStageId,!this.stageId){console.error("ステージIDが未設定のため、ローディングを中止します。"),u("changeScreen","stageSelect");return}const e=me(this.stageId),s=[fs(this.stageId)];e.forEach(o=>{s.push(us(o))});const i=s.length;let n=0;const a=()=>{n++,this.progress=n/i,this.update(0)},l=s.map(o=>o.then(c=>(a(),c)));await Promise.all(l),console.log(`ステージ[${this.stageId}]のアセット読み込み完了。バトル画面へ遷移します。`),u("changeScreen",this.stageId,this.canvas)}catch(e){console.error(`[${this.stageId}]のアセット読み込み中にエラー:`,e),alert("ステージの準備に失敗しました。ステージ選択に戻ります。"),u("changeScreen","stageSelect")}},update(t){const{ctx:e,canvas:s}=this;if(!e)return;e.clearRect(0,0,s.width,s.height),e.fillStyle="black",e.fillRect(0,0,s.width,s.height);const i=600,n=30,a=(s.width-i)/2,l=(s.height-n)/2;e.fillStyle="#555",e.fillRect(a,l,i,n),e.fillStyle="#4caf50",e.fillRect(a,l,i*this.progress,n),e.strokeStyle="#fff",e.strokeRect(a,l,i,n),e.fillStyle="#fff",e.font='16px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="top",e.fillText(`${Math.floor(this.progress*100)}%`,s.width/2,l+n+8),e.fillText("ステージ準備中...",s.width/2,l-20)},exit(){console.log("🚪 stageLoadingState.exit() 実行"),this.ctx=null,this.canvas=null}},ii={enter(t){this.canvas=t||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d");const e=this.canvas.width,s=this.canvas.height;this.japanButton={x:50,y:150,width:e/2-75,height:s-250},this.worldButton={x:e/2+25,y:150,width:e/2-75,height:s-250},this.registerHandlers()},update(t){const e=this.canvas.width,s=this.canvas.height,i=this.ctx;i.clearRect(0,0,e,s);const n=i.createLinearGradient(0,0,0,s);n.addColorStop(0,"#2c3e50"),n.addColorStop(.5,"#34495e"),n.addColorStop(1,"#2c3e50"),i.fillStyle=n,i.fillRect(0,0,e,s),i.fillStyle="#f1c40f",i.font='bold 32px "UDデジタル教科書体", sans-serif',i.textAlign="center",i.textBaseline="top",i.fillText("学習コース選択",e/2,50),this._drawCourseArea(i,this.japanButton,"小学生の漢字（日本編）",S.japanMap||null),this._drawCourseArea(i,this.worldButton,"中学生の漢字（世界編）",S.worldMap||this._createWorldMapPlaceholder()),i.fillStyle="#7f8c8d",i.font='16px "UDデジタル教科書体", sans-serif',i.textAlign="center",i.textBaseline="bottom",i.fillText("※ 画面をタップして選択してください",e/2,s-30)},_drawCourseArea(t,e,s,i){if(t.fillStyle="rgba(255, 255, 255, 0.1)",t.fillRect(e.x,e.y,e.width,e.height),t.strokeStyle="#f39c12",t.lineWidth=3,t.strokeRect(e.x,e.y,e.width,e.height),t.fillStyle="#ecf0f1",t.font='bold 24px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="top",t.fillText(s,e.x+e.width/2,e.y+20),i){const n=Math.min(e.width-40,i.width),a=Math.min(e.height-100,i.height),l=e.x+(e.width-n)/2,o=e.y+70;t.drawImage(i,l,o,n,a)}else t.fillStyle="#95a5a6",t.fillRect(e.x+50,e.y+70,e.width-100,e.height-140),t.fillStyle="#ecf0f1",t.font='20px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("画像準備中",e.x+e.width/2,e.y+e.height/2)},_createWorldMapPlaceholder(){if(this._worldMapPlaceholder)return this._worldMapPlaceholder;const t=document.createElement("canvas");t.width=300,t.height=200;const e=t.getContext("2d");e.fillStyle="#3498db",e.fillRect(0,0,t.width,t.height),e.fillStyle="#27ae60",e.beginPath(),e.ellipse(80,70,40,30,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(100,140,25,40,Math.PI/6,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(200,70,80,40,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(170,120,30,50,Math.PI/12,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(250,150,25,20,0,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=1;for(let i=20;i<t.height;i+=40)e.beginPath(),e.moveTo(0,i),e.lineTo(t.width,i),e.stroke();for(let i=20;i<t.width;i+=40)e.beginPath(),e.moveTo(i,0),e.lineTo(i,t.height),e.stroke();const s=new Image;return s.src=t.toDataURL(),this._worldMapPlaceholder=s,s},exit(){this.unregisterHandlers(),this.canvas=null,this.ctx=null},registerHandlers(){this._clickHandler=this.handleClick.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler)},unregisterHandlers(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler)},handleClick(t){t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a;if(C(l,o,this.japanButton)){u("playSE","decide"),u("changeScreen","regionSelect");return}if(C(l,o,this.worldButton)){u("playSE","decide"),u("changeScreen","continentSelect");return}},render(){this.update(0)}},he=[{name:"アジア・オセアニア",kanken_level:5,x:650,y:350,color:"#4A90E2"},{name:"ヨーロッパ・中東",kanken_level:4,x:450,y:200,color:"#7ED321"},{name:"アフリカ",kanken_level:2,x:450,y:350,color:"#F5A623"},{name:"アメリカ大陸",kanken_level:3,x:250,y:250,color:"#BD10E0"},{name:"世界の名作",kanken_level:1,x:350,y:300,color:"#50E3C2"}],mt={x:10,y:540,width:120,height:40,text:"戻る"},ni={canvas:null,ctx:null,animationTime:0,hoveredMarker:null,isZooming:!1,zoomProgress:0,zoomTarget:null,zoomStartTime:0,zoomDuration:800,camera:{x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},enter(t){this.canvas=t||document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.animationTime=0,this.hoveredMarker=null,this.isZooming=!1,this.zoomProgress=0,this.zoomTarget=null,this.camera={x:0,y:0,scale:1,targetX:0,targetY:0,targetScale:1},this._clickHandler=this.handleClick.bind(this),this._mouseMoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mouseMoveHandler)},startZoomAnimation(t){this.isZooming=!0,this.zoomProgress=0,this.zoomTarget=t,this.zoomStartTime=this.animationTime;const e=this.canvas.width/2,s=this.canvas.height/2;let i=2.2;t.name==="アジア・オセアニア"?i=2:t.name==="アメリカ大陸"&&(i=2.5),this.camera.targetX=e-t.x*i,this.camera.targetY=s-t.y*i,this.camera.targetScale=i,u("playSE","decide")},updateZoomAnimation(t){if(!this.isZooming)return;const e=this.animationTime-this.zoomStartTime;this.zoomProgress=Math.min(e/this.zoomDuration,1);const s=this.zoomProgress<.5?4*this.zoomProgress*this.zoomProgress*this.zoomProgress:1-Math.pow(-2*this.zoomProgress+2,3)/2,i=.15;this.camera.x=this.camera.x+(this.camera.targetX-this.camera.x)*s*i,this.camera.y=this.camera.y+(this.camera.targetY-this.camera.y)*s*i,this.camera.scale=this.camera.scale+(this.camera.targetScale-this.camera.scale)*s*i,this.zoomProgress>=1&&(this.camera.x=this.camera.targetX,this.camera.y=this.camera.targetY,this.camera.scale=this.camera.targetScale,this.isZooming=!1,setTimeout(()=>{u("changeScreen","worldStageSelect",{continent:this.zoomTarget.name,kanken_level:this.zoomTarget.kanken_level})},200))},update(t){this.animationTime+=t,this.updateZoomAnimation(t),this.ctx.save(),this.ctx.translate(this.camera.x,this.camera.y),this.ctx.scale(this.camera.scale,this.camera.scale),this.ctx.fillStyle="#1E3A8A",this.ctx.fillRect(-this.camera.x/this.camera.scale,-this.camera.y/this.camera.scale,this.canvas.width/this.camera.scale,this.canvas.height/this.camera.scale),this.drawWorldMap(),this.drawTitle(),this.drawContinentMarkers(),this.ctx.restore(),this.isZooming||G(this.ctx,mt.x,mt.y,mt.width,mt.height,mt.text),this.hoveredMarker&&!this.isZooming&&this.drawMarkerTooltip(this.hoveredMarker)},drawWorldMap(){const t=S.worldMap;if(t){const i=this.canvas.width-100,n=this.canvas.height-200;this.ctx.drawImage(t,50,100,i,n),this.ctx.save(),this.ctx.globalAlpha=.3,this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(55,105,i,n),this.ctx.restore()}else console.warn("世界地図画像が見つかりません。シンプルな代替地図を表示します。"),this.drawFallbackWorldMap()},drawFallbackWorldMap(){const s=this.canvas.width-100,i=this.canvas.height-200;this.ctx.fillStyle="#4682B4",this.ctx.fillRect(50,100,s,i),this.ctx.fillStyle="#228B22",this.ctx.strokeStyle="#006400",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.ellipse(50+s*.7,100+i*.4,s*.25,i*.2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.5,100+i*.3,s*.1,i*.15,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.5,100+i*.6,s*.15,i*.2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.25,100+i*.3,s*.15,i*.2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.ellipse(50+s*.3,100+i*.7,s*.1,i*.15,0,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="#2F4F4F",this.ctx.lineWidth=3,this.ctx.strokeRect(50,100,s,i)},drawTitle(){const t=this.canvas.width/2;if(S.woodenSign)this.ctx.drawImage(S.woodenSign,t-200,10,400,80);else{this.ctx.fillStyle="#8B4513",this.ctx.fillRect(t-200,20,400,60),this.ctx.strokeStyle="#654321",this.ctx.lineWidth=2;for(let e=0;e<5;e++)this.ctx.beginPath(),this.ctx.moveTo(t-190,30+e*10),this.ctx.lineTo(t+190,30+e*10),this.ctx.stroke();this.ctx.strokeStyle="#4A4A4A",this.ctx.lineWidth=3,this.ctx.strokeRect(t-200,20,400,60)}this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font="bold 28px serif",this.ctx.strokeText("挑戦する大陸を選ぼう",t,55),this.ctx.fillText("挑戦する大陸を選ぼう",t,55)},drawContinentMarkers(){he.forEach(t=>{const e=this.hoveredMarker===t;let i=1+Math.sin(this.animationTime*.003)*.1;e&&(i=1.4+Math.sin(this.animationTime*.01)*.1);const n=e?5:3;if(this.ctx.fillStyle=`rgba(0, 0, 0, ${e?.4:.3})`,this.ctx.beginPath(),this.ctx.ellipse(t.x+n,t.y+n,25*i,25*i,0,0,2*Math.PI),this.ctx.fill(),e){const l=40*i,o=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,l);o.addColorStop(0,`${t.color}40`),o.addColorStop(.7,`${t.color}20`),o.addColorStop(1,"transparent"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,l,l,0,0,2*Math.PI),this.ctx.fill()}this.ctx.fillStyle=e?this.lightenColor(t.color,30):t.color,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,25*i,25*i,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,18*i,18*i,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=e?this.lightenColor(t.color,30):t.color,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,8*i,8*i,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#FFFFFF",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2,this.ctx.textAlign="center",this.ctx.font=`bold ${16*i}px sans-serif`;const a=typeof t.kanken_level=="number"?`${t.kanken_level}級`:`${t.kanken_level}`;if(this.ctx.strokeText(a,t.x,t.y+5),this.ctx.fillText(a,t.x,t.y+5),e){this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.ellipse(t.x,t.y,35*i,35*i,0,0,2*Math.PI),this.ctx.stroke();for(let l=0;l<12;l++){const o=(this.animationTime*.003+l*Math.PI/6)%(2*Math.PI),c=45+Math.sin(this.animationTime*.005+l)*5,h=t.x+Math.cos(o)*c,f=t.y+Math.sin(o)*c,g=.5+.5*Math.sin(this.animationTime*.008+l);this.ctx.fillStyle=`rgba(255, 215, 0, ${g})`,this.ctx.beginPath(),this.ctx.ellipse(h,f,4,4,0,0,2*Math.PI),this.ctx.fill()}}})},lightenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)+i,a=(s>>8&255)+i,l=(s&255)+i;return"#"+(16777216+(n<255?n<1?0:n:255)*65536+(a<255?a<1?0:a:255)*256+(l<255?l<1?0:l:255)).toString(16).slice(1)},drawMarkerTooltip(t){const e=t.x*this.camera.scale+this.camera.x,s=t.y*this.camera.scale+this.camera.y,i=e+40,n=s-50,a=200,l=90,o=this.ctx.createLinearGradient(i,n,i,n+l);o.addColorStop(0,"rgba(0, 0, 0, 0.95)"),o.addColorStop(1,"rgba(20, 20, 20, 0.95)"),this.ctx.fillStyle=o,this.ctx.fillRect(i,n,a,l),this.ctx.strokeStyle="#FFD700",this.ctx.lineWidth=2,this.ctx.strokeRect(i,n,a,l),this.ctx.strokeStyle="rgba(255, 215, 0, 0.5)",this.ctx.lineWidth=1,this.ctx.strokeRect(i+2,n+2,a-4,l-4),this.ctx.fillStyle="#FFFFFF",this.ctx.textAlign="left",this.ctx.font="bold 16px sans-serif",this.ctx.fillText(`${t.name}`,i+10,n+25),this.ctx.font="14px sans-serif",this.ctx.fillStyle="#FFD700";const c=typeof t.kanken_level=="number"?`漢検 ${t.kanken_level}級 相当`:`漢検 ${t.kanken_level} 相当`;this.ctx.fillText(c,i+10,n+50),this.ctx.fillStyle="#CCCCCC",this.ctx.font="12px sans-serif",this.ctx.fillText("クリックして挑戦する",i+10,n+70)},handleMouseMove(t){if(this.isZooming)return;const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,n=(t.clientX-e.left)*s,a=(t.clientY-e.top)*i,l=(n-this.camera.x)/this.camera.scale,o=(a-this.camera.y)/this.camera.scale,c=this.hoveredMarker;this.hoveredMarker=null;for(const h of he)if(Math.sqrt((l-h.x)**2+(o-h.y)**2)<=35){this.hoveredMarker=h,this.canvas.style.cursor="pointer",c!==h&&u("playSE","hover");break}this.hoveredMarker||(this.canvas.style.cursor="default")},exit(){this.canvas.removeEventListener("click",this._clickHandler),this.canvas.removeEventListener("touchstart",this._clickHandler),this.canvas.removeEventListener("mousemove",this._mouseMoveHandler),this.canvas.style.cursor="default"},handleClick(t){if(this.isZooming)return;t.preventDefault();let e,s;t.changedTouches?(e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY):(e=t.clientX,s=t.clientY);const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,l=(e-i.left)*n,o=(s-i.top)*a,c=(l-this.camera.x)/this.camera.scale,h=(o-this.camera.y)/this.camera.scale;for(const f of he)if(Math.sqrt((c-f.x)**2+(h-f.y)**2)<=35){this.startZoomAnimation(f);return}if(C(l,o,mt)){u("playSE","decide"),u("changeScreen","courseSelect");return}},render(){this.update(0)}},ai=()=>{let t=document.getElementById("uiOverlay");return t||(t=document.createElement("div"),t.id="uiOverlay",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.pointerEvents="none",document.body.appendChild(t)),t},Y={width:160,height:40,gap:20,y:540},ze=Y.width*3+Y.gap*2,Jt=(800-ze)/2,pt={x:Jt,y:Y.y,width:Y.width,height:Y.height,text:"もどる"},yt={x:Jt+(Y.width+Y.gap)*1,y:Y.y,width:Y.width,height:Y.height,text:"漢字図鑑"},St={x:Jt+(Y.width+Y.gap)*2,y:Y.y,width:Y.width,height:Y.height,text:"モンスター"},de=32,Me=[{label:"4級",kanken_level:4},{label:"3級",kanken_level:3},{label:"準2級",kanken_level:"準2"},{label:"2級",kanken_level:2}],li={canvas:null,ctx:null,stages:[],stageButtons:[],_clickHandler:null,_mousemoveHandler:null,mouseX:0,mouseY:0,hoveredStage:null,animationTime:0,selectedTabLevel:4,continentInfo:null,enter(t){u("playBGM","title"),this.canvas=t&&typeof t.getContext=="function"?t:document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.continentInfo=(t==null?void 0:t.props)||{},this.continentInfo.kanken_level&&(this.selectedTabLevel=this.continentInfo.kanken_level),this.updateStageList(),this._clickHandler=this.handleClick.bind(this),this._mousemoveHandler=this.handleMouseMove.bind(this),this.canvas.addEventListener("click",this._clickHandler),this.canvas.addEventListener("touchstart",this._clickHandler),this.canvas.addEventListener("mousemove",this._mousemoveHandler),ai()},updateStageList(){this.stages=X.filter(o=>o.grade==="J"&&o.continent===this.continentInfo.continent&&o.kanken_level===this.selectedTabLevel);const t=this.stages.length,e=80,s=this.canvas.width/2;let i,n,a;t>7?(i=40,n=8,a=16):(i=50,n=15,a=20);const l=s-60;this.stageButtons=this.stages.map((o,c)=>({id:o.stageId,text:o.name,x:30,y:e+c*(i+n),width:l,height:i,fontSize:a,stage:o}))},isStageCleared(t){var i;const e=localStorage.getItem(`clear_${t}`),s=r.stageProgress&&((i=r.stageProgress[t])==null?void 0:i.cleared);return e||s},getNextStage(){for(const t of this.stages)if(!this.isStageCleared(t.stageId))return t;return null},handleMouseMove(t){const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height;if(this.mouseX=(t.clientX-e.left)*s,this.mouseY=(t.clientY-e.top)*i,this.hoveredStage=null,this.stageButtons){for(const n of this.stageButtons)if(C(this.mouseX,this.mouseY,n)){this.hoveredStage=n.stage;return}}for(const n of this.stages)if(n.pos){const{x:a,y:l}=n.pos;if(this.mouseX>=a&&this.mouseX<=a+de&&this.mouseY>=l&&this.mouseY<=l+de){this.hoveredStage=n;return}}},drawTooltip(t){if(!t)return;const e=this.ctx,s=this.mouseX+20,i=this.mouseY-80,n=200,a=100;e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(s,i,n,a),e.strokeStyle="#fff",e.lineWidth=2,e.strokeRect(s,i,n,a),e.fillStyle="#fff",e.font="14px sans-serif",e.textAlign="left",e.textBaseline="top";let l=10;e.fillText(`ステージ: ${t.name}`,s+10,i+l),l+=20,t.recommendedLevel&&(e.fillText(`推奨Lv: ${t.recommendedLevel}`,s+10,i+l),l+=20);const o=typeof t.kanken_level=="number"?`漢検 ${t.kanken_level}級 相当`:`漢検 ${t.kanken_level} 相当`;e.fillText(o,s+10,i+l),l+=20;const c=this.isStageCleared(t.stageId);e.fillStyle=c?"#4CAF50":"#FFC107",e.fillText(c?"クリア済み":"未クリア",s+10,i+l)},drawRichButton(t,e,s,i,n,a,l="#2980b9",o=!1){t.save();const c=o?1.05:1,h=o?this.lightenColor(l,15):l;if(o){const k=e+i/2,b=s+n/2,E=i*c,w=n*c;e=k-E/2,s=b-w/2,i=E,n=w}const f=o?4:3,g=o?.4:.3;t.fillStyle=`rgba(0, 0, 0, ${g})`,t.fillRect(e+f,s+f,i,n);const m=t.createLinearGradient(e,s,e,s+n);m.addColorStop(0,this.lightenColor(h,20)),m.addColorStop(1,this.darkenColor(h,20)),t.fillStyle=m,t.fillRect(e,s,i,n),t.strokeStyle=this.darkenColor(h,30),t.lineWidth=o?3:2,t.strokeRect(e,s,i,n);const y=t.createLinearGradient(e,s,e,s+n*.3),p=o?.4:.3;y.addColorStop(0,`rgba(255, 255, 255, ${p})`),y.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=y,t.fillRect(e,s,i,n*.3),o&&(t.strokeStyle="rgba(255, 255, 255, 0.6)",t.lineWidth=1,t.strokeRect(e+1,s+1,i-2,n-2)),t.fillStyle="white",t.font='18px "UDデジタル教科書体", sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(a,e+i/2,s+n/2),t.restore()},drawPanelBackground(t,e,s,i,n,a="default"){t.save();let l="rgba(0, 0, 0, 0.7)";if(a==="stone"?l="rgba(50, 50, 60, 0.8)":a==="paper"&&(l="rgba(245, 235, 215, 0.9)"),t.fillStyle=l,t.fillRect(e,s,i,n),t.strokeStyle="rgba(255, 255, 255, 0.5)",t.lineWidth=2,t.strokeRect(e,s,i,n),a==="stone"){t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=1;for(let o=1;o<3;o++)t.beginPath(),t.moveTo(e,s+n*o/3),t.lineTo(e+i,s+n*o/3),t.stroke()}t.restore()},lightenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)+i,a=(s>>8&255)+i,l=(s&255)+i;return"#"+(16777216+(n<255?n<1?0:n:255)*65536+(a<255?a<1?0:a:255)*256+(l<255?l<1?0:l:255)).toString(16).slice(1)},darkenColor(t,e){const s=parseInt(t.replace("#",""),16),i=Math.round(2.55*e),n=(s>>16)-i,a=(s>>8&255)-i,l=(s&255)-i;return"#"+(16777216+(n>255?255:n<0?0:n)*65536+(a>255?255:a<0?0:a)*256+(l>255?255:l<0?0:l)).toString(16).slice(1)},update(t){const{ctx:e,canvas:s,stages:i}=this,n=s.width,a=s.height;e.clearRect(0,0,n,a),this.animationTime+=t||16;const l=e.createLinearGradient(0,0,0,a);l.addColorStop(0,"#1a365d"),l.addColorStop(1,"#2c5282"),e.fillStyle=l,e.fillRect(0,0,n,a);const o=n/2,c=60,h=n/2,f=a-120;let g=null;this.continentInfo.continent==="アジア・オセアニア"?g=S.asiaMap||S.worldMap:this.continentInfo.continent==="ヨーロッパ・中東"?g=S.europeMap||S.worldMap:this.continentInfo.continent==="アフリカ"?g=S.africaMap||S.worldMap:this.continentInfo.continent==="アメリカ大陸"?g=S.americaMap||S.worldMap:g=S.worldMap,g?e.drawImage(g,o,c,h,f):this.drawFallbackContinentMap(o,c,h,f);const m=10,y=60,p=n/2-20,k=a-140;this.drawPanelBackground(e,m,y,p,k,"stone");const b=Me.length,E=n/b,w=50;e.textAlign="center",e.textBaseline="middle",e.font="16px sans-serif",Me.forEach((P,T)=>{const A=T*E,I=P.kanken_level===this.selectedTabLevel;e.fillStyle=I?"#3182ce":"#4a5568",e.fillRect(A,0,E,w),e.fillStyle="#fff",e.fillText(P.label,A+E/2,w/2)}),e.fillStyle="white",e.font='24px "UDデジタル教科書体", sans-serif',e.textAlign="center",e.textBaseline="top";const B=typeof this.selectedTabLevel=="number"?`漢検${this.selectedTabLevel}級`:`漢検${this.selectedTabLevel}`;if(e.fillText(`${this.continentInfo.continent} (${B})`,m+p/2,y+10),this.stageButtons&&this.stageButtons.length>0){const P=this.getNextStage();this.stageButtons.forEach(T=>{const A=T.stage,I=this.isStageCleared(A.stageId),R=P&&P.stageId===A.stageId,L=this.hoveredStage&&this.hoveredStage.stageId===A.stageId;let q="#2980b9";I?q="#27ae60":R&&(q="#e74c3c"),this.drawRichButton(e,T.x,T.y,T.width,T.height,T.text,q,L),e.textAlign="left",e.textBaseline="top",e.font="12px sans-serif",I&&(e.fillStyle="#FFD700",e.font="16px sans-serif",e.fillText("⭐",T.x+T.width-25,T.y+5)),A.recommendedLevel&&(e.fillStyle="#fff",e.font="10px sans-serif",e.fillText(`推奨Lv.${A.recommendedLevel}`,T.x+5,T.y+T.height-15)),R&&(e.fillStyle="#FFD700",e.font="10px sans-serif",e.fillText("NEXT!",T.x+T.width-50,T.y+T.height-15))})}else e.fillStyle="#ccc",e.font="16px sans-serif",e.textAlign="center",e.fillText("この大陸・級のステージはまだありません",m+p/2,y+100);i.forEach(P=>{if(P.pos){const{x:T,y:A}=P.pos,I=this.isStageCleared(P.stageId),R=this.hoveredStage&&this.hoveredStage.stageId===P.stageId;if(e.save(),R){const L=Math.sin(this.animationTime*.005)*.2+1.2;e.shadowColor="#FFD700",e.shadowBlur=15,e.globalAlpha=.9,e.scale(L,L),e.translate(T*(1-L)+T,A*(1-L)+A)}e.fillStyle=I?"#27ae60":"#e74c3c",e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.arc(T,A,de/2,0,Math.PI*2),e.fill(),e.stroke(),R&&(e.fillStyle="#fff",e.font="12px sans-serif",e.textAlign="center",e.fillText(P.name,T,A-20)),e.restore()}}),this._drawFooterBar(e,n,a),this.drawTooltip(this.hoveredStage)},drawFallbackContinentMap(t,e,s,i){const n=this.ctx;n.fillStyle="#4682B4",n.fillRect(t,e,s,i),n.fillStyle="#228B22",n.strokeStyle="#006400",n.lineWidth=2,this.continentInfo.continent==="アジア・オセアニア"?(n.beginPath(),n.ellipse(t+s*.5,e+i*.4,s*.4,i*.3,0,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.ellipse(t+s*.6,e+i*.7,s*.15,i*.1,0,0,Math.PI*2),n.fill(),n.stroke()):this.continentInfo.continent==="ヨーロッパ・中東"?(n.beginPath(),n.ellipse(t+s*.4,e+i*.3,s*.3,i*.2,0,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.ellipse(t+s*.6,e+i*.5,s*.2,i*.15,0,0,Math.PI*2),n.fill(),n.stroke()):this.continentInfo.continent==="アフリカ"?(n.beginPath(),n.ellipse(t+s*.5,e+i*.5,s*.3,i*.4,0,0,Math.PI*2),n.fill(),n.stroke()):this.continentInfo.continent==="アメリカ大陸"&&(n.beginPath(),n.ellipse(t+s*.4,e+i*.3,s*.25,i*.2,0,0,Math.PI*2),n.fill(),n.stroke(),n.beginPath(),n.ellipse(t+s*.5,e+i*.6,s*.2,i*.25,0,0,Math.PI*2),n.fill(),n.stroke())},_drawFooterBar(t,e,s){const i=Jt-10,n=Y.y-10,a=ze+20,l=Y.height+20;t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(i,n,a,l),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,t.strokeRect(i,n,a,l);const o=15,c=t.createLinearGradient(i,n,i,n+o);c.addColorStop(0,"rgba(255, 255, 255, 0.2)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),t.fillStyle=c,t.fillRect(i,n,a,o);const h=C(this.mouseX,this.mouseY,pt),f=C(this.mouseX,this.mouseY,yt),g=C(this.mouseX,this.mouseY,St);this.drawRichButton(t,pt.x,pt.y,pt.width,pt.height,pt.text,h?"#4A90E2":"#ccc",h),this.drawRichButton(t,yt.x,yt.y,yt.width,yt.height,yt.text,f?"#4A90E2":"#ccc",f),this.drawRichButton(t,St.x,St.y,St.width,St.height,St.text,g?"#4A90E2":"#ccc",g)}};async function oi(){const{stageData:t}=await ys(),e={title:Gs,playerNameInput:ei,menu:Os,status:ti,achievements:Ke,gradeSelect:Ns,regionSelect:Ws,prefSelect:Xs,stageSelect:Xe,settings:Us,reviewStage:Ye,kanjiDex:Ge,monsterDex:qs,resultWin:Ue,result:Qs,gameOver:Js,stageLoading:si,courseSelect:ii,continentSelect:ni,worldStageSelect:li};t.forEach(n=>{e[n.stageId]=js(n.stageId)});const s=new Es("title",e);function i(n,a){console.log(`画面遷移: ${n}`,a),s.change(n,a)}return Z("changeScreen",i),window.switchScreen=i,s}const ct=[],At=document.getElementById("gameCanvas");At.width=800;At.height=600;const ri=At.getContext("2d"),xt=new ge;document.body.addEventListener("pointerdown",()=>{u("playBGM","title")},{once:!0});let Ie=performance.now();function Ve(t){const e=t-Ie;Ie=t,r.playerStats.playtimeSeconds+=e/1e3,cs(e),hs(),ci(ri),requestAnimationFrame(Ve)}function ci(t){if(ct.length===0)return;const e=At.height-150,s=400,i=80,n=(At.width-s)/2;ct.forEach((a,l)=>{const o=e-l*(i+10);t.save(),t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=10,t.shadowOffsetX=0,t.shadowOffsetY=4;const c=t.createLinearGradient(n,o,n,o+i);c.addColorStop(0,"#FFD700"),c.addColorStop(1,"#FFA500"),t.fillStyle=c,t.fillRect(n,o,s,i),t.shadowColor="transparent",t.strokeStyle="#B8860B",t.lineWidth=3,t.strokeRect(n,o,s,i),t.fillStyle="rgba(255, 255, 255, 0.2)",t.fillRect(n+10,o+10,60,i-20),t.fillStyle="#000",t.textAlign="left",t.textBaseline="middle",t.font='bold 24px "UDデジタル教科書体", sans-serif',t.fillText("🏆",n+25,o+i/2-10),t.font='bold 18px "UDデジタル教科書体", sans-serif',t.fillText("実績解除！",n+80,o+25),t.font='16px "UDデジタル教科書体", sans-serif',t.fillStyle="#333";let h=a.title;h.length>20&&(h=h.substring(0,20)+"..."),t.fillText(h,n+80,o+50);const f=["✨","⭐","💫"];for(let g=0;g<3;g++){const m=n+s-60+g*20,y=o+20+Math.sin(Date.now()/500+g)*10;t.font="20px sans-serif",t.fillStyle="#FFF",t.fillText(f[g],m,y)}t.restore()})}(async function(){if(console.log("🔧 Init start"),await gs(),window.fsm=await oi(),!ks())return;const e=await xs();console.log("UID:",e==null?void 0:e.uid),await ws();try{await Ft(),console.log("✅ ゲーム起動時の実績チェック完了")}catch(s){console.error("❌ ゲーム起動時の実績チェックでエラー:",s)}if(!r.playerName||["ゲスト","ななしのごんべえ","新規プレイヤー"].includes(r.playerName)){const s=prompt("プレイヤー名を入力してください（10文字以内）","");if(s){const i=s.trim().slice(0,10);Pe(i),e&&e.uid&&await pe(e.uid,i)}}r.currentStageId="hokkaido_area1",Zt.initialize(),console.log("✅ Init done → Start loop"),requestAnimationFrame(Ve)})();Z("playSE",t=>xt.playSE(t));Z("playBGM",(t,e=!0)=>xt.playBGM(t,e));Z("setBGMVolume",t=>xt.setBGMVolume(t));Z("setSEVolume",t=>xt.setSEVolume(t));Z("getBGMVolume",t=>t(xt.getBGMVolume()));Z("getSEVolume",t=>t(xt.getSEVolume()));Z("achievementUnlocked",t=>{console.log(`🎉 実績解除通知: ${t.title}`),ct.push({title:t.title,description:t.description,timestamp:Date.now()}),setTimeout(()=>{const e=ct.findIndex(s=>s.timestamp===Date.now()-3500);e!==-1&&ct.splice(e,1),ct.length>0&&ct.shift()},3500)});Z("addToReview",t=>{ot.add(t)});
